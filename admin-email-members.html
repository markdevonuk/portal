<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Email All Members - FMS Prehospital Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; min-height:100vh; }
    .navbar { 
      background: linear-gradient(135deg, #00a896 0%, #028090 100%); 
      box-shadow:0 2px 10px rgba(0,0,0,0.1); 
    }
    .nav-link { 
      color: rgba(255,255,255,.85) !important;
      font-weight: 500;
    }
    .nav-link:hover { 
      color: #fff !important;
    }
    .admin-header { 
      background:linear-gradient(135deg,#00a896 0%,#028090 100%); 
      color:#fff; 
      border-radius:15px; 
      padding:40px; 
      margin:30px 0 20px 0; 
      box-shadow:0 10px 30px rgba(0,168,150,.3);
    }
    .admin-card {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,.08);
      padding: 30px;
      margin: 20px 0;
    }
    .unauthorized { text-align: center; padding: 60px 20px; }
    .hidden { display: none; }
    
    /* Email form styling */
    .email-textarea {
      min-height: 300px;
      font-family: inherit;
      resize: vertical;
    }
    .email-preview {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      white-space: pre-wrap;
      font-family: inherit;
      max-height: 400px;
      overflow-y: auto;
    }
    .member-count-badge {
      font-size: 1.2rem;
      padding: 10px 20px;
    }
    .warning-banner {
      background: linear-gradient(135deg, #fff3cd 0%, #ffe5a0 100%);
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 15px 20px;
    }
    
    /* Progress styling */
    .progress-container {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,.08);
      padding: 30px;
      margin: 20px 0;
    }
    .progress {
      height: 25px;
      border-radius: 10px;
    }
    .progress-bar {
      font-size: 0.9rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html"><i class="bi bi-shield-lock"></i> FMS Prehospital Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-house-fill"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="admin.html">
              <i class="bi bi-shield-lock"></i> Admin
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutLink">
              <i class="bi bi-box-arrow-right"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Unauthorized Message -->
    <div id="unauthorizedMsg" class="hidden">
      <div class="unauthorized">
        <i class="bi bi-exclamation-triangle-fill" style="font-size: 4rem; color: #ffc107;"></i>
        <h3 class="mt-4">Unauthorized Access</h3>
        <p class="text-muted">You do not have permission to access this page.</p>
        <a href="dashboard.html" class="btn btn-primary mt-3">
          <i class="bi bi-arrow-left"></i> Return to Dashboard
        </a>
      </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <div class="admin-header">
        <h1 class="mb-2"><i class="bi bi-envelope-paper-fill"></i> Email Members</h1>
        <p class="mb-0">Send a message to members</p>
      </div>

      <!-- Alert Container -->
      <div id="alertContainer"></div>

      <!-- Progress Container (hidden by default) -->
      <div id="progressContainer" class="progress-container hidden">
        <h5 class="mb-3"><i class="bi bi-send-check"></i> Sending Emails...</h5>
        <p class="text-muted mb-2">Please keep this page open. Emails are being sent with a delay to avoid rate limiting.</p>
        <div class="progress mb-3">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="progressBar" style="width: 0%">0%</div>
        </div>
        <p class="mb-0" id="progressText">Preparing to send...</p>
      </div>

      <!-- Recipient Selection -->
      <div class="admin-card" id="recipientCard">
        <h5 class="mb-3"><i class="bi bi-people-fill"></i> Select Recipients</h5>
        
        <div class="row align-items-center">
          <div class="col-md-6 mb-3 mb-md-0">
            <label for="recipientType" class="form-label">Who do you want to email?</label>
            <select class="form-select" id="recipientType">
              <option value="approved">Approved Members (with approved profiles)</option>
              <option value="registered">Registered Users (account created but no profile)</option>
              <option value="pending">Pending Registration (on allowed list but no account)</option>
              <option value="noEvents">Approved Members (not volunteered for any events)</option>
            </select>
          </div>
          <div class="col-md-6 text-md-end">
            <div id="memberCountContainer">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <span class="ms-2 text-muted">Loading...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Warning Banner -->
      <div class="warning-banner mb-4" id="warningBanner">
        <div class="d-flex align-items-start gap-3">
          <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 1.5rem;"></i>
          <div>
            <strong>Important:</strong> Please review your message carefully before sending. 
            A copy of the email with a list of recipients will be sent to <strong>prehospital@festival-medical.org</strong>.
            <br><small class="text-muted">Note: Emails are sent with a 1.5 second delay between each to avoid rate limiting.</small>
          </div>
        </div>
      </div>

      <!-- Pending Registration Info Banner (hidden by default) -->
      <div class="alert alert-info mb-4 hidden" id="pendingInfoBanner">
        <i class="bi bi-info-circle-fill"></i>
        <strong>Note:</strong> These recipients have not yet created an account, so we don't have their names. 
        Emails will use "Hello" as the greeting instead of their first name.
      </div>

      <!-- Email Form -->
      <div class="admin-card" id="emailFormCard">
        <h4 class="mb-4"><i class="bi bi-pencil-square"></i> Compose Email</h4>
        
        <form id="emailForm">
          <div class="mb-3">
            <label for="emailSubject" class="form-label fw-bold">Subject *</label>
            <input type="text" class="form-control" id="emailSubject" required 
                   placeholder="Enter email subject...">
          </div>
          
          <div class="mb-3">
            <label for="emailContent" class="form-label fw-bold">Message *</label>
            <p class="text-muted small mb-2" id="greetingHint">
              <i class="bi bi-info-circle"></i> The greeting "Dear [member first name]," will be added automatically. 
              Start with your message content.
            </p>
            <textarea class="form-control email-textarea" id="emailContent" required
                      placeholder="Enter your message here..."></textarea>
          </div>
          
          <div class="mb-4">
            <label class="form-label fw-bold">Email Signature (included automatically)</label>
            <div class="email-preview text-muted">Prehospital Team Leaders
prehospital@festival-medical.org</div>
          </div>

          <hr class="my-4">
          
          <!-- Preview Section -->
          <div class="mb-4">
            <h5><i class="bi bi-eye"></i> Preview</h5>
            <p class="text-muted small">This is how your email will appear to recipients:</p>
            <div class="email-preview" id="emailPreview">
              <em class="text-muted">Enter a subject and message to see preview...</em>
            </div>
          </div>

          <div class="d-flex gap-3 flex-wrap">
            <button type="submit" class="btn btn-primary btn-lg" id="sendEmailBtn" disabled>
              <i class="bi bi-send-fill"></i> Send Emails
            </button>
            <a href="admin.html" class="btn btn-outline-secondary btn-lg">
              <i class="bi bi-arrow-left"></i> Cancel
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="confirmModalLabel">
            <i class="bi bi-exclamation-triangle-fill"></i> Confirm Send
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>You are about to send an email to <strong id="confirmMemberCount">0</strong> <span id="confirmRecipientType">members</span>.</p>
          <p>Subject: <strong id="confirmSubject"></strong></p>
          <p class="text-muted small"><i class="bi bi-clock"></i> Estimated time: <span id="estimatedTime">0</span></p>
          <p class="mb-0">Are you sure you want to proceed?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirmSendBtn">
            <i class="bi bi-send-fill"></i> Yes, Send Emails
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="successModalLabel">
            <i class="bi bi-check-circle-fill"></i> Emails Sent Successfully
          </h5>
        </div>
        <div class="modal-body">
          <p><i class="bi bi-check-circle text-success"></i> <strong id="successCount">0</strong> emails have been queued for delivery.</p>
          <p><i class="bi bi-envelope-check text-success"></i> A summary email has been sent to prehospital@festival-medical.org</p>
          <p id="errorSummary" class="text-danger" style="display: none;"></p>
        </div>
        <div class="modal-footer">
          <a href="admin.html" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> Return to Admin
          </a>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, collection, getDocs, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Delay between emails in milliseconds (1.5 seconds)
    const EMAIL_DELAY_MS = 1500;

    // DOM Elements
    const mainContent = document.getElementById('mainContent');
    const unauthorizedMsg = document.getElementById('unauthorizedMsg');
    const memberCountContainer = document.getElementById('memberCountContainer');
    const recipientType = document.getElementById('recipientType');
    const emailForm = document.getElementById('emailForm');
    const emailSubject = document.getElementById('emailSubject');
    const emailContent = document.getElementById('emailContent');
    const emailPreview = document.getElementById('emailPreview');
    const sendEmailBtn = document.getElementById('sendEmailBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const recipientCard = document.getElementById('recipientCard');
    const warningBanner = document.getElementById('warningBanner');
    const emailFormCard = document.getElementById('emailFormCard');
    const pendingInfoBanner = document.getElementById('pendingInfoBanner');
    const greetingHint = document.getElementById('greetingHint');
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    const successModal = new bootstrap.Modal(document.getElementById('successModal'));

    // Store recipients
    let approvedMembers = [];
    let registeredUsers = [];
    let pendingRegistration = [];
    let approvedNoEvents = [];

    // Helper function to delay
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Show alert
    function showAlert(message, type) {
      const alertContainer = document.getElementById('alertContainer');
      const html = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      alertContainer.innerHTML = html;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Get current recipients based on dropdown selection
    function getCurrentRecipients() {
      if (recipientType.value === 'approved') {
        return approvedMembers;
      } else if (recipientType.value === 'registered') {
        return registeredUsers;
      } else if (recipientType.value === 'pending') {
        return pendingRegistration;
      } else if (recipientType.value === 'noEvents') {
        return approvedNoEvents;
      }
      return [];
    }

    // Get label for recipient type
    function getRecipientLabel() {
      if (recipientType.value === 'approved') {
        return 'approved member';
      } else if (recipientType.value === 'registered') {
        return 'registered user';
      } else if (recipientType.value === 'pending') {
        return 'pending registration';
      } else if (recipientType.value === 'noEvents') {
        return 'approved member (no events)';
      }
      return 'recipient';
    }

    // Update recipient count display
    function updateRecipientCount() {
      const recipients = getCurrentRecipients();
      const type = getRecipientLabel();
      
      memberCountContainer.innerHTML = `
        <span class="badge bg-primary member-count-badge">
          <i class="bi bi-people-fill"></i> ${recipients.length} ${type}${recipients.length !== 1 ? 's' : ''}
        </span>`;

      // Enable/disable send button
      sendEmailBtn.disabled = recipients.length === 0;
      
      // Show/hide pending info banner and update greeting hint
      if (recipientType.value === 'pending') {
        pendingInfoBanner.classList.remove('hidden');
        greetingHint.innerHTML = '<i class="bi bi-info-circle"></i> The greeting "Hello," will be added automatically (no names available for pending registrations). Start with your message content.';
      } else {
        pendingInfoBanner.classList.add('hidden');
        greetingHint.innerHTML = '<i class="bi bi-info-circle"></i> The greeting "Dear [member first name]," will be added automatically. Start with your message content.';
      }
      
      // Update preview when recipient type changes
      updatePreview();
      
      if (recipients.length === 0) {
        showAlert(`No ${type}s found to email.`, 'warning');
      }
    }

    // Calculate estimated time
    function getEstimatedTime(count) {
      const totalSeconds = Math.ceil((count * EMAIL_DELAY_MS) / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      
      if (minutes > 0) {
        return `${minutes} minute${minutes !== 1 ? 's' : ''} ${seconds} second${seconds !== 1 ? 's' : ''}`;
      }
      return `${seconds} second${seconds !== 1 ? 's' : ''}`;
    }

    // Update progress bar
    function updateProgress(current, total, currentEmail) {
      const percent = Math.round((current / total) * 100);
      progressBar.style.width = `${percent}%`;
      progressBar.textContent = `${percent}%`;
      progressText.textContent = `Sending ${current} of ${total}: ${currentEmail}`;
    }

    // Load all recipients
    async function loadRecipients() {
      try {
        // Get all users
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const usersData = {};
        const registeredEmails = new Set(); // Track all registered email addresses
        usersSnapshot.forEach(doc => {
          usersData[doc.id] = { id: doc.id, ...doc.data() };
          if (doc.data().email) {
            registeredEmails.add(doc.data().email.toLowerCase());
          }
        });

        // Get all profiles
        const profilesSnapshot = await getDocs(collection(db, 'profiles'));
        const profilesData = {};
        profilesSnapshot.forEach(doc => {
          profilesData[doc.id] = doc.data();
        });

        // Get all allowed emails
        const allowedEmailsSnapshot = await getDocs(collection(db, 'allowedEmails'));
        const allowedEmails = [];
        allowedEmailsSnapshot.forEach(doc => {
          allowedEmails.push(doc.id); // The document ID is the email address
        });

        // Get all event volunteers to track who has volunteered
        const eventVolunteersSnapshot = await getDocs(collection(db, 'eventVolunteers'));
        const usersWhoVolunteered = new Set();
        eventVolunteersSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.userId) {
            usersWhoVolunteered.add(data.userId);
          }
        });

        // Clear arrays
        approvedMembers = [];
        registeredUsers = [];
        pendingRegistration = [];
        approvedNoEvents = [];

        // Process each user
        Object.keys(usersData).forEach(userId => {
          const user = usersData[userId];
          const profile = profilesData[userId];
          
          // Skip users without email
          if (!user.email) return;

          // Check if user has an approved profile
          if (profile && profile.adminUse?.status === 'approved') {
            const memberData = {
              id: userId,
              email: user.email,
              firstName: user.firstName || profile.personalDetails?.firstName || 'Member',
              surname: user.surname || profile.personalDetails?.surname || ''
            };
            
            // Add to approved members list
            approvedMembers.push(memberData);
            
            // Check if they have NOT volunteered for any events
            if (!usersWhoVolunteered.has(userId)) {
              approvedNoEvents.push({ ...memberData });
            }
          } 
          // Check if user has no profile or no submitted profile
          else if (!profile || !profile.submission?.submittedAt) {
            registeredUsers.push({
              id: userId,
              email: user.email,
              firstName: user.firstName || 'Member',
              surname: user.surname || ''
            });
          }
        });

        // Process allowed emails to find those who haven't registered
        allowedEmails.forEach(email => {
          const emailLower = email.toLowerCase();
          // Check if this email has NOT registered (not in usersData)
          if (!registeredEmails.has(emailLower)) {
            pendingRegistration.push({
              email: email,
              firstName: null // No name available
            });
          }
        });

        // Sort all arrays
        const sortByName = (a, b) => {
          const nameA = `${a.firstName || ''} ${a.surname || ''}`.toLowerCase();
          const nameB = `${b.firstName || ''} ${b.surname || ''}`.toLowerCase();
          return nameA.localeCompare(nameB);
        };
        const sortByEmail = (a, b) => a.email.toLowerCase().localeCompare(b.email.toLowerCase());
        
        approvedMembers.sort(sortByName);
        registeredUsers.sort(sortByName);
        pendingRegistration.sort(sortByEmail);
        approvedNoEvents.sort(sortByName);

        console.log(`Loaded ${approvedMembers.length} approved members, ${registeredUsers.length} registered users, ${pendingRegistration.length} pending registrations, and ${approvedNoEvents.length} approved members with no events`);

        // Update count display
        updateRecipientCount();

      } catch (error) {
        console.error('Error loading recipients:', error);
        memberCountContainer.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-triangle"></i> Error loading</span>`;
        showAlert('Error loading recipients: ' + error.message, 'danger');
      }
    }

    // Update preview
    function updatePreview() {
      const subject = emailSubject.value.trim();
      const content = emailContent.value.trim();

      if (!subject && !content) {
        emailPreview.innerHTML = '<em class="text-muted">Enter a subject and message to see preview...</em>';
        return;
      }

      // Use different greeting for pending registrations
      const greeting = recipientType.value === 'pending' ? 'Hello' : 'Dear [Member First Name]';

      emailPreview.textContent = `Subject: ${subject || '(No subject)'}\n\n${greeting},\n\n${content || '(No content)'}\n\nPrehospital Team Leaders\nprehospital@festival-medical.org`;
    }

    // Send emails with delay
    async function sendEmails() {
      const subject = emailSubject.value.trim();
      const content = emailContent.value.trim();
      const recipients = getCurrentRecipients();
      const recipientLabel = getRecipientLabel() + 's';
      const isPending = recipientType.value === 'pending';

      if (!subject || !content) {
        showAlert('Please enter both subject and message.', 'warning');
        return;
      }

      if (recipients.length === 0) {
        showAlert('No recipients to send emails to.', 'warning');
        return;
      }

      // Hide confirm modal
      confirmModal.hide();

      // Show progress, hide form elements
      progressContainer.classList.remove('hidden');
      recipientCard.classList.add('hidden');
      warningBanner.classList.add('hidden');
      pendingInfoBanner.classList.add('hidden');
      emailFormCard.classList.add('hidden');
      document.getElementById('alertContainer').innerHTML = '';

      let successCount = 0;
      let errorCount = 0;
      const sentTo = [];
      const errors = [];

      try {
        // Send individual emails to each recipient with delay
        for (let i = 0; i < recipients.length; i++) {
          const recipient = recipients[i];
          
          // Update progress
          updateProgress(i + 1, recipients.length, recipient.email);
          
          try {
            // Use different greeting for pending registrations (no name available)
            let personalizedContent;
            if (isPending) {
              personalizedContent = `Hello,\n\n${content}\n\nPrehospital Team Leaders\nprehospital@festival-medical.org`;
            } else {
              const firstName = recipient.firstName || 'Member';
              personalizedContent = `Dear ${firstName},\n\n${content}\n\nPrehospital Team Leaders\nprehospital@festival-medical.org`;
            }

            await addDoc(collection(db, 'mail'), {
              to: recipient.email,
              replyTo: 'prehospital@festival-medical.org',
              message: {
                subject: subject,
                text: personalizedContent,
                html: personalizedContent.replace(/\n/g, '<br>')
              }
            });

            successCount++;
            if (isPending) {
              sentTo.push(recipient.email);
            } else {
              sentTo.push(`${recipient.firstName} ${recipient.surname} (${recipient.email})`);
            }
          } catch (err) {
            console.error(`Error sending to ${recipient.email}:`, err);
            errorCount++;
            errors.push(`${recipient.email}: ${err.message}`);
          }

          // Delay before next email (except for last one)
          if (i < recipients.length - 1) {
            await delay(EMAIL_DELAY_MS);
          }
        }

        // Update progress to complete
        progressText.textContent = 'Sending summary email...';

        // Send summary email to prehospital
        if (sentTo.length > 0) {
          const summaryContent = `This email was sent to ${sentTo.length} ${recipientLabel}.\n\nSubject: ${subject}\n\nMessage:\n${content}\n\n---\nRecipient List:\n${sentTo.join('\n')}${errors.length > 0 ? '\n\n---\nErrors:\n' + errors.join('\n') : ''}\n\n---\nPrehospital Team Leaders\nprehospital@festival-medical.org`;

          await addDoc(collection(db, 'mail'), {
            to: 'prehospital@festival-medical.org',
            message: {
              subject: `[COPY] ${subject} - Sent to ${sentTo.length} ${recipientLabel}`,
              text: summaryContent,
              html: summaryContent.replace(/\n/g, '<br>')
            }
          });
        }

        // Hide progress
        progressContainer.classList.add('hidden');

        // Show success modal
        document.getElementById('successCount').textContent = successCount;
        if (errorCount > 0) {
          document.getElementById('errorSummary').textContent = `${errorCount} email(s) failed to send. Check the summary email for details.`;
          document.getElementById('errorSummary').style.display = 'block';
        } else {
          document.getElementById('errorSummary').style.display = 'none';
        }
        successModal.show();

      } catch (error) {
        console.error('Error sending emails:', error);
        progressContainer.classList.add('hidden');
        recipientCard.classList.remove('hidden');
        warningBanner.classList.remove('hidden');
        if (recipientType.value === 'pending') {
          pendingInfoBanner.classList.remove('hidden');
        }
        emailFormCard.classList.remove('hidden');
        showAlert('Error sending emails: ' + error.message, 'danger');
      }
    }

    // Event Listeners
    document.getElementById('logoutLink').addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        alert('Logout failed: ' + error.message);
      }
    });

    recipientType.addEventListener('change', () => {
      document.getElementById('alertContainer').innerHTML = '';
      updateRecipientCount();
    });

    emailSubject.addEventListener('input', updatePreview);
    emailContent.addEventListener('input', updatePreview);

    emailForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const recipients = getCurrentRecipients();
      const recipientLabel = getRecipientLabel() + 's';
      
      // Update confirmation modal
      document.getElementById('confirmMemberCount').textContent = recipients.length;
      document.getElementById('confirmRecipientType').textContent = recipientLabel;
      document.getElementById('confirmSubject').textContent = emailSubject.value.trim();
      document.getElementById('estimatedTime').textContent = getEstimatedTime(recipients.length);
      
      // Show confirmation modal
      confirmModal.show();
    });

    document.getElementById('confirmSendBtn').addEventListener('click', sendEmails);

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        
        if (userDoc.exists() && userDoc.data().isAdmin === true) {
          mainContent.classList.remove('hidden');
          unauthorizedMsg.classList.add('hidden');
          await loadRecipients();
        } else {
          mainContent.classList.add('hidden');
          unauthorizedMsg.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error checking admin status:', error);
        mainContent.classList.add('hidden');
        unauthorizedMsg.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>
