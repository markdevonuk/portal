<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Profile - FMS Prehospital Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { background:#f8f9fa; min-height:100vh; }
    .navbar { 
      background:linear-gradient(135deg,#00a896 0%,#028090 100%); 
      box-shadow:0 2px 10px rgba(0,0,0,.1); 
    }
    .nav-link { color: rgba(255,255,255,.85) !important; font-weight: 500; }
    .nav-link:hover { color: #fff !important; }
    .profile-card { 
      background:#fff; 
      border-radius:15px; 
      box-shadow:0 5px 20px rgba(0,0,0,.08); 
      padding:30px; 
      margin:20px 0; 
    }
    .page-header { 
      background:linear-gradient(135deg,#00a896 0%,#028090 100%); 
      color:#fff; 
      border-radius:15px; 
      padding:30px; 
      margin:30px 0 20px 0; 
    }
    .form-control:focus { 
      border-color: #00a896; 
      box-shadow: 0 0 0 0.2rem rgba(0,168,150,.25); 
    }
    .btn-primary { 
      background: linear-gradient(135deg, #00a896 0%, #028090 100%); 
      border: none; 
      font-weight: 600; 
    }
    .btn-primary:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 5px 15px rgba(0,168,150,.4); 
    }
    .section-title {
      border-bottom: 2px solid #00a896;
      padding-bottom: 10px;
      margin-bottom: 20px;
      color: #028090;
    }
    .form-section {
      margin-bottom: 30px;
    }
    .btn-loading { position: relative; pointer-events: none; opacity: .7; }
    .btn-loading::after { 
      content:""; position:absolute; width:16px; height:16px; top:50%; left:50%; 
      margin:-8px 0 0 -8px; border:2px solid #fff; border-radius:50%; 
      border-top-color:transparent; animation:spinner .6s linear infinite; 
    }
    @keyframes spinner { to { transform: rotate(360deg); } }
    .hidden { display: none; }
    .text-success { color: #00a896 !important; }
    .profile-status {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d1e7dd; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .form-check-input:checked {
      background-color: #00a896;
      border-color: #00a896;
    }
    /* Document styles */
    .doc-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 10px;
    }
    .doc-preview-icon {
      font-size: 2rem;
      color: #00a896;
    }
    .doc-preview-info {
      flex-grow: 1;
    }
    .doc-preview-actions {
      display: flex;
      gap: 5px;
    }
    .profile-photo {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
      border: 3px solid #00a896;
    }
    .upload-progress {
      height: 5px;
      margin-top: 5px;
    }
    
 /* Mobile-specific styles */
@media (max-width: 767px) {
  .input-group {
    width: 100%;
  }
  
  input#dob, 
  input#certExpiry {
    display: block !important;
    width: 100%;
    visibility: visible !important;
  }
}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html"><i class="bi bi-shield-lock"></i> FMS Prehospital Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item hidden" id="adminNavItem">
            <a class="nav-link" href="admin.html">
              <i class="bi bi-gear-fill"></i> Admin
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-house-fill"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutLink">
              <i class="bi bi-box-arrow-right"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1 class="mb-2"><i class="bi bi-person-vcard-fill"></i> My Profile</h1>
      <p class="mb-0">Complete your professional details</p>
    </div>

    <div id="alertContainer"></div>

    <!-- Profile Status -->
    <div id="profileStatus" class="profile-status hidden">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-1" id="statusTitle">Profile Status</h5>
          <p class="mb-0" id="statusMessage">Your profile status will appear here</p>
        </div>
        <div id="statusIcon">
          <i class="bi bi-question-circle fs-1"></i>
        </div>
      </div>
    </div>

    <!-- Profile Form -->
    <form id="profileForm">
      <!-- Profile Photo Section -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-person-badge"></i> Profile Photo</h3>
        
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> <strong>Required:</strong> Please upload a clear photo of yourself. Ensure no one else is in the photo. Accepted files are JPG, PNG.
        </div>
        
        <div class="row">
          <div class="col-md-4 text-center mb-3">
            <div id="photoPreviewContainer">
              <img src="https://via.placeholder.com/150?text=No+Photo" alt="Profile Photo" class="profile-photo" id="photoPreview">
            </div>
          </div>
          <div class="col-md-8">
            <div class="mb-3">
              <label for="profilePhotoInput" class="form-label">Select Photo</label>
              <input type="file" class="form-control" id="profilePhotoInput" accept="image/jpeg, image/png">
              <div class="form-text">Max file size: 7.5MB</div>
            </div>
            
            <button type="button" class="btn btn-primary" id="uploadPhotoBtn">
              <i class="bi bi-cloud-upload"></i> Upload Photo
            </button>
            
            <div class="progress mt-2 hidden" id="photoUploadProgressContainer">
              <div class="progress-bar bg-success" id="photoUploadProgressBar" role="progressbar" style="width: 0%"></div>
            </div>
            
            <input type="hidden" id="profilePhotoURL" name="profilePhotoURL">
          </div>
        </div>
      </div>
      <!-- Personal Details Section -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-person-fill"></i> Personal Details</h3>
        
        <div class="mb-3">
          <label class="form-label">Your date of birth <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
            <input type="text" class="form-control" id="dob" name="dob" placeholder="DD/MM/YYYY" required>
          </div>
          <small class="form-text text-muted">Select your date of birth</small>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Who should we contact in an emergency <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-telephone"></i></span>
            <input type="text" class="form-control" id="emergencyContact" name="emergencyContact" placeholder="Name & phone number" required>
          </div>
          <small class="form-text text-muted">Provide a name and contact number</small>
        </div>
      </div>
      
      <!-- Driving Details Section -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-car-front-fill"></i> Driving Details</h3>
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> Optional, but you cannot drive FMS vehicles without supplying this data. By completing you agree that FMS or external agencies can carry out driving licence checks online from time to time.
        </div>
        
        <div class="mb-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="c1Classification" name="c1Classification">
            <label class="form-check-label" for="c1Classification">I have a C1 classification on my driving licence</label>
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Your driving licence number</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-credit-card-2-front"></i></span>
            <input type="text" class="form-control" id="dlNumber" name="dlNumber" placeholder="e.g. SMITH601014ABCDE">
          </div>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Your National Insurance number</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-shield"></i></span>
            <input type="text" class="form-control" id="niNumber" name="niNumber" placeholder="e.g. AB123456C">
          </div>
          <small class="form-text text-muted">Used for driving licence checks online</small>
        </div>
        
        <div class="mb-3">
          <label class="form-label">How many points do you have on your licence</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-exclamation-triangle"></i></span>
            <input type="text" class="form-control" id="points" name="points" placeholder="e.g. 0, 3, etc.">
          </div>
        </div>
      </div>
      
      <!-- Medical Qualifications Section -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-award"></i> Your Qualifications</h3>
        
        <div class="mb-4">
          <label class="form-label">What is your main qualification <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-mortarboard"></i></span>
            <select class="form-select" id="qualification" name="qualification" required>
              <option value="">Select your main qualification</option>
              <option value="Non Medical">Non Medical (Make Ready, Medcomms etc)</option>
              <option value="AAP">AAP</option>
              <option value="Doctor">Doctor</option>
              <option value="Doctor (Critical Care/BASICS/Merit)">Doctor (Critical Care/BASICS/Merit)</option>
              <option value="Doctor (with FREC/PHTLS or similar)">Doctor (with FREC/PHTLS or similar)</option>
              <option value="EAA">EAA</option>
              <option value="ECA">ECA</option>
              <option value="FREC 3 (or similar level 3 certification)">FREC 3 (or similar level 3 certification)</option>
              <option value="FREC 4">FREC 4</option>
              <option value="Nurse">Nurse</option>
              <option value="Nurse (Ambulance Nurse)">Nurse (Ambulance Nurse)</option>
              <option value="Nurse (with FREC/PHTLS or similar)">Nurse (with FREC/PHTLS or similar)</option>
              <option value="Paramedic">Paramedic</option>
              <option value="Paramedic (Critical care)">Paramedic (Critical care)</option>
              <option value="Paramedic (CTM/OO)">Paramedic (CTM/OO)</option>
              <option value="Paramedic (HART)">Paramedic (HART)</option>
              <option value="Paramedic (in Primary Care)">Paramedic (in Primary Care)</option>
              <option value="Paramedic (Specialist)">Paramedic (Specialist)</option>
              <option value="PHTLS">PHTLS</option>
              <option value="Student Paramedic (Year 2)">Student Paramedic (Year 2)</option>
              <option value="Student Paramedic (Year 3)">Student Paramedic (Year 3)</option>
              <option value="Technician">Technician</option>
            </select>
          </div>
        </div>
        
        <!-- Qualification Evidence Upload -->
        <div class="mb-4">
          <h5 class="mb-3">Qualification Evidence</h5>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> <strong>Optional:</strong> Please upload evidence of your qualification. <br>
            <ul class="mb-0">
              <li><strong>Paramedics:</strong> HCPC screenshot or photo, or Trust ID card</li>
              <li><strong>Tech/ECA/EAA:</strong> Your Trust ID card or certificate</li>
              <li><strong>Nurses:</strong> PHTLS or FREC certificate if you have one</li>
              <li><strong>Doctors:</strong> PHTLS or FREC certificate if you have one</li>
              <li><strong>All others:</strong> Please upload your certificate</li>
            </ul>
            <p class="mt-2 mb-0">Accepted files are PDF, Word, JPG, PNG.</p>
          </div>
          
          <div class="mb-3">
            <label for="qualificationDocInput" class="form-label">Select Document</label>
            <input type="file" class="form-control" id="qualificationDocInput" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
            <div class="form-text">Max file size: 7.5MB</div>
          </div>
          
          <button type="button" class="btn btn-primary" id="uploadQualDocBtn">
            <i class="bi bi-cloud-upload"></i> Upload Document
          </button>
          
          <div class="progress mt-2 hidden" id="qualDocUploadProgressContainer">
            <div class="progress-bar bg-success" id="qualDocUploadProgressBar" role="progressbar" style="width: 0%"></div>
          </div>
          
          <div id="qualDocPreviewContainer" class="mt-3 hidden">
            <!-- Qualification document preview will appear here -->
          </div>
          
          <input type="hidden" id="qualificationDocURL" name="qualificationDocURL">
        </div>
        
        <!-- HCPC Registration (conditional) -->
        <div class="mb-3 hidden" id="hcpcSection">
          <label class="form-label">HCPC Registration <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-card-text"></i></span>
            <input type="text" class="form-control" id="hcpc" name="hcpc" placeholder="Your HCPC registration number">
          </div>
        </div>
        
        <!-- GMC Registration (conditional) -->
        <div class="mb-3 hidden" id="gmcSection">
          <label class="form-label">GMC Registration <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-card-text"></i></span>
            <input type="text" class="form-control" id="gmc" name="gmc" placeholder="Your GMC registration number">
          </div>
        </div>
        
        <!-- NMC Registration (conditional) -->
        <div class="mb-3 hidden" id="nmcSection">
          <label class="form-label">NMC Registration <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-card-text"></i></span>
            <input type="text" class="form-control" id="nmc" name="nmc" placeholder="Your NMC registration number">
          </div>
        </div>
        
        <!-- Certificate Expiry (conditional) -->
        <div class="mb-3 hidden" id="certExpirySection">
          <label class="form-label">When does your certificate expire <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
            <input type="text" class="form-control" id="certExpiry" name="certExpiry" placeholder="DD/MM/YYYY">
          </div>
        </div>
        
        <!-- Details -->
        <div class="mb-3">
          <label class="form-label">Details <span class="text-danger">*</span></label>
          <textarea class="form-control" id="details" name="details" rows="4" placeholder="Please give us a short idea of your day job and any relevance to FMS" required></textarea>
          <small class="form-text text-muted">Briefly describe your current role and its relevance to FMS</small>
        </div>
      </div>
      
      <!-- Terms and Conditions -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-check-square"></i> Terms and Conditions</h3>
        
        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="agreedToTerms" name="agreedToTerms" required>
            <label class="form-check-label" for="agreedToTerms">
              I agree to the following terms: FMS may use my personal information for operational and recruitment purposes. I confirm that all information provided is accurate and complete. I understand that my profile will be reviewed by FMS administrators before approval.
            </label>
          </div>
        </div>
      </div>
      
      <!-- Form Actions -->
      <div class="d-flex justify-content-between mb-5">
        <button type="button" class="btn btn-outline-secondary" id="saveAsDraftBtn">
          <i class="bi bi-save"></i> Save as Draft
        </button>
        <button type="submit" class="btn btn-primary" id="submitProfileBtn">
          <i class="bi bi-send"></i> Submit Profile
        </button>
      </div>
    </form>

    <!-- Debug Panel -->
    <div class="profile-card mb-5" id="debugPanel" style="display: none;">
      <h3 class="section-title"><i class="bi bi-bug"></i> Debug Information</h3>
      <div class="mb-3">
        <pre id="debugOutput" style="background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto;"></pre>
      </div>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-outline-secondary" id="showDebugBtn">
          Toggle Debug Panel
        </button>
        <button type="button" class="btn btn-sm btn-outline-danger" id="clearProfileBtn">
          Clear Profile (Debug)
        </button>
      </div>
    </div>
  </div>
  
  <!-- Document Preview Modal -->
  <div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="documentPreviewModalLabel">Document Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="documentPreviewContent">
          <!-- Preview content will be inserted here -->
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-primary" id="downloadDocBtn" target="_blank">
            <i class="bi bi-download"></i> Download
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, deleteDoc, updateDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { firebaseConfig } from './firebase-config.js';
    import { 
      getCurrentUserProfile, 
      createProfile, 
      updatePersonalDetails, 
      updateDriving, 
      updateMedicalQualifications, 
      submitProfile,
      updateAndResubmitProfile
    } from './profile-service.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    
    // Debug functionality
    const debugOutput = document.getElementById('debugOutput');
    const debugPanel = document.getElementById('debugPanel');
    const showDebugBtn = document.getElementById('showDebugBtn');
    const clearProfileBtn = document.getElementById('clearProfileBtn');
    
    function logDebug(message, data = null) {
      const timestamp = new Date().toISOString().substr(11, 8);
      let logMessage = `[${timestamp}] ${message}`;
      if (data) {
        logMessage += `\n${JSON.stringify(data, null, 2)}`;
      }
      console.log(logMessage);
      
      if (debugOutput) {
        debugOutput.innerHTML += logMessage + '\n\n';
        // Auto-scroll to bottom
        debugOutput.scrollTop = debugOutput.scrollHeight;
      }
    }
    
    showDebugBtn.addEventListener('click', () => {
      debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
    });
    
    clearProfileBtn.addEventListener('click', async () => {
      try {
        const user = auth.currentUser;
        if (!user) return;
        
        if (confirm('WARNING: This will permanently delete your profile data. Continue?')) {
          await deleteDoc(doc(db, 'profiles', user.uid));
          logDebug('Profile deleted successfully');
          showAlert('Profile deleted. Reloading...', 'success');
          setTimeout(() => location.reload(), 2000);
        }
      } catch (error) {
        logDebug('Error deleting profile', error);
        showAlert('Error deleting profile: ' + error.message, 'danger');
      }
    });
    

  
  // Check if this is a mobile device
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

if (isMobile) {
  // For mobile devices, use native date inputs
  document.getElementById('dob').type = "date";
  document.getElementById('certExpiry').type = "date";
} else {
  // For desktop, use flatpickr
  flatpickr("#dob", {
    dateFormat: "d/m/Y",
    maxDate: new Date() // Can't select future dates
  });
  
  flatpickr("#certExpiry", {
    dateFormat: "d/m/Y",
    minDate: new Date() // Can't select past dates
  });
}

    // DOM elements
    const profileForm = document.getElementById('profileForm');
    const saveAsDraftBtn = document.getElementById('saveAsDraftBtn');
    const submitProfileBtn = document.getElementById('submitProfileBtn');
    const qualification = document.getElementById('qualification');
    const hcpcSection = document.getElementById('hcpcSection');
    const gmcSection = document.getElementById('gmcSection');
    const nmcSection = document.getElementById('nmcSection');
    const certExpirySection = document.getElementById('certExpirySection');
    const profileStatus = document.getElementById('profileStatus');
    const statusTitle = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');
    const statusIcon = document.getElementById('statusIcon');
    const alertContainer = document.getElementById('alertContainer');
    const adminNavItem = document.getElementById('adminNavItem');
    const logoutLink = document.getElementById('logoutLink');
    const documentPreviewModal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
    const documentPreviewContent = document.getElementById('documentPreviewContent');
    const downloadDocBtn = document.getElementById('downloadDocBtn');
    // Document Upload DOM elements
    const profilePhotoInput = document.getElementById('profilePhotoInput');
    const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
    const photoUploadProgressContainer = document.getElementById('photoUploadProgressContainer');
    const photoUploadProgressBar = document.getElementById('photoUploadProgressBar');
    const photoPreview = document.getElementById('photoPreview');
    const profilePhotoURL = document.getElementById('profilePhotoURL');
    
    const qualificationDocInput = document.getElementById('qualificationDocInput');
    const uploadQualDocBtn = document.getElementById('uploadQualDocBtn');
    const qualDocUploadProgressContainer = document.getElementById('qualDocUploadProgressContainer');
    const qualDocUploadProgressBar = document.getElementById('qualDocUploadProgressBar');
    const qualDocPreviewContainer = document.getElementById('qualDocPreviewContainer');
    const qualificationDocURL = document.getElementById('qualificationDocURL');

    // Helper Functions
    function setButtonLoading(id, loading) {
      const btn = document.getElementById(id);
      if (!btn) return;
      if (loading) {
        btn.classList.add('btn-loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('btn-loading');
        btn.disabled = false;
      }
    }

function showAlert(message, type) {
  const html = `
    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  alertContainer.innerHTML = html;
  
  // Scroll to the top of the page to show the alert
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  if (type === 'success') {
    setTimeout(() => {
      const alert = document.querySelector('.alert');
      if (alert) {
        alert.classList.remove('show');
        setTimeout(() => alert.remove(), 150);
      }
    }, 5000);
  }
}

function showInlineConfirmation(message, parentElement, isSubmission = false) {
  // Create the inline confirmation element
  const inlineConfirmation = document.createElement('div');
  inlineConfirmation.className = 'alert alert-success mt-3 w-100';
  
  // If it's a submission (not just save as draft), add dashboard button
  if (isSubmission) {
    inlineConfirmation.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <i class="bi bi-check-circle-fill me-2"></i>
          ${message}
        </div>
        <a href="dashboard.html" class="btn btn-primary">
          <i class="bi bi-house-fill"></i> Return to Dashboard
        </a>
      </div>
    `;
  } else {
    inlineConfirmation.innerHTML = `
      <i class="bi bi-check-circle-fill me-2"></i>
      ${message}
    `;
  }
  
  // Add it to the DOM after the parent element
  parentElement.parentNode.insertBefore(inlineConfirmation, parentElement.nextSibling);
  
  // Scroll to make the inline confirmation visible
  inlineConfirmation.scrollIntoView({ behavior: 'smooth', block: 'center' });
  
  // Remove after some time - but only if not a submission
  if (!isSubmission) {
    setTimeout(() => {
      inlineConfirmation.remove();
    }, 7000);
  }
}

    // File upload functions
    
    // Check if file is an image
    function isImageFile(fileName) {
      const extension = fileName.split('.').pop().toLowerCase();
      return ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension);
    }

    // Check if file is a document
    function isDocFile(fileName) {
      const extension = fileName.split('.').pop().toLowerCase();
      return ['pdf', 'doc', 'docx'].includes(extension);
    }

    // Get file icon based on extension
    function getFileIcon(fileName) {
      const extension = fileName.split('.').pop().toLowerCase();
      if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension)) {
        return 'bi-file-earmark-image';
      } else if (extension === 'pdf') {
        return 'bi-file-earmark-pdf';
      } else if (['doc', 'docx'].includes(extension)) {
        return 'bi-file-earmark-word';
      } else {
        return 'bi-file-earmark';
      }
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes < 1024) {
        return bytes + ' B';
      } else if (bytes < 1024 * 1024) {
        return (bytes / 1024).toFixed(1) + ' KB';
      } else {
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
    }

    // Upload profile photo
    uploadPhotoBtn.addEventListener('click', async () => {
      const file = profilePhotoInput.files[0];
      if (!file) {
        showAlert('Please select a photo to upload', 'warning');
        return;
      }
      
      // Validate file size (max 7.5MB)
      if (file.size > 7.5 * 1024 * 1024) {
        showAlert('Photo size exceeds 2MB limit', 'warning');
        return;
      }
      
      // Validate file type
      if (!isImageFile(file.name)) {
        showAlert('Only JPG and PNG files are allowed for profile photos', 'warning');
        return;
      }
      
      setButtonLoading('uploadPhotoBtn', true);
      photoUploadProgressContainer.classList.remove('hidden');
      
      try {
        const user = auth.currentUser;
        
        // Generate a unique filename
        const timestamp = new Date().getTime();
        const fileExtension = file.name.split('.').pop();
        const fileName = `profile_photo_${timestamp}.${fileExtension}`;
        
        // Create storage reference
        const storagePath = `profilePhotos/${user.uid}/${fileName}`;
        const storageRef = ref(storage, storagePath);
        
        // Upload file with progress tracking
        const uploadTask = uploadBytesResumable(storageRef, file);
        
        uploadTask.on(
          'state_changed',
          (snapshot) => {
            // Track upload progress
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            photoUploadProgressBar.style.width = progress + '%';
          },
          (error) => {
            // Handle upload error
            console.error('Error uploading photo:', error);
            showAlert('Error uploading photo: ' + error.message, 'danger');
            setButtonLoading('uploadPhotoBtn', false);
            photoUploadProgressContainer.classList.add('hidden');
          },
          async () => {
            // Upload complete
            try {
              // Get download URL
              const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
              
              // Update profile with photo URL
              const profileRef = doc(db, 'profiles', user.uid);
              const profileSnap = await getDoc(profileRef);
              
              if (profileSnap.exists()) {
                await updateDoc(profileRef, {
                  profilePhotoURL: downloadURL,
                  profilePhotoStoragePath: storagePath
                });
                
                // Update UI
                profilePhotoURL.value = downloadURL;
                photoPreview.src = downloadURL;
                showAlert('Profile photo uploaded successfully', 'success');
              } else {
                // Create a new profile if it doesn't exist
                await createProfile({
                  profilePhotoURL: downloadURL,
                  profilePhotoStoragePath: storagePath
                });
                
                // Update UI
                profilePhotoURL.value = downloadURL;
                photoPreview.src = downloadURL;
                showAlert('Profile created and photo uploaded successfully', 'success');
              }
            } catch (error) {
              console.error('Error updating profile with photo:', error);
              showAlert('Error updating profile: ' + error.message, 'danger');
            } finally {
              setButtonLoading('uploadPhotoBtn', false);
              photoUploadProgressContainer.classList.add('hidden');
            }
          }
        );
      } catch (error) {
        console.error('Error setting up photo upload:', error);
        showAlert('Error setting up photo upload: ' + error.message, 'danger');
        setButtonLoading('uploadPhotoBtn', false);
        photoUploadProgressContainer.classList.add('hidden');
      }
    });
    
    // Upload qualification document
    uploadQualDocBtn.addEventListener('click', async () => {
      const file = qualificationDocInput.files[0];
      if (!file) {
        showAlert('Please select a document to upload', 'warning');
        return;
      }
      
      // Validate file size (max 7.5MB)
      if (file.size > 7.5 * 1024 * 1024) {
        showAlert('Document size exceeds 5MB limit', 'warning');
        return;
      }
      
      // Validate file type
      const fileExt = file.name.split('.').pop().toLowerCase();
      const allowedExtensions = ['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png'];
      
      if (!allowedExtensions.includes(fileExt)) {
        showAlert('Only PDF, Word, JPG, and PNG files are allowed', 'warning');
        return;
      }
      
      setButtonLoading('uploadQualDocBtn', true);
      qualDocUploadProgressContainer.classList.remove('hidden');
      
      try {
        const user = auth.currentUser;
        
        // Generate a unique filename
        const timestamp = new Date().getTime();
        const fileName = `qualification_doc_${timestamp}_${file.name}`;
        
        // Create storage reference
        const storagePath = `qualificationDocs/${user.uid}/${fileName}`;
        const storageRef = ref(storage, storagePath);
        
        // Upload file with progress tracking
        const uploadTask = uploadBytesResumable(storageRef, file);
        
        uploadTask.on(
          'state_changed',
          (snapshot) => {
            // Track upload progress
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            qualDocUploadProgressBar.style.width = progress + '%';
          },
          (error) => {
            // Handle upload error
            console.error('Error uploading document:', error);
            showAlert('Error uploading document: ' + error.message, 'danger');
            setButtonLoading('uploadQualDocBtn', false);
            qualDocUploadProgressContainer.classList.add('hidden');
          },
          async () => {
            // Upload complete
            try {
              // Get download URL
              const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
              
              // Update profile with document URL
              const profileRef = doc(db, 'profiles', user.uid);
              const profileSnap = await getDoc(profileRef);
              
              if (profileSnap.exists()) {
                await updateDoc(profileRef, {
                  qualificationDocURL: downloadURL,
                  qualificationDocName: file.name,
                  qualificationDocType: file.type,
                  qualificationDocSize: file.size,
                  qualificationDocStoragePath: storagePath,
                  qualificationDocUploadedAt: serverTimestamp()
                });
                
                // Update UI
                qualificationDocURL.value = downloadURL;
                showAlert('Qualification document uploaded successfully', 'success');
                updateQualDocPreview(file.name, downloadURL, storagePath, file.type, file.size);
              } else {
                // Create a new profile if it doesn't exist
                await createProfile({
                  qualificationDocURL: downloadURL,
                  qualificationDocName: file.name,
                  qualificationDocType: file.type,
                  qualificationDocSize: file.size,
                  qualificationDocStoragePath: storagePath,
                  qualificationDocUploadedAt: serverTimestamp()
                });
                
                // Update UI
                qualificationDocURL.value = downloadURL;
                showAlert('Profile created and document uploaded successfully', 'success');
                updateQualDocPreview(file.name, downloadURL, storagePath, file.type, file.size);
              }
            } catch (error) {
              console.error('Error updating profile with document:', error);
              showAlert('Error updating profile: ' + error.message, 'danger');
            } finally {
              setButtonLoading('uploadQualDocBtn', false);
              qualDocUploadProgressContainer.classList.add('hidden');
            }
          }
        );
      } catch (error) {
        console.error('Error setting up document upload:', error);
        showAlert('Error setting up document upload: ' + error.message, 'danger');
        setButtonLoading('uploadQualDocBtn', false);
        qualDocUploadProgressContainer.classList.add('hidden');
      }
    });

    // Update qualification document preview
    function updateQualDocPreview(fileName, downloadURL, storagePath, fileType, fileSize) {
      qualDocPreviewContainer.classList.remove('hidden');
      
      // Get file icon
      const fileIcon = getFileIcon(fileName);
      
      // Format file size
      const formattedSize = formatFileSize(fileSize);
      
      // Create preview HTML
      qualDocPreviewContainer.innerHTML = `
        <div class="doc-preview">
          <i class="bi ${fileIcon} doc-preview-icon"></i>
          <div class="doc-preview-info">
            <div class="fw-bold">${fileName}</div>
            <small class="text-muted">${formattedSize}</small>
          </div>
          <div class="doc-preview-actions">
            <button type="button" class="btn btn-sm btn-outline-primary view-doc-btn" 
                    data-url="${downloadURL}" 
                    data-name="${fileName}"
                    data-type="${fileType}">
              <i class="bi bi-eye"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger delete-doc-btn"
                    data-path="${storagePath}">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;
      
      // Add event listeners to buttons
      document.querySelector('.view-doc-btn').addEventListener('click', (e) => {
        const url = e.currentTarget.getAttribute('data-url');
        const name = e.currentTarget.getAttribute('data-name');
        const type = e.currentTarget.getAttribute('data-type');
        previewDocument(url, name, type);
      });
      
      document.querySelector('.delete-doc-btn').addEventListener('click', (e) => {
        const path = e.currentTarget.getAttribute('data-path');
        deleteQualificationDocument(path);
      });
    }

    // Preview document
    function previewDocument(url, name, type) {
      // Set document title
      document.getElementById('documentPreviewModalLabel').textContent = name;
      
      // Set download button
      downloadDocBtn.href = url;
      downloadDocBtn.setAttribute('download', name);
      
      // Clear previous content
      documentPreviewContent.innerHTML = '';
      
      // Check if it's an image
      if (type.startsWith('image/')) {
        // Image preview
        documentPreviewContent.innerHTML = `
          <div class="text-center">
            <img src="${url}" class="img-fluid" alt="${name}" style="max-height: 60vh;">
          </div>
        `;
      } else if (type === 'application/pdf') {
        // PDF preview
        documentPreviewContent.innerHTML = `
          <div class="ratio ratio-16x9" style="height: 60vh;">
            <iframe src="${url}" allowfullscreen></iframe>
          </div>
        `;
      } else {
        // Other document types
        documentPreviewContent.innerHTML = `
          <div class="text-center">
            <i class="${getFileIcon(name)}" style="font-size: 5rem; color: #00a896;"></i>
            <p class="mt-3">Preview not available for this file type.</p>
            <a href="${url}" target="_blank" class="btn btn-primary">
              <i class="bi bi-download"></i> Download to view
            </a>
          </div>
        `;
      }
      
      // Show modal
      documentPreviewModal.show();
    }
    
    // Delete qualification document
    async function deleteQualificationDocument(storagePath) {
      if (confirm('Are you sure you want to delete this document?')) {
        try {
          const user = auth.currentUser;
          
          // Delete from Storage
          const fileRef = ref(storage, storagePath);
          await deleteObject(fileRef);
          
          // Update profile
          const profileRef = doc(db, 'profiles', user.uid);
          await updateDoc(profileRef, {
            qualificationDocURL: null,
            qualificationDocName: null,
            qualificationDocType: null,
            qualificationDocSize: null,
            qualificationDocStoragePath: null,
            qualificationDocUploadedAt: null
          });
          
          // Update UI
          qualificationDocURL.value = '';
          qualDocPreviewContainer.innerHTML = '';
          qualDocPreviewContainer.classList.add('hidden');
          qualificationDocInput.value = '';
          
          showAlert('Document deleted successfully', 'success');
        } catch (error) {
          console.error('Error deleting document:', error);
          showAlert('Error deleting document: ' + error.message, 'danger');
        }
      }
    }

    // Show/hide registration fields based on qualification
    qualification.addEventListener('change', function() {
      const value = this.value;
      logDebug('Qualification changed to:', value);
      
      // Reset all sections to hidden
      hcpcSection.classList.add('hidden');
      gmcSection.classList.add('hidden');
      nmcSection.classList.add('hidden');
      certExpirySection.classList.add('hidden');
      
      // Remove required attribute from all registration inputs
      document.getElementById('hcpc').removeAttribute('required');
      document.getElementById('gmc').removeAttribute('required');
      document.getElementById('nmc').removeAttribute('required');
      document.getElementById('certExpiry').removeAttribute('required');
      
      // Show appropriate sections based on qualification
      if (['Paramedic', 'Paramedic (Specialist)', 'Paramedic (HART)', 
           'Paramedic (Critical care)', 'Paramedic (in Primary Care)', 
           'Paramedic (CTM/OO)'].includes(value)) {
        hcpcSection.classList.remove('hidden');
        document.getElementById('hcpc').setAttribute('required', 'required');
      } else if (['Doctor', 'Doctor (Critical Care/BASICS/Merit)', 
                  'Doctor (with FREC/PHTLS or similar)'].includes(value)) {
        gmcSection.classList.remove('hidden');
        document.getElementById('gmc').setAttribute('required', 'required');
      } else if (['Nurse', 'Nurse (Ambulance Nurse)', 
                  'Nurse (with FREC/PHTLS or similar)'].includes(value)) {
        nmcSection.classList.remove('hidden');
        document.getElementById('nmc').setAttribute('required', 'required');
        
        if (value === 'Nurse (with FREC/PHTLS or similar)') {
          certExpirySection.classList.remove('hidden');
          document.getElementById('certExpiry').setAttribute('required', 'required');
        }
      } else if (['FREC 3 (or similar level 3 certification)', 'FREC 4', 'PHTLS'].includes(value)) {
        certExpirySection.classList.remove('hidden');
        document.getElementById('certExpiry').setAttribute('required', 'required');
      }
    });

    // Disable form if profile is approved or rejected
    function disableForm(profileStatus) {
      logDebug('Disabling form with status:', profileStatus);
      
      const inputs = document.querySelectorAll('#profileForm input, #profileForm select, #profileForm textarea');
      inputs.forEach(input => {
        input.setAttribute('disabled', 'disabled');
      });
      
      // Disable upload buttons
      uploadPhotoBtn.disabled = true;
      uploadQualDocBtn.disabled = true;
      
      saveAsDraftBtn.classList.add('hidden');
      submitProfileBtn.classList.add('hidden');
      
      // Add an Edit button when the profile is approved or rejected
      if (profileStatus === 'approved' || profileStatus === 'rejected') {
        const formActions = document.querySelector('.d-flex.justify-content-between.mb-5');
        if (!document.getElementById('editProfileBtn')) {
          const editButton = document.createElement('button');
          editButton.type = 'button';
          editButton.id = 'editProfileBtn';
          editButton.className = 'btn btn-warning';
          editButton.innerHTML = '<i class="bi bi-pencil-square"></i> Edit Profile';
          editButton.addEventListener('click', enableForm);
          formActions.appendChild(editButton);
        }
        
        showAlert(`Your profile status is "${profileStatus}". To make changes, click the "Edit Profile" button.`, 'info');
      }
    }

    // Enable form for editing
    function enableForm() {
      logDebug('Enabling form for editing');
      
      const inputs = document.querySelectorAll('#profileForm input:not([type="submit"]), #profileForm select, #profileForm textarea');
      inputs.forEach(input => {
        input.removeAttribute('disabled');
      });
      
      // Enable upload buttons
      uploadPhotoBtn.disabled = false;
      uploadQualDocBtn.disabled = false;
      
      saveAsDraftBtn.classList.remove('hidden');
      
      // Change the submit button to "Resubmit Profile"
      submitProfileBtn.classList.remove('hidden');
      submitProfileBtn.innerHTML = '<i class="bi bi-send"></i> Resubmit Profile';
      
      // Remove the edit button
      const editButton = document.getElementById('editProfileBtn');
      if (editButton) {
        editButton.remove();
      }
      
      // Show an alert about resubmission
      showAlert('You are now editing your profile. Any changes will require admin approval again.', 'warning');
      
      // Trigger the qualification change event to show/hide appropriate fields
      document.getElementById('qualification').dispatchEvent(new Event('change'));
    }

    // Load user profile data including uploaded files
    async function loadUserProfile() {
      try {
        logDebug('Starting to load user profile');
        const user = auth.currentUser;
        logDebug('Current user:', user ? user.uid : 'no user');
        
        const profile = await getCurrentUserProfile();
        logDebug('Profile retrieved:', profile);
        
        if (profile) {
          logDebug('Profile exists, updating UI');
          
          // Update profile status display
          updateProfileStatus(profile);
          
          // Load profile photo if available
          if (profile.profilePhotoURL) {
            photoPreview.src = profile.profilePhotoURL;
            profilePhotoURL.value = profile.profilePhotoURL;
          }
          
          // Load qualification document if available
          if (profile.qualificationDocURL) {
            qualificationDocURL.value = profile.qualificationDocURL;
            updateQualDocPreview(
              profile.qualificationDocName || 'Document',
              profile.qualificationDocURL,
              profile.qualificationDocStoragePath || '',
              profile.qualificationDocType || 'application/octet-stream',
              profile.qualificationDocSize || 0
            );
          }
          
          // Fill form with existing data if available
          if (profile.personalDetails) {
            logDebug('Loading personal details:', profile.personalDetails);
            
       if (profile.personalDetails.DOB) {
  // Convert timestamp to date string
  let date;
  if (profile.personalDetails.DOB.seconds) {
    date = new Date(profile.personalDetails.DOB.seconds * 1000);
  } else {
    date = new Date(profile.personalDetails.DOB);
  }
  
  const dobInput = document.getElementById('dob');
  
  // Format differently based on input type (date for mobile, text for desktop)
  if (dobInput.type === 'date') {
    // YYYY-MM-DD format for native date inputs on mobile
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    dobInput.value = `${year}-${month}-${day}`;
  } else {
    // DD/MM/YYYY format for flatpickr on desktop
    dobInput.value = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
  }
  
  logDebug('Loaded DOB:', dobInput.value, 'Input type:', dobInput.type);
}
            
            document.getElementById('emergencyContact').value = profile.personalDetails.emergencyContact || '';
          }
          
          if (profile.driving) {
            logDebug('Loading driving details:', profile.driving);
            
            document.getElementById('c1Classification').checked = profile.driving.c1Classification || false;
            document.getElementById('dlNumber').value = profile.driving.dlNumber || '';
            document.getElementById('niNumber').value = profile.driving.niNumber || '';
            document.getElementById('points').value = profile.driving.points || '';
          }
          
          if (profile.medicalQualifications) {
            logDebug('Loading medical qualifications:', profile.medicalQualifications);
            
            document.getElementById('qualification').value = profile.medicalQualifications.qualification || '';
            document.getElementById('hcpc').value = profile.medicalQualifications.hcpc || '';
            document.getElementById('gmc').value = profile.medicalQualifications.gmc || '';
            document.getElementById('nmc').value = profile.medicalQualifications.nmc || '';
            document.getElementById('details').value = profile.medicalQualifications.details || '';
            
         if (profile.medicalQualifications.certExpiry) {
  // Convert timestamp to date string
  let date;
  if (profile.medicalQualifications.certExpiry.seconds) {
    date = new Date(profile.medicalQualifications.certExpiry.seconds * 1000);
  } else {
    date = new Date(profile.medicalQualifications.certExpiry);
  }
  
  const certExpiryInput = document.getElementById('certExpiry');
  
  // Format differently based on input type (date for mobile, text for desktop)
  if (certExpiryInput.type === 'date') {
    // YYYY-MM-DD format for native date inputs on mobile
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    certExpiryInput.value = `${year}-${month}-${day}`;
  } else {
    // DD/MM/YYYY format for flatpickr on desktop
    certExpiryInput.value = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
  }
}
            
            // Trigger change event to show/hide appropriate fields
            qualification.dispatchEvent(new Event('change'));
          }
          
          if (profile.submission) {
            logDebug('Loading submission details:', profile.submission);
            document.getElementById('agreedToTerms').checked = profile.submission.agreedToTerms || false;
          }
          
          // If profile is submitted and approved/rejected, disable form but add edit button
          if (profile.submission && profile.submission.submittedAt && 
              profile.adminUse && (profile.adminUse.status === 'approved' || profile.adminUse.status === 'rejected')) {
            disableForm(profile.adminUse.status);
          }
        } else {
          logDebug('No profile exists, creating new one');
          // No profile exists, create an empty one
          await createProfile({});
          showAlert('Profile created. Please complete your information below.', 'info');
        }
      } catch (error) {
        logDebug('Error loading profile:', error);
        console.error('Error loading profile:', error);
        showAlert('Error loading your profile data. Please try again later.', 'danger');
      }
    }

    // The rest of your code remains unchanged
    // Save as Draft, Submit Profile, Update Profile Status, etc.
    // ...

    function updateProfileStatus(status) {
      profileStatus.classList.remove('hidden');
      profileStatus.classList.remove('status-pending', 'status-approved', 'status-rejected');
      
      logDebug('Updating profile status', status);
      
      if (!status || !status.adminUse || !status.adminUse.status) {
        profileStatus.classList.add('hidden');
        return;
      }
      
      const adminStatus = status.adminUse.status;
      
      if (adminStatus === 'pending') {
        statusTitle.textContent = 'Profile Under Review';
        statusMessage.textContent = 'Your profile has been submitted and is waiting for admin approval.';
        statusIcon.innerHTML = '<i class="bi bi-hourglass-split fs-1 text-warning"></i>';
        profileStatus.classList.add('status-pending');
      } else if (adminStatus === 'approved') {
        statusTitle.textContent = 'Profile Approved';
        statusMessage.textContent = 'Your profile has been reviewed and approved.';
        statusIcon.innerHTML = '<i class="bi bi-check-circle fs-1 text-success"></i>';
        profileStatus.classList.add('status-approved');
      } else if (adminStatus === 'rejected') {
        statusTitle.textContent = 'Profile Needs Updates';
        const notes = status.adminUse.notes ? `: ${status.adminUse.notes}` : '';
        statusMessage.textContent = `Your profile has been reviewed and needs changes${notes}`;
        statusIcon.innerHTML = '<i class="bi bi-x-circle fs-1 text-danger"></i>';
        profileStatus.classList.add('status-rejected');
      } else {
        profileStatus.classList.add('hidden');
      }
    }

// Helper function to parse date string to Firebase timestamp
function parseDateString(dateStr) {
  if (!dateStr) return null;
  
  let date;
  
  // Try to handle both formats (YYYY-MM-DD from mobile or DD/MM/YYYY from desktop)
  if (dateStr.includes('-')) {
    // Mobile format (YYYY-MM-DD)
    date = new Date(dateStr);
  } else if (dateStr.includes('/')) {
    // Desktop format (DD/MM/YYYY)
    const parts = dateStr.split('/');
    if (parts.length === 3) {
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1; // Months are 0-based
      const year = parseInt(parts[2], 10);
      date = new Date(year, month, day);
    }
  } else {
    // Try direct parsing as fallback
    date = new Date(dateStr);
  }
  
  // Check if the date is valid
  if (date instanceof Date && !isNaN(date.getTime())) {
    return date;
  }
  
  return null;
}

saveAsDraftBtn.addEventListener('click', async () => {
  setButtonLoading('saveAsDraftBtn', true);
  
  try {
    logDebug('Saving profile as draft');
    
    // Get values from form
    const personalDetails = {
      DOB: parseDateString(document.getElementById('dob').value),
      emergencyContact: document.getElementById('emergencyContact').value
    };
    
    const driving = {
      c1Classification: document.getElementById('c1Classification').checked,
      dlNumber: document.getElementById('dlNumber').value,
      niNumber: document.getElementById('niNumber').value,
      points: document.getElementById('points').value
    };
    
    const medicalQualifications = {
      qualification: document.getElementById('qualification').value,
      hcpc: document.getElementById('hcpc').value,
      gmc: document.getElementById('gmc').value,
      nmc: document.getElementById('nmc').value,
      details: document.getElementById('details').value,
      certExpiry: parseDateString(document.getElementById('certExpiry').value)
    };
    
    logDebug('Saving personal details:', personalDetails);
    logDebug('Saving driving details:', driving);
    logDebug('Saving medical qualifications:', medicalQualifications);
    
    // Update each section separately
    await updatePersonalDetails(personalDetails);
    await updateDriving(driving);
    await updateMedicalQualifications(medicalQualifications);
    
    // Show alerts
    showAlert('Profile saved as draft successfully!', 'success');
    
    // Show inline confirmation
    const formActions = document.querySelector('.d-flex.justify-content-between.mb-5');
    showInlineConfirmation('Your profile has been saved as a draft!', formActions);
    
  } catch (error) {
    logDebug('Error saving draft:', error);
    console.error('Error saving draft:', error);
    showAlert('Error saving profile: ' + error.message, 'danger');
  } finally {
    setButtonLoading('saveAsDraftBtn', false);
  }
});

    // Submit Profile
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Validate form
      if (!profileForm.checkValidity()) {
        profileForm.reportValidity();
        return;
      }
      
      // Check if profile photo is uploaded (required)
      if (!profilePhotoURL.value) {
        showAlert('Please upload your profile photo. It is required.', 'warning');
        return;
      }
      
      const agreedToTerms = document.getElementById('agreedToTerms').checked;
      if (!agreedToTerms) {
        showAlert('You must agree to the terms before submitting.', 'warning');
        return;
      }
      
      setButtonLoading('submitProfileBtn', true);
      
      try {
        logDebug('Submitting profile form');
        
        // Check if this is a resubmission (edit) or a new submission
        const profile = await getCurrentUserProfile();
        const isResubmission = profile && profile.submission && profile.submission.submittedAt;
        logDebug('Is resubmission:', isResubmission);
        
        // Get values from form
        const updatedProfile = {
          personalDetails: {
            DOB: parseDateString(document.getElementById('dob').value),
            emergencyContact: document.getElementById('emergencyContact').value
          },
          driving: {
            c1Classification: document.getElementById('c1Classification').checked,
            dlNumber: document.getElementById('dlNumber').value,
            niNumber: document.getElementById('niNumber').value,
            points: document.getElementById('points').value
          },
          medicalQualifications: {
            qualification: document.getElementById('qualification').value,
            hcpc: document.getElementById('hcpc').value,
            gmc: document.getElementById('gmc').value,
            nmc: document.getElementById('nmc').value,
            details: document.getElementById('details').value,
            certExpiry: parseDateString(document.getElementById('certExpiry').value)
          },
          profilePhotoURL: profilePhotoURL.value
        };
        
        logDebug('Updated profile data:', updatedProfile);
        
        
if (isResubmission) {
  logDebug('Resubmitting profile');
  // Use the function for updating and resubmitting
  await updateAndResubmitProfile(updatedProfile);
  
  // Show alert message
  showAlert('Profile updated and resubmitted for review!', 'success');
  
  // Show inline confirmation with the dashboard return option
  const formActions = document.querySelector('.d-flex.justify-content-between.mb-5');
  showInlineConfirmation('Your profile has been updated and resubmitted!', formActions, true);
  
} else {
  logDebug('Submitting new profile');
  // First save all data as draft
  await updatePersonalDetails(updatedProfile.personalDetails);
  await updateDriving(updatedProfile.driving);
  await updateMedicalQualifications(updatedProfile.medicalQualifications);
  
  // Then submit the profile
  await submitProfile(true);
  
  // Show alert message
  showAlert('Profile submitted successfully! It will be reviewed by an administrator.', 'success');
  
  // Show inline confirmation with the dashboard return option
  const formActions = document.querySelector('.d-flex.justify-content-between.mb-5');
  showInlineConfirmation('Your profile has been submitted successfully!', formActions, true);
}
        
        
        
        
        // Update the status display with refreshed profile data
        logDebug('Getting refreshed profile data');
        const refreshedProfile = await getCurrentUserProfile();
        logDebug('Refreshed profile data:', refreshedProfile);
        updateProfileStatus(refreshedProfile);
        
        // Disable form again after submission
        if (isResubmission) {
          disableForm('pending');
        }
      } catch (error) {
        logDebug('Error submitting profile:', error);
        console.error('Error submitting profile:', error);
        showAlert('Error submitting profile: ' + error.message, 'danger');
      } finally {
        setButtonLoading('submitProfileBtn', false);
      }
    });

    // Logout handler
    logoutLink.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        showAlert('Logout failed: ' + error.message, 'danger');
      }
    });

    // Check authentication and load profile data
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      try {
        logDebug('User authenticated:', user.uid);
        
        // Check if user is admin
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().isAdmin === true) {
          adminNavItem.classList.remove('hidden');
          logDebug('User is admin, showing admin nav');
        }
        
        // Load profile data
        await loadUserProfile();
      } catch (error) {
        logDebug('Error checking user status:', error);
        console.error('Error checking user status:', error);
      }
    });

    // Enable debug panel for administrators (add ?debug=true to URL)
    if (window.location.search.includes('debug=true')) {
      debugPanel.style.display = 'block';
      logDebug('Debug mode activated');
    }
  </script>
</body>
</html>
