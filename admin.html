<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - FMS Prehospital Portal </title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; min-height:100vh; }
    .navbar { 
      background: linear-gradient(135deg, #00a896 0%, #028090 100%); 
      box-shadow:0 2px 10px rgba(0,0,0,0.1); 
    }
    .nav-link { 
      color: rgba(255,255,255,.85) !important;
      font-weight: 500;
    }
    .nav-link:hover { 
      color: #fff !important;
    }
    .admin-header { 
      background:linear-gradient(135deg,#00a896 0%,#028090 100%); 
      color:#fff; 
      border-radius:15px; 
      padding:40px; 
      margin:30px 0 20px 0; 
      box-shadow:0 10px 30px rgba(0,168,150,.3);
    }
    .admin-card {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,.08);
      padding: 30px;
      margin: 20px 0;
      transition: transform .3s, box-shadow .3s;
    }
    .admin-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
    }
    .admin-card-link {
      text-decoration: none;
      color: inherit;
      display: block;
    }
    .admin-icon {
      font-size: 3rem;
      color: #00a896;
      margin-bottom: 20px;
    }
    
    /* Danger card styling */
    .danger-card {
      background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
      border: 3px solid #dc3545;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(220,53,69,.15);
      padding: 30px;
      margin: 20px 0;
      transition: transform .3s, box-shadow .3s;
    }
    .danger-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(220,53,69,.25);
    }
    .danger-icon {
      font-size: 3rem;
      color: #dc3545;
      margin-bottom: 20px;
    }
    .danger-card h3 {
      color: #dc3545;
    }
    .danger-card .text-muted {
      color: #721c24 !important;
    }
    
    .unauthorized { text-align: center; padding: 60px 20px; }
    .hidden { display: none; }
    
    /* Clickable stat styling */
    .stat-clickable {
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 10px;
      border-radius: 10px;
    }
    .stat-clickable:hover {
      background: #f0f9f8;
      transform: scale(1.05);
    }
    .stat-clickable h3 {
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 4px;
    }
    
    /* Modal table styling */
    .member-table {
      font-size: 0.9rem;
    }
    .member-table th {
      background: #f8f9fa;
      position: sticky;
      top: 0;
    }
    .event-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin: 2px;
    }
    .event-badge.selected {
      background: #d1e7dd;
      color: #155724;
    }
    .event-badge.volunteered {
      background: #fff3cd;
      color: #856404;
    }
    .no-events {
      color: #6c757d;
      font-style: italic;
    }
    
    /* Super Admin locked card styling */
    .admin-card-link.locked {
      pointer-events: none;
      cursor: not-allowed;
    }
    .super-admin-pill {
      display: none;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: #dc3545;
      color: #fff;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-top: 8px;
      margin-bottom: 5px;
    }
    .admin-card-link.locked .super-admin-pill {
      display: inline-flex;
    }
    
    /* Newsflash card special styling */
    .newsflash-admin-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    .newsflash-admin-card .admin-icon {
      color: #fff;
    }
    .newsflash-admin-card h3,
    .newsflash-admin-card p,
    .newsflash-admin-card small {
      color: #fff !important;
    }
    .newsflash-admin-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }

    /* Newsflash editor styles */
    .newsflash-preview {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-top: 15px;
      min-height: 100px;
    }
    .newsflash-preview h5 {
      margin-bottom: 10px;
    }
    .editor-toolbar {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      padding: 8px;
    }
    .editor-toolbar .btn {
      padding: 4px 8px;
      font-size: 0.85rem;
    }
    #newsflashEditor {
      border-radius: 0 0 8px 8px;
      min-height: 200px;
    }
    .char-count {
      font-size: 0.8rem;
      color: #6c757d;
    }
    .last-updated {
      font-size: 0.85rem;
      color: #6c757d;
      font-style: italic;
    }

    /* Certificate expiry alert */
    .cert-expiry-alert {
      border-radius: 12px;
      border-left: 5px solid #00a896;
      background: #f0faf9;
      padding: 20px 25px;
      margin-bottom: 20px;
    }
    .cert-expiry-alert .alert-title {
      font-weight: 700;
      color: #028090;
      font-size: 1rem;
      margin-bottom: 12px;
    }
    .cert-expiry-table th {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6c757d;
      border-bottom: 2px solid #b2e4df;
    }
    .cert-expiry-table td {
      font-size: 0.9rem;
      vertical-align: middle;
    }
    .cert-expiry-grade {
      font-size: 0.8rem;
      color: #6c757d;
    }
    .cert-expiry-urgent {
      color: #dc3545;
      font-weight: 600;
    }
    .cert-expiry-warning {
      color: #028090;
      font-weight: 600;
    }
    .cert-event-badge {
      display: inline-block;
      background: #d1e7dd;
      color: #155724;
      font-size: 0.72rem;
      padding: 2px 7px;
      border-radius: 10px;
      margin-top: 4px;
      margin-right: 2px;
    }
    .cert-reminder-btn {
      background: linear-gradient(135deg, #00a896 0%, #028090 100%);
      color: #fff;
      border: none;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      letter-spacing: 0.03em;
    }
    .cert-reminder-btn:hover {
      opacity: 0.85;
      color: #fff;
    }
    .cert-reminder-btn:disabled {
      opacity: 0.6;
    }
    .cert-reminder-btn.btn-sent {
      background: linear-gradient(135deg, #028090 0%, #025f6b 100%);
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html"><i class="bi bi-shield-lock"></i> FMS Prehospital Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
     <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-house-fill"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="events.html">
              <i class="bi bi-calendar-event"></i> Events
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutLink">
              <i class="bi bi-box-arrow-right"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  <div class="container">
    <div id="unauthorizedMsg" class="hidden">
      <div class="unauthorized">
        <i class="bi bi-exclamation-triangle-fill" style="font-size: 4rem; color: #ffc107;"></i>
        <h3 class="mt-4">Unauthorized Access</h3>
        <p class="text-muted">You do not have permission to access this page.</p>
        <a href="dashboard.html" class="btn btn-primary mt-3">
          <i class="bi bi-arrow-left"></i> Return to Dashboard
        </a>
      </div>
    </div>
    <div class="row">
     <div id="adminContent" class="hidden">
      <div class="admin-header">
        <h1 class="mb-2"><i class="bi bi-shield-lock-fill"></i> Admin Dashboard</h1>
        <p class="mb-0">Manage system settings and user permissions</p>
      </div>

      <!-- Certificate Expiry Alert - only shown if members have certs expiring within 60 days -->
      <div id="certExpiryAlert" style="display:none;" class="cert-expiry-alert">
        <div class="alert-title"><i class="bi bi-exclamation-triangle-fill"></i> Certificate Expiry Warning</div>
        <p class="text-muted small mb-2">The following members have certificates that have expired or are expiring within the next 60 days:</p>
        <div class="table-responsive">
          <table class="table table-sm cert-expiry-table mb-0">
            <thead>
              <tr>
                <th>Member</th>
                <th>Expires</th>
                <th>Status</th>
                <th id="certActionHeader"></th>
              </tr>
            </thead>
            <tbody id="certExpiryTableBody">
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Row Title: People & Profiles -->
      <h5 class="mt-3 mb-2 text-muted"><i class="bi bi-person-vcard"></i> People & Profiles</h5>
      <div class="row">
        <div class="col-md-4 mb-4 d-flex">
          <a href="admin-profiles.html" class="admin-card-link super-admin-only w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-person-vcard-fill admin-icon"></i>
              <h3>Manage Profiles</h3>
              <span class="super-admin-pill"><i class="bi bi-lock-fill"></i> Super Admin Only</span>
              <p class="text-muted mb-0">Review submitted profiles</p>
              <small class="text-muted">Approve or reject profile submissions</small>
            </div>
          </a>
        </div>
        <div class="col-md-4 mb-4 d-flex">
          <a href="admin-applicants.html" class="admin-card-link super-admin-only w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-person-plus-fill admin-icon"></i>
              <h3>Applicants</h3>
              <span class="super-admin-pill"><i class="bi bi-lock-fill"></i> Super Admin Only</span>
              <p class="text-muted mb-0">Manage membership applications</p>
              <small class="text-muted">Review, approve and track new applicants</small>
            </div>
          </a>
        </div>
        <div class="col-md-4 mb-4 d-flex">
          <a href="team-management.html" class="admin-card-link super-admin-only w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-people-fill admin-icon"></i>
              <h3>Team Management</h3>
              <span class="super-admin-pill"><i class="bi bi-lock-fill"></i> Super Admin Only</span>
              <p class="text-muted mb-0">Manage teams</p>
              <small class="text-muted">Create, edit, and delete clinical/operational teams</small>
            </div>
          </a>
        </div>
      </div>

      <!-- Row Title: Teams & Events -->
      <h5 class="mt-3 mb-2 text-muted"><i class="bi bi-calendar-event"></i> Teams & Events</h5>
      <div class="row">
        <div class="col-md-4 mb-4 d-flex">
          <a href="team-assignment.html" class="admin-card-link w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-person-plus-fill admin-icon"></i>
              <h3>Team Assignment</h3>
              <p class="text-muted mb-0">Assign teams to members</p>
              <small class="text-muted">Manage which members belong to which teams</small>
            </div>
          </a>
        </div>
        <div class="col-md-4 mb-4 d-flex">
          <a href="event-management.html" class="admin-card-link w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-calendar-event-fill admin-icon"></i>
              <h3>Event Management</h3>
              <p class="text-muted mb-0">Manage volunteer events</p>
              <small class="text-muted">Create events and manage volunteer registrations</small>
            </div>
          </a>
        </div>
        <div class="col-md-4 mb-4 d-flex">
          <a href="admin-event-report.html" class="admin-card-link w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-clipboard-data admin-icon"></i>
              <h3>Member Events Report</h3>
              <p class="text-muted mb-0">View member event activity</p>
              <small class="text-muted">See who has volunteered and been selected this year</small>
            </div>
          </a>
        </div>
      </div>

      <!-- Row Title: Member Tools -->
      <h5 class="mt-3 mb-2 text-muted"><i class="bi bi-tools"></i> Member Tools</h5>
      <div class="row">
        <div class="col-md-4 mb-4 d-flex">
          <a href="search-members.html" class="admin-card-link w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-search admin-icon"></i>
              <h3>Member Search</h3>
              <p class="text-muted mb-0">Find and view member details</p>
              <small class="text-muted">Search members by name or email and view their information</small>
            </div>
          </a>
        </div>
        <div class="col-md-4 mb-4 d-flex">
          <a href="admin-member-hours.html" class="admin-card-link w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-clock-history admin-icon"></i>
              <h3>Member Hours</h3>
              <p class="text-muted mb-0">Track volunteer hours by year</p>
              <small class="text-muted">View hours assigned to members from event rotas</small>
            </div>
          </a>
        </div>
        <div class="col-md-4 mb-4 d-flex">
          <a href="admin-downloads.html" class="admin-card-link w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-cloud-download admin-icon"></i>
              <h3>Downloads</h3>
              <p class="text-muted mb-0">Export portal data</p>
              <small class="text-muted">Generate reports and data exports</small>
            </div>
          </a>
        </div>
      </div>

      <!-- Row Title: System & Access -->
      <h5 class="mt-3 mb-2 text-muted"><i class="bi bi-gear"></i> System & Access</h5>
      <div class="row">
        <div class="col-md-4 mb-4 d-flex">
          <a href="admin-allowed-emails.html" class="admin-card-link super-admin-only w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-envelope-check-fill admin-icon"></i>
              <h3>Allowed Emails</h3>
              <span class="super-admin-pill"><i class="bi bi-lock-fill"></i> Super Admin Only</span>
              <p class="text-muted mb-0">Manage registration whitelist</p>
              <small class="text-muted">Add, view, or remove allowed email addresses</small>
            </div>
          </a>
        </div>
        <div class="col-md-4 mb-4 d-flex">
          <a href="admin-user-management.html" class="admin-card-link super-admin-only w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-people-fill admin-icon"></i>
              <h3>Admin Users</h3>
              <span class="super-admin-pill"><i class="bi bi-lock-fill"></i> Super Admin Only</span>
              <p class="text-muted mb-0">Manage administrator permissions</p>
              <small class="text-muted">Grant or revoke admin access</small>
            </div>
          </a>
        </div>
        <div class="col-md-4 mb-4 d-flex">
          <div class="admin-card text-center newsflash-admin-card super-admin-only h-100 w-100" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#newsflashModal">
            <i class="bi bi-megaphone-fill admin-icon"></i>
            <h3>Manage Newsflash</h3>
            <span class="super-admin-pill"><i class="bi bi-lock-fill"></i> Super Admin Only</span>
            <p class="mb-0">Edit dashboard announcement</p>
            <small>Update the newsflash message shown to all members</small>
          </div>
        </div>
      </div>

      <!-- Row Title: Communications -->
      <h5 class="mt-3 mb-2 text-muted"><i class="bi bi-envelope-paper"></i> Communications</h5>
      <div class="row">
        <div class="col-md-4 mb-4 d-flex">
          <a href="admin-email-members.html" class="admin-card-link super-admin-only w-100">
            <div class="admin-card text-center h-100">
              <i class="bi bi-envelope-paper admin-icon"></i>
              <h3>Email All Members</h3>
              <span class="super-admin-pill"><i class="bi bi-lock-fill"></i> Super Admin Only</span>
              <p class="text-muted mb-0">Send bulk emails to members</p>
              <small class="text-muted">Contact all approved members at once</small>
            </div>
          </a>
        </div>
      </div>




      <!-- Quick Stats -->
      <div class="row">
        <div class="col-md-12">
          <div class="admin-card">
            <h4 class="mb-3"><i class="bi bi-info-circle-fill"></i> Quick Stats</h4>
            <div class="row text-center">
              <div class="col-md-4 mb-3">
                <h2 class="text-primary" id="totalUsers">-</h2>
                <p class="text-muted mb-0">Total Profiles Added</p>
              </div>
              <div class="col-md-4 mb-3">
                <h2 class="text-success" id="totalAdmins">-</h2>
                <p class="text-muted mb-0">Admin Users</p>
              </div>
              <div class="col-md-4 mb-3">
                <h2 class="text-info" id="allowedEmailsCount">-</h2>
                <p class="text-muted mb-0">Allowed Emails</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Qualification Stats -->
      <div class="row">
        <div class="col-md-12">
          <div class="admin-card">
            <h4 class="mb-3"><i class="bi bi-mortarboard-fill"></i> Approved Members by Qualification</h4>
            <p class="text-muted small mb-3"><i class="bi bi-hand-index"></i> Click on a number to view members with that qualification</p>
            <div id="qualificationStatsLoading" class="text-center py-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <div id="qualificationStatsContainer" class="row text-center" style="display: none;">
              <!-- Stats will be dynamically inserted here -->
            </div>
            <div id="noQualificationStats" class="text-center text-muted py-3" style="display: none;">
              <i class="bi bi-info-circle"></i> No approved members found
            </div>
          </div>
        </div>
      </div>

      <!-- DANGER ZONE - Delete Profile -->
      <div class="row">
        <div class="col-md-12 mb-4">
          <a href="admin-delete-profile.html" class="admin-card-link super-admin-only">
            <div class="danger-card text-center">
              <i class="bi bi-exclamation-octagon-fill danger-icon"></i>
              <h3>⚠️ Delete Member Profile</h3>
              <span class="super-admin-pill"><i class="bi bi-lock-fill"></i> Super Admin Only</span>
              <p class="text-muted mb-0">DANGER: Permanently remove members</p>
              <small class="text-muted">Delete user accounts, profiles, and all associated data</small>
              <div class="mt-3">
                <span class="badge bg-danger">IRREVERSIBLE ACTION</span>
              </div>
            </div>
          </a>
        </div>
      </div>

    </div>
  </div>
  </div>
  
  <!-- Newsflash Editor Modal -->
  <div class="modal fade" id="newsflashModal" tabindex="-1" aria-labelledby="newsflashModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff;">
          <h5 class="modal-title" id="newsflashModalLabel">
            <i class="bi bi-megaphone-fill"></i> Edit Dashboard Newsflash
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="newsflashAlertContainer"></div>
          
          <p class="text-muted mb-3">
            <i class="bi bi-info-circle"></i> This message appears on every member's dashboard. Use it for important announcements, updates, or reminders.
          </p>

          <!-- Editor Toolbar -->
          <div class="editor-toolbar">
            <div class="btn-group me-2">
              <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')" title="Bold">
                <i class="bi bi-type-bold"></i>
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')" title="Italic">
                <i class="bi bi-type-italic"></i>
              </button>
            </div>
            <div class="btn-group me-2">
              <button type="button" class="btn btn-outline-secondary" onclick="insertBreak()" title="Line Break">
                <i class="bi bi-text-wrap"></i> Break
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="insertParagraph()" title="New Paragraph">
                <i class="bi bi-text-paragraph"></i> Para
              </button>
            </div>
            <button type="button" class="btn btn-outline-secondary" onclick="clearFormatting()" title="Clear Formatting">
              <i class="bi bi-eraser"></i>
            </button>
          </div>

          <!-- Content Editor -->
          <textarea class="form-control" id="newsflashEditor" rows="8" placeholder="Enter your newsflash message here..."></textarea>
          
          <div class="d-flex justify-content-between align-items-center mt-2">
            <span class="char-count"><span id="charCount">0</span> characters</span>
            <span class="last-updated" id="lastUpdated"></span>
          </div>

          <!-- Preview -->
          <h6 class="mt-4 mb-2"><i class="bi bi-eye"></i> Preview</h6>
          <div class="newsflash-preview">
            <h5><i class="bi bi-megaphone-fill"></i> Newsflash</h5>
            <div id="newsflashPreview">
              <p><em>Start typing to see preview...</em></p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i> Cancel
          </button>
          <button type="button" class="btn btn-primary" id="saveNewsflashBtn">
            <i class="bi bi-check-lg"></i> Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>
  
  

  <!-- Qualification Members Modal -->
  <div class="modal fade" id="qualificationModal" tabindex="-1" aria-labelledby="qualificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="qualificationModalLabel">
            <i class="bi bi-people-fill"></i> Members - <span id="modalQualificationName"></span>
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="modalLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading member details...</p>
          </div>
          <div id="modalContent" style="display: none;">
            <div class="table-responsive">
              <table class="table table-hover member-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Grade</th>
                    <th>Email</th>
                    <th>Telephone</th>
                    <th>Events</th>
                  </tr>
                </thead>
                <tbody id="modalTableBody">
                  <!-- Member rows will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
          <div id="modalNoMembers" class="text-center text-muted py-4" style="display: none;">
            <i class="bi bi-info-circle"></i> No members found with this qualification
          </div>
        </div>
        <div class="modal-footer">
          <span id="modalMemberCount" class="me-auto text-muted"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, getDocs, query, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const logoutLink = document.getElementById('logoutLink');
    const adminContent = document.getElementById('adminContent');
    const unauthorizedMsg = document.getElementById('unauthorizedMsg');
    
    // Modal elements
    const qualificationModal = new bootstrap.Modal(document.getElementById('qualificationModal'));
    const modalQualificationName = document.getElementById('modalQualificationName');
    const modalLoading = document.getElementById('modalLoading');
    const modalContent = document.getElementById('modalContent');
    const modalNoMembers = document.getElementById('modalNoMembers');
    const modalTableBody = document.getElementById('modalTableBody');
    const modalMemberCount = document.getElementById('modalMemberCount');
    
    // Store data for modal lookups
    let allApprovedProfiles = [];
    let expiringMembers = []; // for cert reminder lookups
    let isSuperAdmin = false;
    let allUsers = {};
    let allEvents = {};
    let allVolunteers = [];
    
    
    // Newsflash editor elements
    const newsflashEditor = document.getElementById('newsflashEditor');
    const newsflashPreview = document.getElementById('newsflashPreview');
    const charCount = document.getElementById('charCount');
    const lastUpdated = document.getElementById('lastUpdated');
    const saveNewsflashBtn = document.getElementById('saveNewsflashBtn');
    const newsflashAlertContainer = document.getElementById('newsflashAlertContainer');

    // Load newsflash content when modal opens
    document.getElementById('newsflashModal').addEventListener('show.bs.modal', loadNewsflashContent);

    // Load existing newsflash content
    async function loadNewsflashContent() {
      try {
        const newsflashDoc = await getDoc(doc(db, 'settings', 'newsflash'));
        
        if (newsflashDoc.exists()) {
          const data = newsflashDoc.data();
          newsflashEditor.value = data.content || '';
          updatePreview();
          updateCharCount();
          
          if (data.updatedAt) {
            const date = data.updatedAt.toDate ? data.updatedAt.toDate() : new Date(data.updatedAt);
            lastUpdated.textContent = `Last updated: ${date.toLocaleDateString('en-GB')} at ${date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
            if (data.updatedBy) {
              lastUpdated.textContent += ` by ${data.updatedBy}`;
            }
          } else {
            lastUpdated.textContent = '';
          }
        } else {
          newsflashEditor.value = '';
          lastUpdated.textContent = 'No newsflash set yet';
        }
      } catch (error) {
        console.error('Error loading newsflash:', error);
        showNewsflashAlert('Error loading newsflash content', 'danger');
      }
    }

    // Update preview as user types
    newsflashEditor.addEventListener('input', () => {
      updatePreview();
      updateCharCount();
    });

    function updatePreview() {
      const content = newsflashEditor.value;
      if (!content.trim()) {
        newsflashPreview.innerHTML = '<p><em>Start typing to see preview...</em></p>';
        return;
      }
      const html = content
        .split('\n\n')
        .map(para => `<p>${para.replace(/\n/g, '<br>')}</p>`)
        .join('');
      newsflashPreview.innerHTML = html;
    }

    function updateCharCount() {
      charCount.textContent = newsflashEditor.value.length;
    }

 window.formatText = function(type) {
  const start = newsflashEditor.selectionStart;
  const end = newsflashEditor.selectionEnd;
  const selectedText = newsflashEditor.value.substring(start, end);
  let newText = '';
  if (type === 'bold') {
    newText = `<strong>${selectedText}</strong>`;
  } else if (type === 'italic') {
    newText = `<em>${selectedText}</em>`;
  }
  newsflashEditor.value = newsflashEditor.value.substring(0, start) + newText + newsflashEditor.value.substring(end);
  newsflashEditor.focus();
  updatePreview();
  updateCharCount();
};

    window.insertBreak = function() {
      const pos = newsflashEditor.selectionStart;
      newsflashEditor.value = newsflashEditor.value.substring(0, pos) + '\n' + newsflashEditor.value.substring(pos);
      newsflashEditor.focus();
      newsflashEditor.selectionStart = newsflashEditor.selectionEnd = pos + 1;
      updatePreview();
      updateCharCount();
    };

    window.insertParagraph = function() {
      const pos = newsflashEditor.selectionStart;
      newsflashEditor.value = newsflashEditor.value.substring(0, pos) + '\n\n' + newsflashEditor.value.substring(pos);
      newsflashEditor.focus();
      newsflashEditor.selectionStart = newsflashEditor.selectionEnd = pos + 2;
      updatePreview();
      updateCharCount();
    };

    window.clearFormatting = function() {
      newsflashEditor.value = newsflashEditor.value
        .replace(/\*\*(.*?)\*\*/g, '$1')
        .replace(/\*(.*?)\*/g, '$1');
      updatePreview();
      updateCharCount();
    };

    // Save newsflash
    saveNewsflashBtn.addEventListener('click', async () => {
      const content = newsflashEditor.value.trim();
      
      saveNewsflashBtn.disabled = true;
      saveNewsflashBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
      
      try {
        const user = auth.currentUser;
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const userName = userDoc.exists() ? `${userDoc.data().firstName} ${userDoc.data().surname}` : user.email;
        
        const contentHtml = content
          .split('\n\n')
          .map(para => `<p>${para.replace(/\n/g, '<br>')}</p>`)
          .join('');
        
        await setDoc(doc(db, 'settings', 'newsflash'), {
          content: content,
          contentHtml: contentHtml,
          updatedAt: serverTimestamp(),
          updatedBy: userName,
          updatedByUid: user.uid
        });
        
        showNewsflashAlert('Newsflash updated successfully!', 'success');
        lastUpdated.textContent = `Last updated: Just now by ${userName}`;
        
        setTimeout(() => {
          const modal = bootstrap.Modal.getInstance(document.getElementById('newsflashModal'));
          modal.hide();
        }, 1500);
        
      } catch (error) {
        console.error('Error saving newsflash:', error);
        showNewsflashAlert('Error saving newsflash: ' + error.message, 'danger');
      } finally {
        saveNewsflashBtn.disabled = false;
        saveNewsflashBtn.innerHTML = '<i class="bi bi-check-lg"></i> Save Changes';
      }
    });

    function showNewsflashAlert(message, type) {
      newsflashAlertContainer.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      if (type === 'success') {
        setTimeout(() => {
          const alert = newsflashAlertContainer.querySelector('.alert');
          if (alert) alert.remove();
        }, 3000);
      }
    }

    // Load certificate expiry alerts (members expiring within 60 days)
    async function loadCertExpiryAlerts() {
      try {
        const profilesSnapshot = await getDocs(collection(db, 'profiles'));
        const usersSnapshot = await getDocs(collection(db, 'users'));
        const usersMap = {};
        usersSnapshot.forEach(d => { usersMap[d.id] = d.data(); });

        const now = new Date();
        const in60Days = new Date();
        in60Days.setDate(in60Days.getDate() + 60);

        expiringMembers = [];
        const expiring = expiringMembers;

        profilesSnapshot.forEach(d => {
          const profile = d.data();
          const status = profile.adminUse?.status;

          // Only check approved members
          if (profile.adminUse?.status !== 'approved') return;

          const raw = profile.medicalQualifications?.certExpiry;
          if (!raw) return;

          // Handle Firestore Timestamp or date string
          // e.g. "16 February 2028 at 00:00:00 UTC" - remove the " at " so JS can parse it
          let expiryDate;
          if (raw.toDate) {
            expiryDate = raw.toDate();
            } else {
            const cleaned = typeof raw === 'string' ? raw.replace(' at ', ' ') : raw;
            expiryDate = new Date(cleaned);
            }

          if (isNaN(expiryDate.getTime())) return;
          if (expiryDate > in60Days) return; // only within 60 days window or already expired
          const isExpired = expiryDate < now;

          const user = usersMap[d.id] || {};
          const firstName = profile.personalDetails?.firstName || user.firstName || '';
          const surname = profile.personalDetails?.surname || user.surname || '';
          const fullName = `${firstName} ${surname}`.trim() || user.email || 'Unknown';

          const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));

          const grade = profile.medicalQualifications?.qualification || '';
          const memberEmail = (usersMap[d.id] || {}).email || '';
          const reminderCount = profile.adminUse?.certReminderCount || 0;

          // Get events this member has been selected for (using already-loaded data)
          const selectedEvents = allVolunteers
            .filter(v => v.userId === d.id && v.selected === true)
            .map(v => allEvents[v.eventId]?.name)
            .filter(Boolean);

          expiring.push({ fullName, firstName, surname, grade, selectedEvents, expiryDate, daysLeft, isExpired, email: memberEmail, userId: d.id, reminderCount });
        });

        if (expiring.length === 0) return;

        // Sort by soonest expiry first
        expiring.sort((a, b) => a.expiryDate - b.expiryDate);

        const tbody = document.getElementById('certExpiryTableBody');
        tbody.innerHTML = expiring.map(m => {
          const dateStr = m.expiryDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
          const cellClass = m.isExpired ? 'cert-expiry-urgent' : (m.daysLeft <= 14 ? 'cert-expiry-urgent' : 'cert-expiry-warning');
          const statusText = m.isExpired ? '<strong>EXPIRED</strong>' : `${m.daysLeft} day${m.daysLeft !== 1 ? 's' : ''}`;
          const btnLabel = m.reminderCount === 0 ? 'SEND REMINDER' : `SEND ${ordinal(m.reminderCount + 1)} REMINDER`;
          return `
            <tr id="cert-row-${m.userId}">
              <td>
                ${m.fullName}<br>
                <span class="cert-expiry-grade">${m.grade}</span>
                ${m.selectedEvents && m.selectedEvents.length > 0
                  ? '<br>' + m.selectedEvents.map(e => `<span class="cert-event-badge"><i class="bi bi-calendar-check-fill"></i> ${e}</span>`).join(' ')
                  : ''}
              </td>
              <td class="${cellClass}">${dateStr}</td>
              <td class="${cellClass}">${statusText}</td>
              ${isSuperAdmin ? `<td><button class="btn btn-sm cert-reminder-btn" id="btn-${m.userId}" onclick="sendCertReminder('${m.userId}')">${btnLabel}</button></td>` : ''}
            </tr>`;
        }).join('');

        document.getElementById('certExpiryAlert').style.display = 'block';

      } catch (error) {
        console.error('Error loading cert expiry alerts:', error);
      }
    }

    // Helper: ordinal suffix (1st, 2nd, 3rd, 4th...)
    function ordinal(n) {
      const s = ['th','st','nd','rd'];
      const v = n % 100;
      return n + (s[(v - 20) % 10] || s[v] || s[0]);
    }

    // Send a certificate renewal reminder email to a member
    window.sendCertReminder = async function(userId) {
      const member = expiringMembers.find(m => m.userId === userId);
      if (!member || !member.email) {
        alert('Could not find member email address.');
        return;
      }

      const btn = document.getElementById(`btn-${userId}`);
      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        const dateStr = member.expiryDate.toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' });

        const emailBody = `Dear ${member.firstName},\n\nYour ${member.grade}, in the name of ${member.firstName} ${member.surname}, expires on ${dateStr}, and this needs to be updated and uploaded to the FMS portal at https://portal.fmsprehospital.co.uk as soon as possible.\n\nIf you are unable to renew this, any places you have been offered at any event have to be withdrawn as we can only allow members with current certification to attend.\n\nPlease let us know if you are having any problems with renewing.\n\nMany thanks\nPrehospital Team Leaders\nprehospital@festival-medical.org`;

        // Send to the member
        await addDoc(collection(db, 'mail'), {
          to: member.email,
          replyTo: 'prehospital@festival-medical.org',
          message: {
            subject: 'Certificate Renewal Reminder - FMS Prehospital',
            text: emailBody,
            html: emailBody.replace(/\n/g, '<br>')
          }
        });

        // Send copy to prehospital team
        const copyBody = `[COPY - Reminder sent to ${member.fullName} (${member.email})]\n\n${emailBody}`;
        await addDoc(collection(db, 'mail'), {
          to: 'prehospital@festival-medical.org',
          message: {
            subject: `[COPY] Certificate Reminder - ${member.fullName}`,
            text: copyBody,
            html: copyBody.replace(/\n/g, '<br>')
          }
        });

        // Record the reminder count in Firestore
        const newCount = member.reminderCount + 1;
        await updateDoc(doc(db, 'profiles', userId), {
          'adminUse.certReminderCount': newCount,
          'adminUse.certReminderLastSent': serverTimestamp()
        });

        // Update local data and button label
        member.reminderCount = newCount;
        btn.disabled = false;
        btn.textContent = `SEND ${ordinal(newCount + 1)} REMINDER`;
        btn.classList.add('btn-sent');

      } catch (error) {
        console.error('Error sending cert reminder:', error);
        btn.disabled = false;
        btn.textContent = 'ERROR - Try Again';
        btn.classList.remove('btn-sent');
        btn.style.background = '#dc3545';
      }
    };

    // Load quick stats
    async function loadQuickStats() {
      try {
        // Get total users
        const usersSnapshot = await getDocs(collection(db, 'users'));
        document.getElementById('totalUsers').textContent = usersSnapshot.size;

        // Get admin users
        const adminQuery = query(collection(db, 'users'), where('isAdmin', '==', true));
        const adminSnapshot = await getDocs(adminQuery);
        document.getElementById('totalAdmins').textContent = adminSnapshot.size;

        // Get allowed emails count
        const allowedEmailsSnapshot = await getDocs(collection(db, 'allowedEmails'));
        document.getElementById('allowedEmailsCount').textContent = allowedEmailsSnapshot.size;
      } catch (error) {
        console.error('Error loading quick stats:', error);
      }
    }

    // Load qualification stats for approved members
    async function loadQualificationStats() {
      const container = document.getElementById('qualificationStatsContainer');
      const loading = document.getElementById('qualificationStatsLoading');
      const noStats = document.getElementById('noQualificationStats');
      
      try {
        // Get all profiles
        const profilesSnapshot = await getDocs(collection(db, 'profiles'));
        
        // Get all users for later use
        const usersSnapshot = await getDocs(collection(db, 'users'));
        usersSnapshot.forEach(doc => {
          allUsers[doc.id] = doc.data();
        });
        
        // Get all events for later use
        const eventsSnapshot = await getDocs(collection(db, 'events'));
        eventsSnapshot.forEach(doc => {
          allEvents[doc.id] = { id: doc.id, ...doc.data() };
        });
        
        // Get all volunteer records for later use
        const volunteersSnapshot = await getDocs(collection(db, 'eventVolunteers'));
        volunteersSnapshot.forEach(doc => {
          allVolunteers.push({ id: doc.id, ...doc.data() });
        });
        
        // Count qualifications for approved members only
        const qualificationCounts = {};
        
        profilesSnapshot.forEach(doc => {
          const profile = doc.data();
          // Only count approved profiles
          if (profile.adminUse?.status === 'approved') {
            const qualification = profile.medicalQualifications?.qualification || 'Unknown';
            qualificationCounts[qualification] = (qualificationCounts[qualification] || 0) + 1;
            
            // Store profile for modal lookup
            allApprovedProfiles.push({
              userId: doc.id,
              ...profile
            });
          }
        });
        
        // Sort alphabetically by qualification name
        const sortedQualifications = Object.entries(qualificationCounts)
          .sort((a, b) => a[0].localeCompare(b[0]));
        
        // Hide loading
        loading.style.display = 'none';
        
        if (sortedQualifications.length === 0) {
          noStats.style.display = 'block';
          return;
        }
        
        // Generate HTML for each qualification
        let html = '';
        sortedQualifications.forEach(([qualification, count]) => {
          html += `
            <div class="col-md-3 col-sm-4 col-6 mb-3">
              <div class="stat-clickable" data-qualification="${qualification}" onclick="window.openQualificationModal('${qualification.replace(/'/g, "\\'")}')">
                <h3 class="text-primary">${count}</h3>
                <p class="text-muted mb-0 small">${qualification}</p>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        container.style.display = 'flex';
        container.style.flexWrap = 'wrap';
        
      } catch (error) {
        console.error('Error loading qualification stats:', error);
        loading.style.display = 'none';
        noStats.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error loading stats';
        noStats.style.display = 'block';
      }
    }

    // Open modal with members of a specific qualification
    window.openQualificationModal = async function(qualification) {
      // Show modal
      qualificationModal.show();
      
      // Reset modal state
      modalQualificationName.textContent = qualification;
      modalLoading.style.display = 'block';
      modalContent.style.display = 'none';
      modalNoMembers.style.display = 'none';
      modalTableBody.innerHTML = '';
      modalMemberCount.textContent = '';
      
      try {
        // Filter profiles by qualification
        const matchingProfiles = allApprovedProfiles.filter(p => 
          (p.medicalQualifications?.qualification || 'Unknown') === qualification
        );
        
        if (matchingProfiles.length === 0) {
          modalLoading.style.display = 'none';
          modalNoMembers.style.display = 'block';
          return;
        }
        
        // Build member data with events
        const members = matchingProfiles.map(profile => {
          const user = allUsers[profile.userId] || {};
          const firstName = profile.personalDetails?.firstName || user.firstName || '';
          const surname = profile.personalDetails?.surname || user.surname || '';
          const fullName = `${firstName} ${surname}`.trim() || 'Unknown';
          
          // Get events for this user
          const userVolunteers = allVolunteers.filter(v => v.userId === profile.userId);
          const events = userVolunteers.map(v => {
            const event = allEvents[v.eventId];
            return event ? {
              name: event.name || 'Unknown Event',
              selected: v.selected === true
            } : null;
          }).filter(e => e !== null);
          
          return {
            fullName,
            grade: profile.medicalQualifications?.qualification || 'N/A',
            email: user.email || profile.personalDetails?.email || 'N/A',
            telephone: user.mobile || profile.personalDetails?.phone || 'N/A',
            events
          };
        });
        
        // Sort by name
        members.sort((a, b) => a.fullName.localeCompare(b.fullName));
        
        // Build table HTML
        let tableHtml = '';
        members.forEach(member => {
          let eventsHtml = '<span class="no-events">No events</span>';
          if (member.events.length > 0) {
            eventsHtml = member.events.map(e => {
              const badgeClass = e.selected ? 'selected' : 'volunteered';
              const icon = e.selected ? 'check-circle-fill' : 'hourglass-split';
              return `<span class="event-badge ${badgeClass}"><i class="bi bi-${icon}"></i> ${e.name}</span>`;
            }).join('');
          }
          
          tableHtml += `
            <tr>
              <td><strong>${member.fullName}</strong></td>
              <td>${member.grade}</td>
              <td><a href="mailto:${member.email}">${member.email}</a></td>
              <td>${member.telephone}</td>
              <td>${eventsHtml}</td>
            </tr>
          `;
        });
        
        modalTableBody.innerHTML = tableHtml;
        modalMemberCount.textContent = `${members.length} member${members.length !== 1 ? 's' : ''} found`;
        
        // Show content
        modalLoading.style.display = 'none';
        modalContent.style.display = 'block';
        
      } catch (error) {
        console.error('Error loading members:', error);
        modalLoading.style.display = 'none';
        modalNoMembers.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error loading members';
        modalNoMembers.style.display = 'block';
      }
    };

    logoutLink.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        alert('Logout failed: ' + error.message);
      }
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().isAdmin === true) {
          adminContent.classList.remove('hidden');
          unauthorizedMsg.classList.add('hidden');
          loadQuickStats();
          loadQualificationStats().then(() => loadCertExpiryAlerts());
          
          // Check for super admin access
          const userData = userDoc.data();
          const superAdminCards = document.querySelectorAll('.super-admin-only');
          
          if (userData.isSuperAdmin === true) {
            // Super admin - unlock all cards and enable cert reminder buttons
            isSuperAdmin = true;
            const certHeader = document.getElementById('certActionHeader');
            if (certHeader) certHeader.textContent = 'Action';
            superAdminCards.forEach(card => {
              card.classList.remove('locked');
            });
          } else {
            // Regular admin - lock super admin cards
            superAdminCards.forEach(card => {
              card.classList.add('locked');
            });
          }
        } else {
          adminContent.classList.add('hidden');
          unauthorizedMsg.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error checking admin status:', error);
        adminContent.classList.add('hidden');
        unauthorizedMsg.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>