<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Assignment - FMS Prehospital Portal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .member-card {
      border-radius: 10px;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
      margin-bottom: 20px;
    }
    
    .member-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .member-details {
      flex-grow: 1;
    }
    
    .member-info {
      display: flex;
      gap: 15px;
      align-items: flex-start;
    }
    
    .profile-pic-container {
      width: 60px;
      height: 60px;
      flex-shrink: 0;
    }
    
    .profile-pic {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      background-color: #e9ecef;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #adb5bd;
      font-size: 24px;
    }
    
    .team-badge {
      display: inline-block;
      background-color: #e9ecef;
      color: #495057;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    
    .member-teams {
      margin-top: 10px;
    }
    
    .search-container {
      position: relative;
      margin-bottom: 20px;
    }
    
    .search-container .form-control {
      padding-left: 40px;
    }
    
    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
      z-index: 10;
    }
    
    .btn-loading {
      position: relative;
      color: transparent !important;
    }
    
    .btn-loading:after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: calc(50% - 8px);
      left: calc(50% - 8px);
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spinner 0.6s linear infinite;
    }
    
    @keyframes spinner { to { transform: rotate(360deg); } }
    
    .hidden {
      display: none !important;
    }
    
    /* Team matrix styles */
    .team-matrix {
      overflow-x: auto;
      margin-top: 20px;
    }
    
    .matrix-table {
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .matrix-table th {
      position: sticky;
      top: 0;
      background-color: #f8f9fa;
      z-index: 10;
      font-weight: 600;
      text-align: center;
      padding: 10px 5px;
    }
    
    .matrix-table th.rotated {
      height: 140px;
      white-space: nowrap;
      border-bottom: 1px solid #dee2e6;
      position: relative;
    }
    
    .matrix-table th.rotated > div {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%) rotate(-90deg);
      transform-origin: bottom center;
      width: 30px;
      padding-bottom: 5px;
    }
    
    .matrix-table td {
      text-align: center;
      padding: 10px 5px;
      border-bottom: 1px solid #dee2e6;
    }
    
    .matrix-table td:first-child {
      text-align: left;
      font-weight: 500;
      position: sticky;
      left: 0;
      background-color: #fff;
      z-index: 5;
      min-width: 200px;
      padding-left: 10px;
    }
    
    .matrix-table tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .matrix-table tbody tr:hover td:first-child {
      background-color: #f8f9fa;
    }
    
    .matrix-table .team-checkbox {
      width: 18px;
      height: 18px;
    }
    
    .grade-select {
      width: 100%;
      font-size: 14px;
    }
    
    /* Status badges */
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
      margin-left: 8px;
    }
    
    .status-badge-success {
      background-color: #d1e7dd;
      color: #0a3622;
    }
    
    .status-badge-warning {
      background-color: #fff3cd;
      color: #664d03;
    }
    
    .status-badge-info {
      background-color: #cff4fc;
      color: #055160;
    }
    
    /* Filter controls */
    .filter-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-label {
      font-weight: 500;
      margin-bottom: 0;
      white-space: nowrap;
    }
    
    .filter-select {
      min-width: 180px;
    }
    
    /* Save indicator */
    .save-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: rgba(255,255,255,0.9);
      border-radius: 8px;
      padding: 10px 15px;
      box-shadow: 0 2px 15px rgba(0,0,0,0.2);
      z-index: 1000;
      display: none;
    }
    
    .save-indicator.active {
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="dashboard.html">FMS Prehospital Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          
          <li class="nav-item">
            <a class="nav-link" href="admin.html">
              <i class="bi bi-arrow-left"></i> Admin Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-house-fill"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="team-management.html">
              <i class="bi bi-people-fill"></i> Team Management
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutLink">
              <i class="bi bi-box-arrow-right"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="page-header">
      <h1 class="mb-2"><i class="bi bi-person-plus-fill"></i> Team Assignment</h1>
      <p class="mb-0">Assign members to clinical or operational teams</p>
    </div>

    <div id="alertContainer"></div>

    <div class="admin-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="bi bi-people"></i> Member Team Assignment</h3>
        <button class="btn btn-primary" id="saveAllChangesBtn">
          <i class="bi bi-save"></i> Save All Changes
        </button>
      </div>
      
      <div class="row">
        <div class="col-md-6 col-lg-4">
          <div class="search-container">
            <i class="bi bi-search search-icon"></i>
            <input type="text" id="searchInput" class="form-control" placeholder="Search members by name or email...">
          </div>
        </div>
        <div class="col-md-6 col-lg-8">
          <div class="filter-controls">
            <span class="filter-label">Filter by:</span>
            <select class="form-select form-select-sm filter-select" id="teamFilter">
              <option value="all">All Teams</option>
              <!-- Team options will be populated dynamically -->
            </select>
            <select class="form-select form-select-sm filter-select" id="gradeFilter">
              <option value="all">All Grades</option>
              <!-- Grade options will be populated dynamically -->
            </select>
            <button class="btn btn-sm btn-outline-secondary" id="clearFiltersBtn">
              <i class="bi bi-x-circle"></i> Clear Filters
            </button>
          </div>
        </div>
      </div>

      <div id="membersContainer">
        <div id="loadingMembers" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading members...</p>
        </div>
        
        <div id="noMembersMessage" class="alert alert-info hidden">
          <i class="bi bi-info-circle"></i> No members found. Add users to the portal first.
        </div>
        
        <!-- Team Matrix View -->
        <div id="teamMatrix" class="team-matrix hidden">
          <table class="table matrix-table" id="matrixTable">
            <thead>
              <tr id="tableHeader">
                <th>Member</th>
                <th>Clinical Grade</th>
                <!-- Team headers will be added dynamically -->
              </tr>
            </thead>
            <tbody id="matrixBody">
              <!-- Members and their team assignments will be added dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Save Indicator -->
  <div class="save-indicator" id="saveIndicator">
    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
    <span>Saving changes...</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      collection, 
      getDocs, 
      updateDoc,
      arrayUnion,
      arrayRemove
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { firebaseConfig } from './firebase-config.js';
    import { getAllTeams } from './teams-service.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const teamFilter = document.getElementById('teamFilter');
    const gradeFilter = document.getElementById('gradeFilter');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    const saveAllChangesBtn = document.getElementById('saveAllChangesBtn');
    const loadingMembers = document.getElementById('loadingMembers');
    const noMembersMessage = document.getElementById('noMembersMessage');
    const teamMatrix = document.getElementById('teamMatrix');
    const tableHeader = document.getElementById('tableHeader');
    const matrixBody = document.getElementById('matrixBody');
    const alertContainer = document.getElementById('alertContainer');
    const logoutLink = document.getElementById('logoutLink');
    const saveIndicator = document.getElementById('saveIndicator');

    // Clinical grades list
    const clinicalGrades = [
      "AAP",
      "Doctor",
      "Doctor (Critical Care/BASICS/Merit)",
      "Doctor (with FREC/PHTLS or similar)",
      "EAA",
      "ECA",
      "FREC 3 (or similar level 3 certification)",
      "FREC 4",
      "Nurse",
      "Nurse (Ambulance Nurse)",
      "Nurse (with FREC/PHTLS or similar)",
      "Paramedic",
      "Paramedic (Critical care)",
      "Paramedic (CTM/OO)",
      "Paramedic (HART)",
      "Paramedic (in Primary Care)",
      "Paramedic (Specialist)",
      "PHTLS",
      "Student Paramedic (Year 2)",
      "Student Paramedic (Year 3)",
      "Technician",
      "None (Non-clinical)",
      "Other"
    ];

    // Store all members and teams
    let allMembers = [];
    let filteredMembers = [];
    let allTeams = [];
    let pendingUpdates = new Map(); // Map to store pending updates before saving

    // Set button loading state
    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.classList.add('btn-loading');
        button.disabled = true;
      } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    // Show alert message
    function showAlert(message, type) {
      const html = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      alertContainer.innerHTML = html;
      
      if (type === 'success') {
        setTimeout(() => {
          const alert = document.querySelector('.alert');
          if (alert) {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
          }
        }, 5000);
      }
    }

    // Show/hide save indicator
    function toggleSaveIndicator(show) {
      if (show) {
        saveIndicator.classList.add('active');
      } else {
        saveIndicator.classList.remove('active');
      }
    }

    // Load all members and teams
    async function loadData() {
      try {
        teamMatrix.classList.add('hidden');
        loadingMembers.classList.remove('hidden');
        noMembersMessage.classList.add('hidden');
        
        // Load all teams first
        allTeams = await getAllTeams();
        
        // Populate team filter dropdown
        teamFilter.innerHTML = '<option value="all">All Teams</option>';
        for (const team of allTeams) {
          teamFilter.innerHTML += `<option value="${team.id}">${team.name}</option>`;
        }
        
        // Populate grade filter dropdown
        gradeFilter.innerHTML = '<option value="all">All Grades</option>';
        for (const grade of clinicalGrades) {
          gradeFilter.innerHTML += `<option value="${grade}">${grade}</option>`;
        }
        
        // Load all users
        const usersSnapshot = await getDocs(collection(db, 'users'));
        
        allMembers = [];
        usersSnapshot.forEach(doc => {
          // Initialize the clinical grade field if it doesn't exist
          const userData = doc.data();
          allMembers.push({
            id: doc.id,
            ...userData,
            clinicalGrade: userData.clinicalGrade || "None (Non-clinical)" // Default grade
          });
        });
        
        // Sort members by name
        allMembers.sort((a, b) => {
          const nameA = `${a.firstName} ${a.surname}`.toLowerCase();
          const nameB = `${b.firstName} ${b.surname}`.toLowerCase();
          return nameA.localeCompare(nameB);
        });
        
        // Apply any filters and create the matrix
        filterMembers();
        
      } catch (error) {
        console.error('Error loading data:', error);
        showAlert('Error loading data: ' + error.message, 'danger');
        loadingMembers.classList.add('hidden');
      }
    }

    // Filter members based on search input and filters
    function filterMembers() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const selectedTeam = teamFilter.value;
      const selectedGrade = gradeFilter.value;
      
      filteredMembers = allMembers.filter(member => {
        // Apply search filter
        const fullName = `${member.firstName} ${member.surname}`.toLowerCase();
        const email = member.email.toLowerCase();
        const matchesSearch = searchTerm === '' || fullName.includes(searchTerm) || email.includes(searchTerm);
        
        // Apply team filter
        const matchesTeam = selectedTeam === 'all' || 
          (member.teams && member.teams.includes(selectedTeam));
        
        // Apply grade filter
        const matchesGrade = selectedGrade === 'all' || 
          member.clinicalGrade === selectedGrade;
        
        return matchesSearch && matchesTeam && matchesGrade;
      });
      
      // Create the matrix view
      createMatrix();
    }

    // Create the team matrix
    function createMatrix() {
      if (filteredMembers.length === 0) {
        loadingMembers.classList.add('hidden');
        noMembersMessage.classList.remove('hidden');
        teamMatrix.classList.add('hidden');
        return;
      }
      
      // Clear existing header and add member and grade columns
      tableHeader.innerHTML = `
        <th style="min-width: 200px;">Member</th>
        <th style="min-width: 180px;">Clinical Grade</th>
      `;
      
      // Add team headers
      for (const team of allTeams) {
        tableHeader.innerHTML += `
          <th class="rotated">
            <div>${team.name}</div>
          </th>
        `;
      }
      
      // Clear existing body
      matrixBody.innerHTML = '';
      
      // Add member rows
      for (const member of filteredMembers) {
        const memberTeams = member.teams || [];
        const row = document.createElement('tr');
        row.dataset.memberId = member.id;
        
        // Member name and email
        row.innerHTML = `
          <td>
            <div class="fw-bold">${member.firstName} ${member.surname}</div>
            <div class="text-muted small">${member.email}</div>
          </td>
          <td>
            <select class="form-select form-select-sm grade-select" data-member-id="${member.id}">
              ${clinicalGrades.map(grade => 
                `<option value="${grade}" ${member.clinicalGrade === grade ? 'selected' : ''}>${grade}</option>`
              ).join('')}
            </select>
          </td>
        `;
        
        // Team checkboxes
        for (const team of allTeams) {
          const isInTeam = memberTeams.includes(team.id);
          row.innerHTML += `
            <td>
              <input type="checkbox" class="team-checkbox" 
                     data-member-id="${member.id}" 
                     data-team-id="${team.id}" 
                     ${isInTeam ? 'checked' : ''}>
            </td>
          `;
        }
        
        matrixBody.appendChild(row);
      }
      
      // Add event listeners to checkboxes and grade selects
      document.querySelectorAll('.team-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', handleTeamCheckboxChange);
      });
      
      document.querySelectorAll('.grade-select').forEach(select => {
        select.addEventListener('change', handleGradeSelectChange);
      });
      
      loadingMembers.classList.add('hidden');
      teamMatrix.classList.remove('hidden');
    }

    // Handle team checkbox change
    function handleTeamCheckboxChange(e) {
      const checkbox = e.target;
      const memberId = checkbox.dataset.memberId;
      const teamId = checkbox.dataset.teamId;
      const isChecked = checkbox.checked;
      
      // Update pending updates map
      if (!pendingUpdates.has(memberId)) {
        pendingUpdates.set(memberId, {
          teamChanges: new Map(),
          gradeChange: null
        });
      }
      
      pendingUpdates.get(memberId).teamChanges.set(teamId, isChecked);
      
      // Update the save button to show there are changes
      saveAllChangesBtn.innerHTML = '<i class="bi bi-save"></i> Save All Changes*';
      saveAllChangesBtn.classList.add('btn-warning');
    }

    // Handle grade select change
    function handleGradeSelectChange(e) {
      const select = e.target;
      const memberId = select.dataset.memberId;
      const selectedGrade = select.value;
      
      // Update pending updates map
      if (!pendingUpdates.has(memberId)) {
        pendingUpdates.set(memberId, {
          teamChanges: new Map(),
          gradeChange: null
        });
      }
      
      pendingUpdates.get(memberId).gradeChange = selectedGrade;
      
      // Update the save button to show there are changes
      saveAllChangesBtn.innerHTML = '<i class="bi bi-save"></i> Save All Changes*';
      saveAllChangesBtn.classList.add('btn-warning');
    }

    // Save all pending changes
    async function saveAllChanges() {
      if (pendingUpdates.size === 0) {
        showAlert('No changes to save.', 'info');
        return;
      }
      
      try {
        setButtonLoading(saveAllChangesBtn, true);
        toggleSaveIndicator(true);
        
        const updatePromises = [];
        
        for (const [memberId, changes] of pendingUpdates.entries()) {
          const memberRef = doc(db, 'users', memberId);
          const memberDoc = await getDoc(memberRef);
          
          if (!memberDoc.exists()) {
            console.error(`Member document ${memberId} does not exist`);
            continue;
          }
          
          const memberData = memberDoc.data();
          const currentTeams = memberData.teams || [];
          let updatedTeams = [...currentTeams];
          
          // Process team changes
          if (changes.teamChanges.size > 0) {
            for (const [teamId, isChecked] of changes.teamChanges.entries()) {
              if (isChecked && !updatedTeams.includes(teamId)) {
                // Add team
                updatedTeams.push(teamId);
              } else if (!isChecked && updatedTeams.includes(teamId)) {
                // Remove team
                updatedTeams = updatedTeams.filter(id => id !== teamId);
              }
            }
          }
          
          // Create update object
          const updateData = {
            teams: updatedTeams
          };
          
          // Add grade change if any
          if (changes.gradeChange !== null) {
            updateData.clinicalGrade = changes.gradeChange;
          }
          
          // Update member document
          updatePromises.push(updateDoc(memberRef, updateData));
          
          // Update local member data
          const memberIndex = allMembers.findIndex(m => m.id === memberId);
          if (memberIndex !== -1) {
            allMembers[memberIndex].teams = updatedTeams;
            if (changes.gradeChange !== null) {
              allMembers[memberIndex].clinicalGrade = changes.gradeChange;
            }
          }
        }
        
        await Promise.all(updatePromises);
        
        // Clear pending updates
        pendingUpdates.clear();
        
        // Reset save button
        saveAllChangesBtn.innerHTML = '<i class="bi bi-save"></i> Save All Changes';
        saveAllChangesBtn.classList.remove('btn-warning');
        
        showAlert('All changes saved successfully!', 'success');
      } catch (error) {
        console.error('Error saving changes:', error);
        showAlert('Error saving changes: ' + error.message, 'danger');
      } finally {
        setButtonLoading(saveAllChangesBtn, false);
        toggleSaveIndicator(false);
      }
    }

    // Event Listeners
    searchInput.addEventListener('input', filterMembers);
    teamFilter.addEventListener('change', filterMembers);
    gradeFilter.addEventListener('change', filterMembers);
    clearFiltersBtn.addEventListener('click', () => {
      searchInput.value = '';
      teamFilter.value = 'all';
      gradeFilter.value = 'all';
      filterMembers();
    });
    
    saveAllChangesBtn.addEventListener('click', saveAllChanges);
    
    logoutLink.addEventListener('click', async (e) => {
      e.preventDefault();
      if (pendingUpdates.size > 0) {
        if (confirm('You have unsaved changes. Are you sure you want to logout without saving?')) {
          await signOut(auth);
          window.location.href = 'index.html';
        }
      } else {
        await signOut(auth);
        window.location.href = 'index.html';
      }
    });

    // Check authentication and admin status
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (!userDoc.exists() || userDoc.data().isAdmin !== true) {
          alert('You do not have permission to access this page.');
          window.location.href = 'dashboard.html';
          return;
        }
        
        // Load data
        await loadData();
        
      } catch (error) {
        console.error('Error checking admin status:', error);
        showAlert('Error checking permissions: ' + error.message, 'danger');
      }
    });
    
    // Warn user before leaving with unsaved changes
    window.addEventListener('beforeunload', (e) => {
      if (pendingUpdates.size > 0) {
        e.preventDefault();
        e.returnValue = '';
        return '';
      }
    });
  </script>
</body>
</html>