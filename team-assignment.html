<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Assignment - FMS Prehospital Portal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/styles.css">
  <!-- Include the loader script -->
  <script src="loader.js"></script>
  <style>
   
   body { background:#f8f9fa; min-height:100vh; }
.navbar { 
  background:linear-gradient(135deg,#00a896 0%,#028090 100%); 
  box-shadow:0 2px 10px rgba(0,0,0,.1); 
}
.navbar .nav-link { 
  color: rgba(255,255,255,.85) !important;
  font-weight: 500;
}
.navbar .nav-link:hover { 
  color: #fff !important;
}
.navbar-brand {
  color: #fff !important;
}
.page-header { 
  background:linear-gradient(135deg,#00a896 0%,#028090 100%); 
  color:#fff; 
  border-radius:15px; 
  padding:30px; 
  margin:30px 0 20px 0;
  box-shadow: 0 10px 30px rgba(0,168,150,.3);
}
.admin-card { 
  background:#fff; 
  border-radius:15px; 
  box-shadow:0 5px 20px rgba(0,0,0,.08); 
  padding:30px; 
  margin:20px 0; 
}
.btn-primary {
  background: linear-gradient(135deg, #00a896 0%, #028090 100%);
  border: none;
  font-weight: 600;
  transition: transform .2s, box-shadow .2s;
}
.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,168,150,.4);
}
.member-card {
  border-radius: 10px;
  padding: 15px;
  background-color: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  margin-bottom: 15px;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.member-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.member-details {
  flex-grow: 1;
}

.member-info {
  display: flex;
  gap: 15px;
  align-items: flex-start;
}

.profile-pic-container {
  width: 50px;
  height: 50px;
  flex-shrink: 0;
}

.profile-pic {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  object-fit: cover;
  background-color: #e9ecef;
  display: flex;
  justify-content: center;
  align-items: center;
  color: #adb5bd;
  font-size: 20px;
}

.team-badge {
  display: inline-block;
  background-color: #e9ecef;
  color: #495057;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 4px;
  margin-right: 5px;
  margin-bottom: 5px;
}

.member-teams {
  margin-top: 8px;
}

/* UPDATED: Search container styles for proper icon alignment */
.search-container {
  margin-bottom: 20px;
}

.search-input-wrapper {
  position: relative;
}

.search-input-wrapper .form-control {
  padding-left: 40px;
}

.search-icon {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  color: #6c757d;
  z-index: 10;
  pointer-events: none;
}

.btn-loading {
  position: relative;
  color: transparent !important;
}

.btn-loading:after {
  content: '';
  position: absolute;
  width: 16px;
  height: 16px;
  top: calc(50% - 8px);
  left: calc(50% - 8px);
  border: 2px solid rgba(255,255,255,0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spinner 0.6s linear infinite;
}

@keyframes spinner { to { transform: rotate(360deg); } }

.nav-pills .nav-link {
  border-radius: 0.5rem;
  padding: 0.75rem 1.25rem;
  font-weight: 500;
  color: #00a896;
  transition: all 0.3s ease;
}

.nav-pills .nav-link.active {
  background-color: #00a896;
  color: white !important;
  box-shadow: 0 4px 10px rgba(0,168,150,0.3);
}

.option-content {
  padding: 20px 0;
}

.member-checkbox {
  width: 18px;
  height: 18px;
}

.form-check-input:checked {
  background-color: #00a896;
  border-color: #00a896;
}

.select-all-container {
  margin-bottom: 15px;
}

.status-pill {
  padding: 0.25rem 0.75rem;
  border-radius: 50px;
  font-size: 0.75rem;
  font-weight: 600;
}

.status-pending {
  background-color: #fff3cd;
  color: #856404;
}

.status-approved {
  background-color: #d4edda;
  color: #155724;
}

.status-rejected {
  background-color: #f8d7da;
  color: #721c24;
}

/* Make team selection modal scroll properly on mobile */
.team-select-container {
  max-height: 50vh; /* Use viewport height instead of fixed pixels */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch; /* For smoother scrolling on iOS */
}

/* Ensure modal body has proper mobile styling */
.modal-body {
  overflow-y: auto;
  max-height: calc(100vh - 200px); /* Adjust based on header/footer height */
}

.team-select-item {
  padding: 12px 8px;
  border-bottom: 1px solid #eee;
  display: flex;
  align-items: center;
}

.team-select-item:last-child {
  border-bottom: none;
}

.team-select-item .form-check {
  margin-bottom: 0;
}

.team-select-item label {
  margin-bottom: 0;
  width: 100%;
  cursor: pointer;
}

.bulk-action-bar {
  background-color: #f8f9fa;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.bulk-action-label {
  font-weight: 500;
}

.actions-column {
  display: flex;
  gap: 10px;
  align-items: center;
}

.refresh-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background-color: #00a896;
  color: white;
  display: flex;
  justify-content: center;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
  z-index: 1000;
  border: none;
}

.refresh-btn:hover {
  transform: rotate(30deg) translateY(-5px);
  background-color: #008f7e;
  box-shadow: 0 5px 15px rgba(0,168,150,0.4);
}

.refresh-btn i {
  font-size: 1.5rem;
}

.form-control:focus, .form-select:focus { 
  border-color: #00a896; 
  box-shadow: 0 0 0 0.2rem rgba(0,168,150,.25); 
}

.hidden { display: none; }

/* Page content transition */
.page-content {
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}
.page-content.loaded {
  opacity: 1;
}

/* NEW: Unassigned members button styling */
.unassigned-btn {
  margin-top: 10px;
}

.unassigned-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #dee2e6;
}

.unassigned-count {
  font-weight: 500;
  color: #6c757d;
}

  </style>
</head>
<body>
  <!-- Wrap all content in page-content div for transition -->
  <div class="page-content">
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="dashboard.html"><i class="bi bi-shield-lock"></i> FMS Prehospital Portal</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto">
            <li class="nav-item">
              <a class="nav-link" href="admin.html">
                <i class="bi bi-arrow-left"></i> Admin Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">
                <i class="bi bi-house-fill"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="events.html">
                <i class="bi bi-calendar-event"></i> Events
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="logoutLink">
                <i class="bi bi-box-arrow-right"></i> Logout
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="page-header">
        <h1 class="mb-2"><i class="bi bi-person-plus-fill"></i> Team Assignment</h1>
        <p class="mb-0">Assign members to clinical or operational teams</p>
      </div>

      <div id="alertContainer"></div>

      <div class="admin-card">
        <!-- Navigation Tabs -->
        <ul class="nav nav-pills mb-4" id="teamAssignmentTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="search-member-tab" data-bs-toggle="pill" data-bs-target="#search-member" type="button" role="tab">
              <i class="bi bi-search"></i> Search Member
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="by-grade-tab" data-bs-toggle="pill" data-bs-target="#by-grade" type="button" role="tab">
              <i class="bi bi-award"></i> By Clinical Grade
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="by-team-tab" data-bs-toggle="pill" data-bs-target="#by-team" type="button" role="tab">
              <i class="bi bi-people"></i> By Team
            </button>
          </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="teamAssignmentTabContent">
          <!-- Search Member Tab -->
          <div class="tab-pane fade show active" id="search-member" role="tabpanel">
            <div class="option-content">
              <!-- UPDATED: Wrapped input in search-input-wrapper for proper icon alignment -->
              <div class="search-container">
                <div class="search-input-wrapper">
                  <i class="bi bi-search search-icon"></i>
                  <input type="text" id="memberSearchInput" class="form-control" placeholder="Search by name or email (min. 3 characters)">
                </div>
                <div class="form-text">Type at least 3 characters to search for members</div>
              </div>
              
              <!-- NEW: Show Unassigned Members button -->
              <div class="unassigned-btn">
                <button class="btn btn-outline-secondary" id="showUnassignedBtn">
                  <i class="bi bi-person-exclamation"></i> Show Members Without Teams
                </button>
              </div>
              
              <div id="memberSearchResults"></div>
              
              <div id="memberSearchNoResults" class="alert alert-info hidden">
                <i class="bi bi-info-circle"></i> No members found matching your search.
              </div>
              
              <div id="memberSearchLoading" class="text-center py-3 hidden">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Searching members...</p>
              </div>
              
              <!-- NEW: Unassigned members results section -->
              <div id="unassignedMembersSection" class="hidden">
                <div class="unassigned-header">
                  <h5 class="mb-0"><i class="bi bi-person-exclamation text-warning"></i> Members Without Teams</h5>
                  <span class="unassigned-count" id="unassignedCount"></span>
                  <button class="btn btn-sm btn-outline-secondary" id="hideUnassignedBtn">
                    <i class="bi bi-x-lg"></i> Close
                  </button>
                </div>
                <div id="unassignedMembersList"></div>
              </div>
              
              <div id="unassignedMembersLoading" class="text-center py-3 hidden">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Loading unassigned members...</p>
              </div>
              
              <div id="noUnassignedMembers" class="alert alert-success hidden">
                <i class="bi bi-check-circle"></i> Great! All members have been assigned to at least one team.
              </div>
            </div>
          </div>
          
          <!-- By Grade Tab -->
          <div class="tab-pane fade" id="by-grade" role="tabpanel">
            <div class="option-content">
              <div class="row mb-4">
                <div class="col-md-6">
                  <label class="form-label">Select Clinical Grade</label>
                  <select class="form-select" id="gradeSelect">
                    <option value="">-- Select a grade --</option>
                    <!-- Grade options will be populated dynamically -->
                  </select>
                </div>
              </div>
              
              <div id="gradeMembers" class="hidden">
                <div class="bulk-action-bar">
                  <div>
                    <span class="bulk-action-label" id="selectedMembersCount">0 members selected</span>
                  </div>
                  <button class="btn btn-primary" id="assignSelectedBtn" disabled>
                    <i class="bi bi-people"></i> Assign to Team(s)
                  </button>
                </div>
                
                <div class="select-all-container">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllMembers">
                    <label class="form-check-label" for="selectAllMembers">
                      Select All
                    </label>
                  </div>
                </div>
                
                <div id="gradeMembersList">
                  <!-- Member cards will be populated dynamically -->
                </div>
              </div>
              
              <div id="noGradeMembers" class="alert alert-info hidden">
                <i class="bi bi-info-circle"></i> No members found with the selected grade.
              </div>
              
              <div id="gradeMembersLoading" class="text-center py-3 hidden">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Loading members...</p>
              </div>
            </div>
          </div>
          
          <!-- By Team Tab -->
          <div class="tab-pane fade" id="by-team" role="tabpanel">
            <div class="option-content">
              <div class="row mb-4">
                <div class="col-md-6">
                  <label class="form-label">Select Team</label>
                  <select class="form-select" id="teamSelect">
                    <option value="">-- Select a team --</option>
                    <!-- Team options will be populated dynamically -->
                  </select>
                </div>
              </div>
              
              <div id="teamMembers" class="hidden">
                <div id="teamMembersListContainer">
                  <!-- Member cards will be populated dynamically -->
                </div>
              </div>
              
              <div id="noTeamMembers" class="alert alert-info hidden">
                <i class="bi bi-info-circle"></i> No members found in the selected team.
              </div>
              
              <div id="teamMembersLoading" class="text-center py-3 hidden">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted">Loading team members...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Selection Modal -->
    <div class="modal fade" id="teamSelectionModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-people"></i> <span id="memberName"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p id="teamSelectionDescription"></p>
            <div class="team-select-container" id="teamSelectContainer">
              <!-- Teams will be populated dynamically -->
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveTeamsBtn">
              <i class="bi bi-check-lg"></i> Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Refresh Button (floating) -->
    <button class="refresh-btn" id="refreshDataBtn" title="Refresh Data">
      <i class="bi bi-arrow-clockwise"></i>
    </button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      collection, 
      getDocs,
      query,
      where, 
      updateDoc,
      arrayUnion,
      arrayRemove
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { firebaseConfig } from './firebase-config.js';
    import { getAllTeams, getUsersInTeam } from './teams-service.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM Elements - Search Tab
    const memberSearchInput = document.getElementById('memberSearchInput');
    const memberSearchResults = document.getElementById('memberSearchResults');
    const memberSearchNoResults = document.getElementById('memberSearchNoResults');
    const memberSearchLoading = document.getElementById('memberSearchLoading');
    
    // NEW: DOM Elements - Unassigned Members
    const showUnassignedBtn = document.getElementById('showUnassignedBtn');
    const hideUnassignedBtn = document.getElementById('hideUnassignedBtn');
    const unassignedMembersSection = document.getElementById('unassignedMembersSection');
    const unassignedMembersList = document.getElementById('unassignedMembersList');
    const unassignedMembersLoading = document.getElementById('unassignedMembersLoading');
    const noUnassignedMembers = document.getElementById('noUnassignedMembers');
    const unassignedCount = document.getElementById('unassignedCount');
    
    // DOM Elements - By Grade Tab
    const gradeSelect = document.getElementById('gradeSelect');
    const gradeMembers = document.getElementById('gradeMembers');
    const gradeMembersList = document.getElementById('gradeMembersList');
    const noGradeMembers = document.getElementById('noGradeMembers');
    const gradeMembersLoading = document.getElementById('gradeMembersLoading');
    const selectAllMembers = document.getElementById('selectAllMembers');
    const selectedMembersCount = document.getElementById('selectedMembersCount');
    const assignSelectedBtn = document.getElementById('assignSelectedBtn');
    
    // DOM Elements - By Team Tab
    const teamSelect = document.getElementById('teamSelect');
    const teamMembers = document.getElementById('teamMembers');
    const teamMembersListContainer = document.getElementById('teamMembersListContainer');
    const noTeamMembers = document.getElementById('noTeamMembers');
    const teamMembersLoading = document.getElementById('teamMembersLoading');
    
    // DOM Elements - Modals and General
    const teamSelectionModal = new bootstrap.Modal(document.getElementById('teamSelectionModal'));
    const teamSelectionDescription = document.getElementById('teamSelectionDescription');
    const memberName = document.getElementById('memberName');
    const teamSelectContainer = document.getElementById('teamSelectContainer');
    const saveTeamsBtn = document.getElementById('saveTeamsBtn');
    const alertContainer = document.getElementById('alertContainer');
    const logoutLink = document.getElementById('logoutLink');
    const refreshDataBtn = document.getElementById('refreshDataBtn');
    
    // Tab elements for reference
    const searchTab = document.getElementById('search-member-tab');
    const gradeTab = document.getElementById('by-grade-tab');
    const teamTab = document.getElementById('by-team-tab');

    // Function to show page content
    function showPageContent() {
      document.querySelector('.page-content').classList.add('loaded');
      if (window.fmsLoader && window.fmsLoader.hide) {
        window.fmsLoader.hide();
      }
    }

    // Store data
    let allMembers = [];
    let allTeams = [];
    let profilesMap = new Map(); // Store profiles by user ID for quick lookup
    let selectedMemberIds = []; // For bulk assignment
    let currentMemberId = null; // For single member assignment
    let currentMemberTeams = [];
    let bulkAssignmentMode = false;
    let lastSearchTerm = '';
    let lastGradeSelection = '';
    let lastTeamSelection = '';

    // Set button loading state
    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.classList.add('btn-loading');
        button.disabled = true;
      } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    // Show alert
    function showAlert(message, type = 'info') {
      const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
      alertContainer.innerHTML = alertHtml;
      
      // Auto-dismiss success alerts after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          const alert = alertContainer.querySelector('.alert');
          if (alert) {
            alert.remove();
          }
        }, 5000);
      }
    }

    // Get team badges HTML
    function getTeamBadgesHtml(teamIds) {
      if (!teamIds || teamIds.length === 0) {
        return '<span class="text-muted small">No teams assigned</span>';
      }
      
      return teamIds.map(teamId => {
        const team = allTeams.find(t => t.id === teamId);
        return team ? `<span class="team-badge">${team.name}</span>` : '';
      }).join('');
    }

    // Load initial data (teams and members)
    async function loadInitialData() {
      setButtonLoading(refreshDataBtn, true);
      
      try {
        // Load all teams
        allTeams = await getAllTeams(db);
        
        // Populate team select dropdown
        teamSelect.innerHTML = '<option value="">-- Select a team --</option>';
        allTeams.forEach(team => {
          teamSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
        });
        
        // Load all approved members
        const usersRef = collection(db, 'users');
        const approvedQuery = query(usersRef, where('profileStatus', '==', 'approved'));
        const usersSnapshot = await getDocs(approvedQuery);
        
        allMembers = [];
        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          allMembers.push({
            id: doc.id,
            ...userData
          });
        });
        
        // Sort members by name
        allMembers.sort((a, b) => {
          const nameA = `${a.firstName} ${a.surname}`.toLowerCase();
          const nameB = `${b.firstName} ${b.surname}`.toLowerCase();
          return nameA.localeCompare(nameB);
        });
        
        // Get unique grades from members
        const uniqueGrades = new Set();
        allMembers.forEach(member => {
          if (member.clinicalGrade) {
            uniqueGrades.add(member.clinicalGrade);
          }
        });
        
        // Populate grade select
        gradeSelect.innerHTML = '<option value="">-- Select a grade --</option>';
        [...uniqueGrades].sort().forEach(grade => {
          gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
        });
        
        // Refresh current tab if needed
        if (searchTab.classList.contains('active') && lastSearchTerm.length >= 3) {
          searchMembers(false);
        } else if (gradeTab.classList.contains('active') && lastGradeSelection) {
          gradeSelect.value = lastGradeSelection;
          loadMembersByGrade(false);
        } else if (teamTab.classList.contains('active') && lastTeamSelection) {
          teamSelect.value = lastTeamSelection;
          loadMembersByTeam(false);
        }
        
      } catch (error) {
        console.error('Error loading initial data:', error);
        showAlert('Error loading data: ' + error.message, 'danger');
      } finally {
        setButtonLoading(refreshDataBtn, false);
      }
    }

    // Search members
    async function searchMembers(showLoading = true) {
      const searchTerm = memberSearchInput.value.trim().toLowerCase();
      lastSearchTerm = searchTerm;
      
      // Hide unassigned section when searching
      hideUnassignedMembers();
      
      // Require at least 3 characters
      if (searchTerm.length < 3) {
        memberSearchResults.innerHTML = '';
        memberSearchNoResults.classList.add('hidden');
        return;
      }
      
      if (showLoading) {
        memberSearchLoading.classList.remove('hidden');
      }
      memberSearchResults.innerHTML = '';
      memberSearchNoResults.classList.add('hidden');
      
      // Filter members based on search term
      const filteredMembers = allMembers.filter(member => {
        const fullName = `${member.firstName} ${member.surname}`.toLowerCase();
        const email = member.email.toLowerCase();
        
        return fullName.includes(searchTerm) || email.includes(searchTerm);
      });
      
      // Display results
      if (filteredMembers.length === 0) {
        memberSearchLoading.classList.add('hidden');
        memberSearchNoResults.classList.remove('hidden');
        return;
      }
      
      // Show results
      for (const member of filteredMembers) {
        const memberTeams = member.teams || [];
        
        // Create member card
        const memberCard = document.createElement('div');
        memberCard.className = 'member-card';
        memberCard.innerHTML = `
          <div class="member-info">
            <div class="member-details">
              <h5 class="mb-1">
                ${member.firstName} ${member.surname}
                <span class="status-pill status-${member.profileStatus} ms-2">
                  ${member.profileStatus.charAt(0).toUpperCase() + member.profileStatus.slice(1)}
                </span>
              </h5>
              <p class="text-muted mb-1">${member.email}</p>
              <div class="small">Grade: ${member.clinicalGrade || 'Not specified'}</div>
              <div class="member-teams">
                ${getTeamBadgesHtml(memberTeams)}
              </div>
            </div>
          </div>
          <div>
            <button class="btn btn-outline-primary btn-sm assign-teams-btn" data-member-id="${member.id}" data-member-name="${member.firstName} ${member.surname}">
              <i class="bi bi-people"></i> Assign Teams
            </button>
          </div>
        `;
        
        memberSearchResults.appendChild(memberCard);
      }
      
      // Add event listeners to assign buttons
      document.querySelectorAll('.assign-teams-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const memberId = btn.getAttribute('data-member-id');
          const memberFullName = btn.getAttribute('data-member-name');
          openTeamSelectionModal(memberId, memberFullName);
        });
      });
      
      memberSearchLoading.classList.add('hidden');
    }

    // NEW: Show unassigned members function
    async function showUnassignedMembers() {
      // Clear search results and hide other sections
      memberSearchInput.value = '';
      lastSearchTerm = '';
      memberSearchResults.innerHTML = '';
      memberSearchNoResults.classList.add('hidden');
      
      // Show loading
      unassignedMembersLoading.classList.remove('hidden');
      unassignedMembersSection.classList.add('hidden');
      noUnassignedMembers.classList.add('hidden');
      
      try {
        // Filter members who have no teams or empty teams array
        const unassignedMembers = allMembers.filter(member => {
          const teams = member.teams || [];
          return teams.length === 0;
        });
        
        unassignedMembersLoading.classList.add('hidden');
        
        if (unassignedMembers.length === 0) {
          noUnassignedMembers.classList.remove('hidden');
          return;
        }
        
        // Update count
        unassignedCount.textContent = `${unassignedMembers.length} member${unassignedMembers.length !== 1 ? 's' : ''} found`;
        
        // Clear and populate list
        unassignedMembersList.innerHTML = '';
        
        for (const member of unassignedMembers) {
          const memberCard = document.createElement('div');
          memberCard.className = 'member-card';
          memberCard.innerHTML = `
            <div class="member-info">
              <div class="member-details">
                <h5 class="mb-1">
                  ${member.firstName} ${member.surname}
                  <span class="status-pill status-${member.profileStatus} ms-2">
                    ${member.profileStatus.charAt(0).toUpperCase() + member.profileStatus.slice(1)}
                  </span>
                </h5>
                <p class="text-muted mb-1">${member.email}</p>
                <div class="small">Grade: ${member.clinicalGrade || 'Not specified'}</div>
                <div class="member-teams">
                  <span class="text-muted small">No teams assigned</span>
                </div>
              </div>
            </div>
            <div>
              <button class="btn btn-outline-primary btn-sm assign-teams-btn-unassigned" data-member-id="${member.id}" data-member-name="${member.firstName} ${member.surname}">
                <i class="bi bi-people"></i> Assign Teams
              </button>
            </div>
          `;
          
          unassignedMembersList.appendChild(memberCard);
        }
        
        // Add event listeners to assign buttons
        document.querySelectorAll('.assign-teams-btn-unassigned').forEach(btn => {
          btn.addEventListener('click', () => {
            const memberId = btn.getAttribute('data-member-id');
            const memberFullName = btn.getAttribute('data-member-name');
            openTeamSelectionModal(memberId, memberFullName);
          });
        });
        
        unassignedMembersSection.classList.remove('hidden');
        
      } catch (error) {
        console.error('Error loading unassigned members:', error);
        showAlert('Error loading unassigned members: ' + error.message, 'danger');
        unassignedMembersLoading.classList.add('hidden');
      }
    }

    // NEW: Hide unassigned members section
    function hideUnassignedMembers() {
      unassignedMembersSection.classList.add('hidden');
      noUnassignedMembers.classList.add('hidden');
      unassignedMembersList.innerHTML = '';
    }

    // Load members by grade
    async function loadMembersByGrade(showLoading = true) {
      const selectedGrade = gradeSelect.value;
      lastGradeSelection = selectedGrade;
      
      if (!selectedGrade) {
        gradeMembers.classList.add('hidden');
        noGradeMembers.classList.add('hidden');
        return;
      }
      
      if (showLoading) {
        gradeMembersLoading.classList.remove('hidden');
      }
      gradeMembers.classList.add('hidden');
      noGradeMembers.classList.add('hidden');
      
      // Reset selections
      selectedMemberIds = [];
      selectAllMembers.checked = false;
      updateSelectedCount();
      
      // Filter members by grade
      const filteredMembers = allMembers.filter(member => member.clinicalGrade === selectedGrade);
      
      if (filteredMembers.length === 0) {
        gradeMembersLoading.classList.add('hidden');
        noGradeMembers.classList.remove('hidden');
        return;
      }
      
      // Clear and populate the list
      gradeMembersList.innerHTML = '';
      
      for (const member of filteredMembers) {
        const memberTeams = member.teams || [];
        
        const memberCard = document.createElement('div');
        memberCard.className = 'member-card';
        memberCard.innerHTML = `
          <div class="d-flex align-items-start gap-3">
            <input type="checkbox" class="form-check-input member-checkbox" value="${member.id}">
            <div class="member-details">
              <h5 class="mb-1">${member.firstName} ${member.surname}</h5>
              <p class="text-muted mb-1">${member.email}</p>
              <div class="member-teams">
                ${getTeamBadgesHtml(memberTeams)}
              </div>
            </div>
          </div>
          <div>
            <button class="btn btn-outline-primary btn-sm grade-assign-btn" data-member-id="${member.id}" data-member-name="${member.firstName} ${member.surname}">
              <i class="bi bi-people"></i> Assign Teams
            </button>
          </div>
        `;
        
        gradeMembersList.appendChild(memberCard);
      }
      
      // Add event listeners for checkboxes
      document.querySelectorAll('.member-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            if (!selectedMemberIds.includes(e.target.value)) {
              selectedMemberIds.push(e.target.value);
            }
          } else {
            selectedMemberIds = selectedMemberIds.filter(id => id !== e.target.value);
            selectAllMembers.checked = false;
          }
          updateSelectedCount();
        });
      });
      
      // Add event listeners for individual assign buttons
      document.querySelectorAll('.grade-assign-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const memberId = btn.getAttribute('data-member-id');
          const memberFullName = btn.getAttribute('data-member-name');
          openTeamSelectionModal(memberId, memberFullName);
        });
      });
      
      gradeMembersLoading.classList.add('hidden');
      gradeMembers.classList.remove('hidden');
    }

    // Update selected count
    function updateSelectedCount() {
      selectedMembersCount.textContent = `${selectedMemberIds.length} member${selectedMemberIds.length !== 1 ? 's' : ''} selected`;
      
      // Enable/disable assign button
      assignSelectedBtn.disabled = selectedMemberIds.length === 0;
    }

    // Handle select all checkbox
    function handleSelectAll() {
      const isChecked = selectAllMembers.checked;
      
      document.querySelectorAll('.member-checkbox').forEach(checkbox => {
        checkbox.checked = isChecked;
        
        if (isChecked && !selectedMemberIds.includes(checkbox.value)) {
          selectedMemberIds.push(checkbox.value);
        } else if (!isChecked) {
          selectedMemberIds = selectedMemberIds.filter(id => id !== checkbox.value);
        }
      });
      
      updateSelectedCount();
    }

    // Load members by team
    async function loadMembersByTeam(showLoading = true) {
      const selectedTeamId = teamSelect.value;
      lastTeamSelection = selectedTeamId;
      
      if (!selectedTeamId) {
        teamMembers.classList.add('hidden');
        noTeamMembers.classList.add('hidden');
        return;
      }
      
      if (showLoading) {
        teamMembersLoading.classList.remove('hidden');
      }
      teamMembers.classList.add('hidden');
      noTeamMembers.classList.add('hidden');
      
      // Get team
      const team = allTeams.find(t => t.id === selectedTeamId);
      if (!team) {
        teamMembersLoading.classList.add('hidden');
        noTeamMembers.classList.remove('hidden');
        return;
      }
      
      // Get members in team
      try {
        // Get users in this team using the teams array field
        const membersInTeam = allMembers.filter(member => {
          const memberTeams = member.teams || [];
          return memberTeams.includes(selectedTeamId);
        });
        
        if (membersInTeam.length === 0) {
          teamMembersLoading.classList.add('hidden');
          noTeamMembers.classList.remove('hidden');
          return;
        }
        
        // Clear and populate
        teamMembersListContainer.innerHTML = '';
        
        for (const member of membersInTeam) {
          const memberCard = document.createElement('div');
          memberCard.className = 'member-card';
          memberCard.innerHTML = `
            <div class="member-info">
              <div class="member-details">
                <h5 class="mb-1">${member.firstName} ${member.surname}</h5>
                <p class="text-muted mb-1">${member.email}</p>
                <div class="small">Grade: ${member.clinicalGrade || 'Not specified'}</div>
              </div>
            </div>
            <div class="actions-column">
              <button class="btn btn-outline-danger btn-sm remove-from-team-btn" data-member-id="${member.id}">
                <i class="bi bi-person-dash"></i> Remove
              </button>
            </div>
          `;
          
          teamMembersListContainer.appendChild(memberCard);
        }
        
        // Add event listeners for remove buttons
        document.querySelectorAll('.remove-from-team-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const memberId = btn.getAttribute('data-member-id');
            
            if (confirm(`Remove this member from the team "${team.name}"?`)) {
              await removeFromTeam(memberId, selectedTeamId);
              await loadMembersByTeam(); // Reload the list
            }
          });
        });
        
        teamMembersLoading.classList.add('hidden');
        teamMembers.classList.remove('hidden');
        
      } catch (error) {
        console.error('Error loading team members:', error);
        showAlert('Error loading team members: ' + error.message, 'danger');
        teamMembersLoading.classList.add('hidden');
      }
    }

    // Remove a member from a team
    async function removeFromTeam(memberId, teamId) {
      try {
        const memberRef = doc(db, 'users', memberId);
        const memberDoc = await getDoc(memberRef);
        
        if (!memberDoc.exists()) {
          throw new Error('Member not found');
        }
        
        const memberData = memberDoc.data();
        const currentTeams = memberData.teams || [];
        
        // Remove team if present
        if (currentTeams.includes(teamId)) {
          await updateDoc(memberRef, {
            teams: arrayRemove(teamId)
          });
          
          // Update local data
          const memberIndex = allMembers.findIndex(m => m.id === memberId);
          if (memberIndex !== -1) {
            allMembers[memberIndex].teams = allMembers[memberIndex].teams.filter(id => id !== teamId);
          }
          
          showAlert('Member removed from team successfully.', 'success');
        }
      } catch (error) {
        console.error('Error removing member from team:', error);
        showAlert('Error removing member from team: ' + error.message, 'danger');
      }
    }

    // Open team selection modal for a single member or multiple members
    async function openTeamSelectionModal(memberId, memberFullName) {
      try {
        // Set up modal for single member or bulk assignment
        if (memberId) {
          // Single member mode
          bulkAssignmentMode = false;
          currentMemberId = memberId;
          memberName.textContent = memberFullName;
          teamSelectionDescription.innerHTML = `Select teams for <strong>${memberFullName}</strong>`;
          
          // Get member's current teams
          const memberDoc = await getDoc(doc(db, 'users', memberId));
          currentMemberTeams = memberDoc.exists() ? (memberDoc.data().teams || []) : [];
        } else {
          // Bulk assignment mode
          bulkAssignmentMode = true;
          currentMemberId = null;
          memberName.textContent = `${selectedMemberIds.length} Members`;
          teamSelectionDescription.innerHTML = `Select teams to add for <strong>${selectedMemberIds.length} selected members</strong>`;
          currentMemberTeams = []; // Don't pre-select any teams for bulk
        }
        
        // Populate team checkboxes
        teamSelectContainer.innerHTML = '';
        
        allTeams.forEach(team => {
          const isChecked = currentMemberTeams.includes(team.id);
          
          const teamItem = document.createElement('div');
          teamItem.className = 'team-select-item';
          teamItem.innerHTML = `
            <div class="form-check">
              <input class="form-check-input team-checkbox" type="checkbox" value="${team.id}" id="team-${team.id}" ${isChecked ? 'checked' : ''}>
              <label class="form-check-label" for="team-${team.id}">
                ${team.name}
              </label>
            </div>
          `;
          
          teamSelectContainer.appendChild(teamItem);
        });
        
        teamSelectionModal.show();
        
      } catch (error) {
        console.error('Error opening team selection modal:', error);
        showAlert('Error loading member data: ' + error.message, 'danger');
      }
    }

    // Save team assignments
    async function saveTeamAssignments() {
      setButtonLoading(saveTeamsBtn, true);
      
      try {
        // Get selected teams
        const selectedTeams = [];
        document.querySelectorAll('.team-checkbox:checked').forEach(checkbox => {
          selectedTeams.push(checkbox.value);
        });
        
        if (bulkAssignmentMode) {
          // Bulk update - add selected teams to all selected members
          for (const memberId of selectedMemberIds) {
            const memberRef = doc(db, 'users', memberId);
            
            // Add teams using arrayUnion to avoid duplicates
            for (const teamId of selectedTeams) {
              await updateDoc(memberRef, {
                teams: arrayUnion(teamId)
              });
            }
            
            // Update local data
            const memberIndex = allMembers.findIndex(m => m.id === memberId);
            if (memberIndex !== -1) {
              const existingTeams = allMembers[memberIndex].teams || [];
              allMembers[memberIndex].teams = [...new Set([...existingTeams, ...selectedTeams])];
            }
          }
          
          showAlert(`Teams assigned to ${selectedMemberIds.length} members successfully.`, 'success');
          
          // Reset selections
          selectedMemberIds = [];
          selectAllMembers.checked = false;
          updateSelectedCount();
          
        } else {
          // Single member update - set teams exactly as selected
          const memberRef = doc(db, 'users', currentMemberId);
          
          await updateDoc(memberRef, {
            teams: selectedTeams
          });
          
          // Update local data
          const memberIndex = allMembers.findIndex(m => m.id === currentMemberId);
          if (memberIndex !== -1) {
            allMembers[memberIndex].teams = selectedTeams;
          }
          
          showAlert('Team assignments saved successfully.', 'success');
        }
        
        teamSelectionModal.hide();
        
        // Refresh current view
        await loadInitialData();
        
      } catch (error) {
        console.error('Error saving team assignments:', error);
        showAlert('Error saving team assignments: ' + error.message, 'danger');
      } finally {
        setButtonLoading(saveTeamsBtn, false);
      }
    }

    // Event Listeners
    memberSearchInput.addEventListener('input', () => searchMembers(true));
    
    // NEW: Unassigned members button listeners
    showUnassignedBtn.addEventListener('click', showUnassignedMembers);
    hideUnassignedBtn.addEventListener('click', hideUnassignedMembers);
    
    gradeSelect.addEventListener('change', () => loadMembersByGrade(true));
    selectAllMembers.addEventListener('change', handleSelectAll);
    
    teamSelect.addEventListener('change', () => loadMembersByTeam(true));
    
    assignSelectedBtn.addEventListener('click', () => {
      if (selectedMemberIds.length > 0) {
        openTeamSelectionModal(null, null);
      }
    });
    
    saveTeamsBtn.addEventListener('click', saveTeamAssignments);
    
    // Tab change event listener
    document.querySelectorAll('button[data-bs-toggle="pill"]').forEach(tab => {
      tab.addEventListener('shown.bs.tab', (e) => {
        const targetId = e.target.getAttribute('data-bs-target');
        
        // Hide unassigned section when changing tabs
        hideUnassignedMembers();
        
        // Refresh data if needed
        if (targetId === '#search-member' && lastSearchTerm.length >= 3) {
          searchMembers(true);
        } else if (targetId === '#by-grade' && lastGradeSelection) {
          loadMembersByGrade(true);
        } else if (targetId === '#by-team' && lastTeamSelection) {
          loadMembersByTeam(true);
        }
      });
    });
    
    // Refresh button
    refreshDataBtn.addEventListener('click', loadInitialData);
    
    logoutLink.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout failed:', error);
        alert('Logout failed: ' + error.message);
      }
    });

    // Check authentication and admin status
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (!userDoc.exists() || userDoc.data().isAdmin !== true) {
          alert('You do not have permission to access this page.');
          window.location.href = 'dashboard.html';
          return;
        }
        
        // Load initial data
        await loadInitialData();
        
        // Show page content after everything is loaded
        showPageContent();
        
      } catch (error) {
        console.error('Error checking admin status:', error);
        showAlert('Error checking permissions: ' + error.message, 'danger');
      }
    });
  </script>
</body>
</html>
