<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Team Assignment - FMS Prehospital Portal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .member-card {
      border-radius: 10px;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .member-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .member-details {
      flex-grow: 1;
    }
    
    .member-info {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .profile-pic-container {
      width: 60px;
      height: 60px;
      flex-shrink: 0;
    }
    
    .profile-pic {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      background-color: #e9ecef;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #adb5bd;
      font-size: 24px;
    }
    
    .team-badge {
      display: inline-block;
      background-color: #e9ecef;
      color: #495057;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    
    .member-teams {
      margin-top: 10px;
    }
    
    .search-container {
      position: relative;
      margin-bottom: 20px;
    }
    
    .search-container .form-control {
      padding-left: 40px;
    }
    
    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
      z-index: 10;
    }
    
    .btn-loading {
      position: relative;
      color: transparent !important;
    }
    
    .btn-loading:after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: calc(50% - 8px);
      left: calc(50% - 8px);
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spinner 0.6s linear infinite;
    }
    
    @keyframes spinner { to { transform: rotate(360deg); } }
    
    .hidden {
      display: none !important;
    }
    
    /* Team selection modal styles */
    .team-select-container {
      max-height: 300px;
      overflow-y: auto;
    }
    
    .team-select-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
    }
    
    .team-select-item:last-child {
      border-bottom: none;
    }
    
    .team-select-item .form-check {
      margin-bottom: 0;
    }
    
    .team-select-item label {
      margin-bottom: 0;
      width: 100%;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="dashboard.html">FMS Prehospital Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          
          <li class="nav-item">
            <a class="nav-link" href="admin.html">
              <i class="bi bi-arrow-left"></i> Admin Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-house-fill"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="team-management.html">
              <i class="bi bi-people-fill"></i> Team Management
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutLink">
              <i class="bi bi-box-arrow-right"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1 class="mb-2"><i class="bi bi-person-plus-fill"></i> Team Assignment</h1>
      <p class="mb-0">Assign members to clinical or operational teams</p>
    </div>

    <div id="alertContainer"></div>

    <div class="admin-card">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="bi bi-people"></i> Member Team Assignment</h3>
      </div>
      
      <div class="search-container">
        <i class="bi bi-search search-icon"></i>
        <input type="text" id="searchInput" class="form-control" placeholder="Search members by name or email...">
      </div>

      <div id="membersContainer">
        <div id="loadingMembers" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading members...</p>
        </div>
        
        <div id="noMembersMessage" class="alert alert-info hidden">
          <i class="bi bi-info-circle"></i> No members found. Add users to the portal first.
        </div>
        
        <div id="membersList" class="hidden">
          <!-- Members will be loaded here dynamically -->
        </div>
      </div>
    </div>
  </div>

  <!-- Team Selection Modal -->
  <div class="modal fade" id="teamSelectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-people"></i> Assign Teams</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Select teams for <strong id="memberName"></strong></p>
          
          <div class="team-select-container" id="teamSelectContainer">
            <div class="text-center py-3">
              <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
              <span class="ms-2">Loading teams...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="saveTeamsBtn">
            <i class="bi bi-save"></i> Save Teams
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      collection, 
      getDocs, 
      updateDoc,
      arrayUnion,
      arrayRemove
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { firebaseConfig } from './firebase-config.js';
    import { getAllTeams, getUserTeams } from './teams-service.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM Elements
    const membersList = document.getElementById('membersList');
    const loadingMembers = document.getElementById('loadingMembers');
    const noMembersMessage = document.getElementById('noMembersMessage');
    const searchInput = document.getElementById('searchInput');
    const teamSelectionModal = new bootstrap.Modal(document.getElementById('teamSelectionModal'));
    const memberName = document.getElementById('memberName');
    const teamSelectContainer = document.getElementById('teamSelectContainer');
    const saveTeamsBtn = document.getElementById('saveTeamsBtn');
    const alertContainer = document.getElementById('alertContainer');
    const logoutLink = document.getElementById('logoutLink');

    // Store all members and teams
    let allMembers = [];
    let filteredMembers = [];
    let allTeams = [];
    let currentMemberId = null;
    let currentMemberTeams = [];

    // Set button loading state
    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.classList.add('btn-loading');
        button.disabled = true;
      } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
      }
    }

    // Show alert message
    function showAlert(message, type) {
      const html = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      alertContainer.innerHTML = html;
      
      if (type === 'success') {
        setTimeout(() => {
          const alert = document.querySelector('.alert');
          if (alert) {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
          }
        }, 5000);
      }
    }

    // Load all members
    async function loadMembers() {
      try {
        membersList.classList.add('hidden');
        loadingMembers.classList.remove('hidden');
        noMembersMessage.classList.add('hidden');
        
        // Load all teams first
        allTeams = await getAllTeams();
        
        // Load all users
        const usersSnapshot = await getDocs(collection(db, 'users'));
        
        allMembers = [];
        usersSnapshot.forEach(doc => {
          allMembers.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Sort members by name
        allMembers.sort((a, b) => {
          const nameA = `${a.firstName} ${a.surname}`.toLowerCase();
          const nameB = `${b.firstName} ${b.surname}`.toLowerCase();
          return nameA.localeCompare(nameB);
        });
        
        // Filter members based on search input
        filterMembers();
        
      } catch (error) {
        console.error('Error loading members:', error);
        showAlert('Error loading members: ' + error.message, 'danger');
        loadingMembers.classList.add('hidden');
      }
    }

    // Filter members based on search input
    function filterMembers() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      
      if (searchTerm === '') {
        filteredMembers = [...allMembers];
      } else {
        filteredMembers = allMembers.filter(member => {
          const fullName = `${member.firstName} ${member.surname}`.toLowerCase();
          const email = member.email.toLowerCase();
          
          return fullName.includes(searchTerm) || email.includes(searchTerm);
        });
      }
      
      displayMembers();
    }

    // Display members
    async function displayMembers() {
      if (filteredMembers.length === 0) {
        loadingMembers.classList.add('hidden');
        noMembersMessage.classList.remove('hidden');
        membersList.classList.add('hidden');
        return;
      }
      
      membersList.innerHTML = '';
      
      for (const member of filteredMembers) {
        // Get member's teams
        let memberTeams = [];
        if (member.teams && member.teams.length > 0) {
          memberTeams = member.teams.map(teamId => {
            const team = allTeams.find(t => t.id === teamId);
            return team ? team.name : null;
          }).filter(teamName => teamName !== null);
        }
        
        // Try to get profile image
        let profileImageUrl = null;
        try {
          const profileRef = doc(db, 'profiles', member.id);
          const profileDoc = await getDoc(profileRef);
          
          if (profileDoc.exists() && profileDoc.data().personalDetails && profileDoc.data().personalDetails.profilePicture) {
            const profilePicPath = profileDoc.data().personalDetails.profilePicture;
            profileImageUrl = await getDownloadURL(ref(storage, profilePicPath));
          }
        } catch (error) {
          console.warn(`Could not load profile image for ${member.id}:`, error);
        }
        
        const memberCard = document.createElement('div');
        memberCard.className = 'member-card';
        memberCard.innerHTML = `
          <div class="member-info">
            <div class="profile-pic-container">
              ${profileImageUrl 
                ? `<img src="${profileImageUrl}" alt="Profile" class="profile-pic">` 
                : `<div class="profile-pic"><i class="bi bi-person"></i></div>`
              }
            </div>
            <div class="member-details">
              <h5 class="mb-1">${member.firstName} ${member.surname}</h5>
              <p class="text-muted mb-1">${member.email}</p>
              <div class="member-teams">
                ${memberTeams.length > 0 
                  ? memberTeams.map(team => `<span class="team-badge">${team}</span>`).join('') 
                  : '<small class="text-muted">No teams assigned</small>'
                }
              </div>
            </div>
          </div>
          <div>
            <button class="btn btn-outline-primary btn-sm assign-teams-btn" data-member-id="${member.id}">
              <i class="bi bi-people"></i> Assign Teams
            </button>
          </div>
        `;
        
        membersList.appendChild(memberCard);
      }
      
      // Add event listeners
      document.querySelectorAll('.assign-teams-btn').forEach(btn => {
        btn.addEventListener('click', () => openTeamSelectionModal(btn.dataset.memberId));
      });
      
      loadingMembers.classList.add('hidden');
      membersList.classList.remove('hidden');
    }

    // Open team selection modal
    async function openTeamSelectionModal(memberId) {
      try {
        const member = allMembers.find(m => m.id === memberId);
        
        if (!member) {
          showAlert('Member not found.', 'danger');
          return;
        }
        
        currentMemberId = memberId;
        memberName.textContent = `${member.firstName} ${member.surname}`;
        
        // Display loading
        teamSelectContainer.innerHTML = `
          <div class="text-center py-3">
            <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
            <span class="ms-2">Loading teams...</span>
          </div>
        `;
        
        teamSelectionModal.show();
        
        // Get member's current teams
        currentMemberTeams = member.teams || [];
        
        // Create team checkboxes
        let html = '';
        
        if (allTeams.length === 0) {
          html = `
            <div class="alert alert-info mb-0">
              <i class="bi bi-info-circle"></i> No teams available. Please create teams first.
            </div>
          `;
        } else {
          for (const team of allTeams) {
            const isChecked = currentMemberTeams.includes(team.id);
            
            html += `
              <div class="team-select-item">
                <div class="form-check">
                  <input class="form-check-input team-checkbox" type="checkbox" 
                         id="team-${team.id}" value="${team.id}" 
                         ${isChecked ? 'checked' : ''}>
                  <label class="form-check-label" for="team-${team.id}">
                    ${team.name}
                    ${team.description ? `<div class="text-muted small">${team.description}</div>` : ''}
                  </label>
                </div>
              </div>
            `;
          }
        }
        
        teamSelectContainer.innerHTML = html;
        
      } catch (error) {
        console.error('Error opening team selection modal:', error);
        showAlert('Error loading teams: ' + error.message, 'danger');
      }
    }

    // Save member teams
    async function saveMemberTeams() {
      try {
        setButtonLoading(saveTeamsBtn, true);
        
        const member = allMembers.find(m => m.id === currentMemberId);
        
        if (!member) {
          showAlert('Member not found.', 'danger');
          setButtonLoading(saveTeamsBtn, false);
          return;
        }
        
        // Get selected teams
        const selectedTeamIds = Array.from(document.querySelectorAll('.team-checkbox:checked')).map(checkbox => checkbox.value);
        
        // Find teams to add and remove
        const teamsToAdd = selectedTeamIds.filter(teamId => !currentMemberTeams.includes(teamId));
        const teamsToRemove = currentMemberTeams.filter(teamId => !selectedTeamIds.includes(teamId));
        
        // Update member's teams
        const memberRef = doc(db, 'users', currentMemberId);
        
        // Add teams
        for (const teamId of teamsToAdd) {
          await updateDoc(memberRef, {
            teams: arrayUnion(teamId)
          });
        }
        
        // Remove teams
        for (const teamId of teamsToRemove) {
          await updateDoc(memberRef, {
            teams: arrayRemove(teamId)
          });
        }
        
        // Update the member in the local array
        const memberIndex = allMembers.findIndex(m => m.id === currentMemberId);
        if (memberIndex !== -1) {
          allMembers[memberIndex].teams = selectedTeamIds;
        }
        
        showAlert(`Teams updated for ${member.firstName} ${member.surname}.`, 'success');
        
        teamSelectionModal.hide();
        
        // Update displayed members
        await displayMembers();
        
      } catch (error) {
        console.error('Error saving member teams:', error);
        showAlert('Error saving teams: ' + error.message, 'danger');
      } finally {
        setButtonLoading(saveTeamsBtn, false);
      }
    }

    // Event Listeners
    searchInput.addEventListener('input', filterMembers);
    saveTeamsBtn.addEventListener('click', saveMemberTeams);
    
    logoutLink.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Logout failed:', error);
        alert('Logout failed: ' + error.message);
      }
    });

    // Check authentication and admin status
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const userDoc = await getDoc(userDocRef);
        
        if (!userDoc.exists() || userDoc.data().isAdmin !== true) {
          alert('You do not have permission to access this page.');
          window.location.href = 'dashboard.html';
          return;
        }
        
        // Load members
        await loadMembers();
        
      } catch (error) {
        console.error('Error checking admin status:', error);
        alert('Error checking permissions: ' + error.message);
        window.location.href = 'dashboard.html';
      }
    });
  </script>
</body>
</html>