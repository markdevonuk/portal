<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit User Profile - FMS Prehospital Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { background:#f8f9fa; min-height:100vh; }
    .navbar { 
      background:linear-gradient(135deg,#00a896 0%,#028090 100%); 
      box-shadow:0 2px 10px rgba(0,0,0,.1); 
    }
    .nav-link { color: rgba(255,255,255,.85) !important; font-weight: 500; }
    .nav-link:hover { color: #fff !important; }
    .profile-card { 
      background:#fff; 
      border-radius:15px; 
      box-shadow:0 5px 20px rgba(0,0,0,.08); 
      padding:30px; 
      margin:20px 0; 
    }
    .page-header { 
      background:linear-gradient(135deg,#00a896 0%,#028090 100%); 
      color:#fff; 
      border-radius:15px; 
      padding:30px; 
      margin:30px 0 20px 0; 
    }
    .form-control:focus { 
      border-color: #00a896; 
      box-shadow: 0 0 0 0.2rem rgba(0,168,150,.25); 
    }
    .btn-primary { 
      background: linear-gradient(135deg, #00a896 0%, #028090 100%); 
      border: none; 
      font-weight: 600; 
    }
    .btn-primary:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 5px 15px rgba(0,168,150,.4); 
    }
    .section-title {
      border-bottom: 2px solid #00a896;
      padding-bottom: 10px;
      margin-bottom: 20px;
      color: #028090;
    }
    .form-section {
      margin-bottom: 30px;
    }
    .btn-loading { position: relative; pointer-events: none; opacity: .7; }
    .btn-loading::after { 
      content:""; position:absolute; width:16px; height:16px; top:50%; left:50%; 
      margin:-8px 0 0 -8px; border:2px solid #fff; border-radius:50%; 
      border-top-color:transparent; animation:spinner .6s linear infinite; 
    }
    @keyframes spinner { to { transform: rotate(360deg); } }
    .hidden { display: none; }
    .text-success { color: #00a896 !important; }
    .profile-status {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d1e7dd; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .form-check-input:checked {
      background-color: #00a896;
      border-color: #00a896;
    }
    /* Document styles */
    .doc-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 10px;
    }
    .doc-preview-icon {
      font-size: 2rem;
      color: #00a896;
    }
    .doc-preview-info {
      flex-grow: 1;
    }
    .doc-preview-actions {
      display: flex;
      gap: 5px;
    }
    .profile-photo {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
      border: 3px solid #00a896;
    }
    .upload-progress {
      height: 5px;
      margin-top: 5px;
    }
    .admin-notice {
      background: #e7f5f3;
      border-left: 4px solid #00a896;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 5px;
    }
    .admin-notes-history {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
    }
    .note-entry {
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }
    .note-entry:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    .note-timestamp {
      color: #6c757d;
      font-size: 0.85rem;
      margin-bottom: 5px;
    }
    .note-content {
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html"><i class="bi bi-shield-lock"></i> FMS Prehospital Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="admin-profiles.html">
              <i class="bi bi-arrow-left"></i> Back to Profiles
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="admin.html">
              <i class="bi bi-gear-fill"></i> Admin
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-house-fill"></i> Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutLink">
              <i class="bi bi-box-arrow-right"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1 class="mb-2"><i class="bi bi-pencil-square"></i> Edit User Profile</h1>
      <p class="mb-0" id="userInfoHeader">Loading user information...</p>
    </div>

    <div id="alertContainer"></div>

    <div class="admin-notice">
      <i class="bi bi-info-circle-fill"></i> <strong>Admin Mode:</strong> You are editing a user's profile as an administrator. Any changes made will be saved to their account.
    </div>

    <!-- Profile Status -->
    <div id="profileStatus" class="profile-status hidden">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h5 class="mb-1" id="statusTitle">Profile Status</h5>
          <p class="mb-0" id="statusMessage">Profile status will appear here</p>
        </div>
        <div id="statusIcon">
          <i class="bi bi-question-circle fs-1"></i>
        </div>
      </div>
    </div>
    <!-- Profile Form -->
    <form id="profileForm">
      <!-- Profile Photo Section -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-person-badge"></i> Profile Photo</h3>

        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> <strong>Required:</strong> Users must have a clear photo of themselves. Ensure no one else is in the photo. Accepted files are JPG, PNG.
        </div>

        <div class="row">
          <div class="col-md-4 text-center mb-3">
            <div id="photoPreviewContainer">
              <img src="https://via.placeholder.com/150?text=No+Photo" alt="Profile Photo" class="profile-photo" id="photoPreview">
            </div>
          </div>
          <div class="col-md-8">
            <div class="mb-3">
              <label for="profilePhotoInput" class="form-label">Update Photo</label>
              <input type="file" class="form-control" id="profilePhotoInput" accept="image/jpeg, image/png">
              <div class="form-text">Max file size: 7.5MB</div>
            </div>

            <button type="button" class="btn btn-primary" id="uploadPhotoBtn">
              <i class="bi bi-cloud-upload"></i> Upload Photo
            </button>

            <div class="progress mt-2 hidden" id="photoUploadProgressContainer">
              <div class="progress-bar bg-success" id="photoUploadProgressBar" role="progressbar" style="width: 0%"></div>
            </div>

            <input type="hidden" id="profilePhotoURL" name="profilePhotoURL">
          </div>
        </div>
      </div>

      <!-- Personal Details Section -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-person-fill"></i> Personal Details</h3>

        <div class="mb-3">
          <label class="form-label">Date of birth <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
            <input type="text" class="form-control" id="dob" name="dob" placeholder="DD/MM/YYYY" required>
          </div>
          <small class="form-text text-muted">Select the user's date of birth</small>
        </div>

        <div class="mb-3">
          <label class="form-label">Emergency contact <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-telephone"></i></span>
            <input type="text" class="form-control" id="emergencyContact" name="emergencyContact" placeholder="Name & phone number" required>
          </div>
          <small class="form-text text-muted">Provide a name and contact number</small>
        </div>
      </div>

      <!-- Driving Details Section -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-car-front-fill"></i> Driving Details</h3>
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> Optional, but users cannot drive FMS vehicles without this data. By completing, users agree that FMS can carry out driving licence checks online.
        </div>

        <div class="mb-3">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="c1Classification" name="c1Classification">
            <label class="form-check-label" for="c1Classification">Has a C1 classification on driving licence</label>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Driving licence number</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-credit-card-2-front"></i></span>
            <input type="text" class="form-control" id="dlNumber" name="dlNumber" placeholder="e.g. SMITH601014ABCDE">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">National Insurance number</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-shield"></i></span>
            <input type="text" class="form-control" id="niNumber" name="niNumber" placeholder="e.g. AB123456C">
          </div>
          <small class="form-text text-muted">Used for driving licence checks online</small>
        </div>

        <div class="mb-3">
          <label class="form-label">Points on licence</label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-exclamation-triangle"></i></span>
            <input type="text" class="form-control" id="points" name="points" placeholder="e.g. 0, 3, etc.">
          </div>
        </div>
      </div>

      <!-- Medical Qualifications Section -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-award"></i> Qualifications</h3>

        <!-- Qualification Evidence Upload -->
        <div class="mb-4">
          <h5 class="mb-3">Qualification Evidence</h5>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> <strong>Optional:</strong> Evidence of qualification may include: <br>
            <ul class="mb-0">
              <li><strong>Paramedics:</strong> HCPC screenshot or photo, or Trust ID card</li>
              <li><strong>Tech/ECA/EAA:</strong> Trust ID card or certificate</li>
              <li><strong>Nurses:</strong> PHTLS or FREC certificate if available</li>
              <li><strong>Doctors:</strong> PHTLS or FREC certificate if available</li>
              <li><strong>All others:</strong> Relevant certificate</li>
            </ul>
            <p class="mt-2 mb-0">Accepted files are PDF, Word, JPG, PNG.</p>
          </div>

          <div id="qualDocPreviewContainer" class="mt-3 hidden">
            <!-- Qualification document preview will appear here -->
          </div>

          <div class="mb-3">
            <label for="qualificationDocInput" class="form-label">Update Document</label>
            <input type="file" class="form-control" id="qualificationDocInput" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
            <div class="form-text">Max file size: 7.5MB</div>
          </div>

          <button type="button" class="btn btn-primary" id="uploadQualDocBtn">
            <i class="bi bi-cloud-upload"></i> Upload Document
          </button>

          <div class="progress mt-2 hidden" id="qualDocUploadProgressContainer">
            <div class="progress-bar bg-success" id="qualDocUploadProgressBar" role="progressbar" style="width: 0%"></div>
          </div>

          <input type="hidden" id="qualificationDocURL" name="qualificationDocURL">
        </div>

        <div class="mb-4">
          <label class="form-label">Main qualification <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-mortarboard"></i></span>
            <select class="form-select" id="qualification" name="qualification" required>
              <option value="">Select main qualification</option>
              <option value="Non Medical">Non Medical (Make Ready, Medcomms etc)</option>
              <option value="AAP">AAP</option>
              <option value="Doctor">Doctor</option>
              <option value="Doctor (Critical Care/BASICS/Merit)">Doctor (Critical Care/BASICS/Merit)</option>
              <option value="Doctor (with FREC/PHTLS or similar)">Doctor (with FREC/PHTLS or similar)</option>
              <option value="EAA">EAA</option>
              <option value="ECA">ECA</option>
              <option value="FREC 3 (or similar level 3 certification)">FREC 3 (or similar level 3 certification)</option>
              <option value="FREC 4">FREC 4</option>
              <option value="Nurse">Nurse</option>
              <option value="Nurse (Ambulance Nurse)">Nurse (Ambulance Nurse)</option>
              <option value="Nurse (with FREC/PHTLS or similar)">Nurse (with FREC/PHTLS or similar)</option>
              <option value="Paramedic">Paramedic</option>
              <option value="Paramedic (Critical care)">Paramedic (Critical care)</option>
              <option value="Paramedic (CTM/OO)">Paramedic (CTM/OO)</option>
              <option value="Paramedic (HART)">Paramedic (HART)</option>
              <option value="Paramedic (in Primary Care)">Paramedic (in Primary Care)</option>
              <option value="Paramedic (Specialist)">Paramedic (Specialist)</option>
              <option value="PHTLS">PHTLS</option>
              <option value="Student Paramedic (Year 2)">Student Paramedic (Year 2)</option>
              <option value="Student Paramedic (Year 3)">Student Paramedic (Year 3)</option>
              <option value="Technician">Technician</option>
            </select>
          </div>
        </div>

        <!-- HCPC Registration (conditional) -->
        <div class="mb-3 hidden" id="hcpcSection">
          <label class="form-label">HCPC Registration <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-card-text"></i></span>
            <input type="text" class="form-control" id="hcpc" name="hcpc" placeholder="HCPC registration number">
          </div>
        </div>

        <!-- GMC Registration (conditional) -->
        <div class="mb-3 hidden" id="gmcSection">
          <label class="form-label">GMC Registration <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-card-text"></i></span>
            <input type="text" class="form-control" id="gmc" name="gmc" placeholder="GMC registration number">
          </div>
        </div>

        <!-- NMC Registration (conditional) -->
        <div class="mb-3 hidden" id="nmcSection">
          <label class="form-label">NMC Registration <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-card-text"></i></span>
            <input type="text" class="form-control" id="nmc" name="nmc" placeholder="NMC registration number">
          </div>
        </div>

        <!-- Certificate Expiry (conditional) -->
        <div class="mb-3 hidden" id="certExpirySection">
          <label class="form-label">Certificate expiry date <span class="text-danger">*</span></label>
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
            <input type="text" class="form-control" id="certExpiry" name="certExpiry" placeholder="DD/MM/YYYY">
          </div>
        </div>

        <!-- Details -->
        <div class="mb-3">
          <label class="form-label">Details <span class="text-danger">*</span></label>
          <textarea class="form-control" id="details" name="details" rows="4" placeholder="Brief description of current role and relevance to FMS" required></textarea>
          <small class="form-text text-muted">Briefly describe the user's current role and its relevance to FMS</small>
        </div>
      </div>

      <!-- Terms and Conditions -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-check-square"></i> Terms and Conditions</h3>

        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="agreedToTerms" name="agreedToTerms" required>
            <label class="form-check-label" for="agreedToTerms">
              User agrees to the following terms: FMS may use personal information for operational and recruitment purposes. The user confirms that all information provided is accurate and complete. The user understands that their profile will be reviewed by FMS administrators before approval.
            </label>
          </div>
        </div>
      </div>

      <!-- Admin Notes -->
      <div class="profile-card form-section">
        <h3 class="section-title"><i class="bi bi-shield-check"></i> Admin Notes</h3>

        <div class="mb-3">
          <div id="notesHistory" class="mb-3">
            <!-- Notes history will be loaded here -->
          </div>
          <label class="form-label">Add Note</label>
          <textarea class="form-control" id="adminNotes" name="adminNotes" rows="3" placeholder="Add notes or feedback for the user"></textarea>
          <small class="form-text text-muted">Notes are appended to history and cannot be removed</small>
        </div>

        <div class="mb-3">
          <label class="form-label">Profile Status</label>
          <select class="form-select" id="profileAdminStatus">
            <option value="pending">Pending Review</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="d-flex justify-content-between mb-5">
        <a href="admin-profiles.html" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Cancel
        </a>
        <button type="submit" class="btn btn-primary" id="saveProfileBtn">
          <i class="bi bi-save"></i> Save Changes
        </button>
      </div>
    </form>
  </div>

  <!-- Document Preview Modal -->
  <div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="documentPreviewModalLabel">Document Preview</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="documentPreviewContent">
          <!-- Preview content will be inserted here -->
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-primary" id="downloadDocBtn" target="_blank">
            <i class="bi bi-download"></i> Download
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, arrayUnion } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { firebaseConfig } from './firebase-config.js';
    import { getUserProfile, reviewProfile } from './profile-service.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Get user ID from URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('userId');

    if (!userId) {
      // No user ID provided, redirect to admin profiles
      window.location.href = 'admin-profiles.html';
    }

    // DOM elements
    const profileForm = document.getElementById('profileForm');
    const qualification = document.getElementById('qualification');
    const hcpcSection = document.getElementById('hcpcSection');
    const gmcSection = document.getElementById('gmcSection');
    const nmcSection = document.getElementById('nmcSection');
    const certExpirySection = document.getElementById('certExpirySection');
    const profileStatus = document.getElementById('profileStatus');
    const statusTitle = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');
    const statusIcon = document.getElementById('statusIcon');
    const userInfoHeader = document.getElementById('userInfoHeader');
    const alertContainer = document.getElementById('alertContainer');
    const logoutLink = document.getElementById('logoutLink');
    const documentPreviewModal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
    const documentPreviewContent = document.getElementById('documentPreviewContent');
    const downloadDocBtn = document.getElementById('downloadDocBtn');
    const notesHistory = document.getElementById('notesHistory');
    const adminNotes = document.getElementById('adminNotes');

    // Document Upload DOM elements
    const profilePhotoInput = document.getElementById('profilePhotoInput');
    const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
    const photoUploadProgressContainer = document.getElementById('photoUploadProgressContainer');
    const photoUploadProgressBar = document.getElementById('photoUploadProgressBar');
    const photoPreview = document.getElementById('photoPreview');
    const profilePhotoURL = document.getElementById('profilePhotoURL');

    const qualificationDocInput = document.getElementById('qualificationDocInput');
    const uploadQualDocBtn = document.getElementById('uploadQualDocBtn');
    const qualDocUploadProgressContainer = document.getElementById('qualDocUploadProgressContainer');
    const qualDocUploadProgressBar = document.getElementById('qualDocUploadProgressBar');
    const qualDocPreviewContainer = document.getElementById('qualDocPreviewContainer');
    const qualificationDocURL = document.getElementById('qualificationDocURL');

    // Initialize Flatpickr date pickers
    flatpickr("#dob", {
      dateFormat: "d/m/Y",
      maxDate: new Date() // Can't select future dates
    });

    flatpickr("#certExpiry", {
      dateFormat: "d/m/Y",
      minDate: new Date() // Can't select past dates
    });

    // Helper Functions
    function setButtonLoading(id, loading) {
      const btn = document.getElementById(id);
      if (!btn) return;
      if (loading) {
        btn.classList.add('btn-loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('btn-loading');
        btn.disabled = false;
      }
    }

    function showAlert(message, type) {
      const html = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      alertContainer.innerHTML = html;

      if (type === 'success') {
        setTimeout(() => {
          const alert = document.querySelector('.alert');
          if (alert) {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
          }
        }, 5000);
      }
    }

    // Format date from Firestore timestamp
    function formatDate(timestamp) {
      if (!timestamp) return '';

      let date;
      if (timestamp.seconds) {
        date = new Date(timestamp.seconds * 1000);
      } else if (timestamp.toDate) {
        date = timestamp.toDate();
      } else if (timestamp instanceof Date) {
        date = timestamp;
      } else {
        try {
          date = new Date(timestamp);
        } catch (e) {
          return '';
        }
      }

      if (isNaN(date.getTime())) {
        return '';
      }

      return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }
    
    function formatDateTime(timestamp) {
      if (!timestamp) return '';

      let date;
      if (timestamp.seconds) {
        date = new Date(timestamp.seconds * 1000);
      } else if (timestamp.toDate) {
        date = timestamp.toDate();
      } else if (timestamp instanceof Date) {
        date = timestamp;
      } else {
        try {
          date = new Date(timestamp);
        } catch (e) {
          return '';
        }
      }

      if (isNaN(date.getTime())) {
        return '';
      }

      return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // File utility functions
    // Check if file is an image
    function isImageFile(fileName) {
      const extension = fileName.split('.').pop().toLowerCase();
      return ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension);
    }

    // Check if file is a pdf
    function isPdfFile(fileName) {
      const extension = fileName.split('.').pop().toLowerCase();
      return extension === 'pdf';
    }

    // Get file icon based on extension
    function getFileIcon(fileName) {
      const extension = fileName.split('.').pop().toLowerCase();
      if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension)) {
        return 'bi-file-earmark-image';
      } else if (extension === 'pdf') {
        return 'bi-file-earmark-pdf';
      } else if (['doc', 'docx'].includes(extension)) {
        return 'bi-file-earmark-word';
      } else {
        return 'bi-file-earmark';
      }
    }

    // Format file size
    function formatFileSize(bytes) {
      if (!bytes) return '';
      if (bytes < 1024) {
        return bytes + ' B';
      } else if (bytes < 1024 * 1024) {
        return (bytes / 1024).toFixed(1) + ' KB';
      } else {
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
    }
    
    // Render admin notes history
    function renderNotesHistory(notes) {
      if (!notes || notes.length === 0) {
        return '<p class="text-muted">No admin notes yet.</p>';
      }
      
      let html = '<div class="admin-notes-history">';
      
      // Sort notes by timestamp (newest first)
      const sortedNotes = [...notes].sort((a, b) => {
        const timeA = a.timestamp?.seconds || 0;
        const timeB = b.timestamp?.seconds || 0;
        return timeB - timeA;
      });
      
      sortedNotes.forEach(note => {
        const timestamp = note.timestamp ? formatDateTime(note.timestamp) : 'Unknown date';
        const author = note.author || 'Unknown admin';
        
        html += `
          <div class="note-entry">
            <div class="note-timestamp">
              <i class="bi bi-clock"></i> ${timestamp} by <strong>${author}</strong>
            </div>
            <div class="note-content">${note.text}</div>
          </div>
        `;
      });
      
      html += '</div>';
      
      return html;
    }

    // Helper function to parse date string to Firebase timestamp
    function parseDateString(dateStr) {
      if (!dateStr) return null;
      
      // Parse UK format date (DD/MM/YYYY)
      const parts = dateStr.split('/');
      if (parts.length !== 3) return null;
      
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1; // Months are 0-based
      const year = parseInt(parts[2], 10);
      
      return new Date(year, month, day);
    }

    // Show/hide registration fields based on qualification
    qualification.addEventListener('change', function() {
      const value = this.value;
      console.log('Qualification changed to:', value);

      // Reset all sections to hidden
      hcpcSection.classList.add('hidden');
      gmcSection.classList.add('hidden');
      nmcSection.classList.add('hidden');
      certExpirySection.classList.add('hidden');

      // Remove required attribute from all registration inputs
      document.getElementById('hcpc').removeAttribute('required');
      document.getElementById('gmc').removeAttribute('required');
      document.getElementById('nmc').removeAttribute('required');
      document.getElementById('certExpiry').removeAttribute('required');

      // Show appropriate sections based on qualification
      if (['Paramedic', 'Paramedic (Specialist)', 'Paramedic (HART)', 
           'Paramedic (Critical care)', 'Paramedic (in Primary Care)', 
           'Paramedic (CTM/OO)'].includes(value)) {
        hcpcSection.classList.remove('hidden');
        document.getElementById('hcpc').setAttribute('required', 'required');
      } else if (['Doctor', 'Doctor (Critical Care/BASICS/Merit)', 
                  'Doctor (with FREC/PHTLS or similar)'].includes(value)) {
        gmcSection.classList.remove('hidden');
        document.getElementById('gmc').setAttribute('required', 'required');
      } else if (['Nurse', 'Nurse (Ambulance Nurse)', 
                  'Nurse (with FREC/PHTLS or similar)'].includes(value)) {
        nmcSection.classList.remove('hidden');
        document.getElementById('nmc').setAttribute('required', 'required');

        if (value === 'Nurse (with FREC/PHTLS or similar)') {
          certExpirySection.classList.remove('hidden');
          document.getElementById('certExpiry').setAttribute('required', 'required');
        }
      } else if (['FREC 3 (or similar level 3 certification)', 'FREC 4', 'PHTLS'].includes(value)) {
        certExpirySection.classList.remove('hidden');
        document.getElementById('certExpiry').setAttribute('required', 'required');
      }
    });

    // Update qualification document preview
    function updateQualDocPreview(fileName, downloadURL, storagePath, fileType, fileSize) {
      qualDocPreviewContainer.classList.remove('hidden');

      // Get file icon
      const fileIcon = getFileIcon(fileName);

      // Format file size
      const formattedSize = formatFileSize(fileSize);

      // Create preview HTML
      qualDocPreviewContainer.innerHTML = `
        <div class="doc-preview">
          <i class="bi ${fileIcon} doc-preview-icon"></i>
          <div class="doc-preview-info">
            <div class="fw-bold">${fileName}</div>
            <small class="text-muted">${formattedSize}</small>
          </div>
          <div class="doc-preview-actions">
            <button type="button" class="btn btn-sm btn-outline-primary view-doc-btn" 
                    data-url="${downloadURL}" 
                    data-name="${fileName}"
                    data-type="${fileType}">
              <i class="bi bi-eye"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger delete-doc-btn"
                    data-path="${storagePath}">
             <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      `;
      
      // Add event listeners to buttons
      document.querySelector('.view-doc-btn').addEventListener('click', (e) => {
        const url = e.currentTarget.getAttribute('data-url');
        const name = e.currentTarget.getAttribute('data-name');
        const type = e.currentTarget.getAttribute('data-type');
        previewDocument(url, name, type);
      });
      
      document.querySelector('.delete-doc-btn').addEventListener('click', (e) => {
        const path = e.currentTarget.getAttribute('data-path');
        deleteQualificationDocument(path);
      });
    }

    // Preview document
    function previewDocument(url, name, type) {
      // Set document title
      document.getElementById('documentPreviewModalLabel').textContent = name;
      
      // Set download button
      downloadDocBtn.href = url;
      downloadDocBtn.setAttribute('download', name);
      
      // Clear previous content
      documentPreviewContent.innerHTML = '';
      
      // Check if it's an image
      if (type.startsWith('image/')) {
        // Image preview
        documentPreviewContent.innerHTML = `
          <div class="text-center">
            <img src="${url}" class="img-fluid" alt="${name}" style="max-height: 60vh;">
          </div>
        `;
      } else if (type === 'application/pdf') {
        // PDF preview
        documentPreviewContent.innerHTML = `
          <div class="ratio ratio-16x9" style="height: 60vh;">
            <iframe src="${url}" allowfullscreen></iframe>
          </div>
        `;
      } else {
        // Other document types
        documentPreviewContent.innerHTML = `
          <div class="text-center">
            <i class="${getFileIcon(name)}" style="font-size: 5rem; color: #00a896;"></i>
            <p class="mt-3">Preview not available for this file type.</p>
            <a href="${url}" target="_blank" class="btn btn-primary">
              <i class="bi bi-download"></i> Download to view
            </a>
          </div>
        `;
      }
      
      // Show modal
      documentPreviewModal.show();
    }
    
    // Delete qualification document
    async function deleteQualificationDocument(storagePath) {
      if (confirm('Are you sure you want to delete this document?')) {
        try {
          // Delete from Storage
          const fileRef = ref(storage, storagePath);
          await deleteObject(fileRef);
          
          // Update profile
          const profileRef = doc(db, 'profiles', userId);
          await updateDoc(profileRef, {
            qualificationDocURL: null,
            qualificationDocName: null,
            qualificationDocType: null,
            qualificationDocSize: null,
            qualificationDocStoragePath: null,
            qualificationDocUploadedAt: null
          });
          
          // Update UI
          qualificationDocURL.value = '';
          qualDocPreviewContainer.innerHTML = '';
          qualDocPreviewContainer.classList.add('hidden');
          qualificationDocInput.value = '';
          
          showAlert('Document deleted successfully', 'success');
        } catch (error) {
          console.error('Error deleting document:', error);
          showAlert('Error deleting document: ' + error.message, 'danger');
        }
      }
    }

    // Update profile status display
    function updateProfileStatus(status) {
      profileStatus.classList.remove('hidden');
      profileStatus.classList.remove('status-pending', 'status-approved', 'status-rejected');

      console.log('Updating profile status', status);

      if (!status || !status.adminUse || !status.adminUse.status) {
        profileStatus.classList.add('hidden');
        return;
      }

      const adminStatus = status.adminUse.status;
      document.getElementById('profileAdminStatus').value = adminStatus;

      if (adminStatus === 'pending') {
        statusTitle.textContent = 'Profile Under Review';
        statusMessage.textContent = 'This profile has been submitted and is waiting for admin approval.';
        statusIcon.innerHTML = '<i class="bi bi-hourglass-split fs-1 text-warning"></i>';
        profileStatus.classList.add('status-pending');
      } else if (adminStatus === 'approved') {
        statusTitle.textContent = 'Profile Approved';
        statusMessage.textContent = 'This profile has been reviewed and approved.';
        statusIcon.innerHTML = '<i class="bi bi-check-circle fs-1 text-success"></i>';
        profileStatus.classList.add('status-approved');
      } else if (adminStatus === 'rejected') {
        statusTitle.textContent = 'Profile Needs Updates';
        statusMessage.textContent = 'This profile has been reviewed and needs changes.';
        statusIcon.innerHTML = '<i class="bi bi-x-circle fs-1 text-danger"></i>';
        profileStatus.classList.add('status-rejected');
      } else {
        profileStatus.classList.add('hidden');
      }
    }

    // Load user profile data
    async function loadUserProfile() {
      try {
        console.log('Loading user profile for ID:', userId);

        // Get profile data
        const profile = await getUserProfile(userId);
        console.log('Profile data:', profile);

        if (!profile) {
          showAlert('Profile not found or is empty', 'danger');
          setTimeout(() => {
            window.location.href = 'admin-profiles.html';
          }, 2000);
          return;
        }

        // Get user data
        const userDoc = await getDoc(doc(db, 'users', userId));
        const userData = userDoc.exists() ? userDoc.data() : {};

        // Update user info in header
        userInfoHeader.textContent = `Editing profile for ${userData.firstName || ''} ${userData.surname || ''} (${userData.email || 'No email'})`;

        // Update profile status display
        updateProfileStatus(profile);

        // Load notes history if available
        if (profile.adminUse && profile.adminUse.notes && Array.isArray(profile.adminUse.notes)) {
          notesHistory.innerHTML = renderNotesHistory(profile.adminUse.notes);
        } else {
          notesHistory.innerHTML = '<p class="text-muted">No admin notes yet.</p>';
        }

        // Load profile photo if available
        if (profile.profilePhotoURL) {
          photoPreview.src = profile.profilePhotoURL;
          profilePhotoURL.value = profile.profilePhotoURL;
        }

        // Load qualification document if available
        if (profile.qualificationDocURL) {
          qualificationDocURL.value = profile.qualificationDocURL;
          updateQualDocPreview(
            profile.qualificationDocName || 'Document',
            profile.qualificationDocURL,
            profile.qualificationDocStoragePath || '',
            profile.qualificationDocType || 'application/octet-stream',
            profile.qualificationDocSize || 0
          );
        }

        // Fill form with existing data if available
        if (profile.personalDetails) {
          console.log('Loading personal details:', profile.personalDetails);

          if (profile.personalDetails.DOB) {
            // Convert timestamp to date string
            let date;
            if (profile.personalDetails.DOB.seconds) {
              date = new Date(profile.personalDetails.DOB.seconds * 1000);
            } else {
              date = new Date(profile.personalDetails.DOB);
            }

            document.getElementById('dob').value = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
          }

          document.getElementById('emergencyContact').value = profile.personalDetails.emergencyContact || '';
        }

        if (profile.driving) {
          console.log('Loading driving details:', profile.driving);

          document.getElementById('c1Classification').checked = profile.driving.c1Classification || false;
          document.getElementById('dlNumber').value = profile.driving.dlNumber || '';
          document.getElementById('niNumber').value = profile.driving.niNumber || '';
          document.getElementById('points').value = profile.driving.points || '';
        }

        if (profile.medicalQualifications) {
          console.log('Loading medical qualifications:', profile.medicalQualifications);

          document.getElementById('qualification').value = profile.medicalQualifications.qualification || '';
          document.getElementById('hcpc').value = profile.medicalQualifications.hcpc || '';
          document.getElementById('gmc').value = profile.medicalQualifications.gmc || '';
          document.getElementById('nmc').value = profile.medicalQualifications.nmc || '';
          document.getElementById('details').value = profile.medicalQualifications.details || '';

          if (profile.medicalQualifications.certExpiry) {
            // Convert timestamp to date string
            let date;
            if (profile.medicalQualifications.certExpiry.seconds) {
              date = new Date(profile.medicalQualifications.certExpiry.seconds * 1000);
            } else {
              date = new Date(profile.medicalQualifications.certExpiry);
            }

            document.getElementById('certExpiry').value = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
          }

          // Trigger change event to show/hide appropriate fields
          qualification.dispatchEvent(new Event('change'));
        }

        if (profile.submission) {
          console.log('Loading submission details:', profile.submission);
          document.getElementById('agreedToTerms').checked = profile.submission.agreedToTerms || false;
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        showAlert('Error loading profile data: ' + error.message, 'danger');
      }
    }

    // Upload profile photo
    uploadPhotoBtn.addEventListener('click', async () => {
      const file = profilePhotoInput.files[0];
      if (!file) {
        showAlert('Please select a photo to upload', 'warning');
        return;
      }

      // Validate file size (max 7.5MB)
      if (file.size > 7.5 * 1024 * 1024) {
        showAlert('Photo size exceeds 7.5MB limit', 'warning');
        return;
      }

      // Validate file type
      if (!isImageFile(file.name)) {
        showAlert('Only JPG and PNG files are allowed for profile photos', 'warning');
        return;
      }

      setButtonLoading('uploadPhotoBtn', true);
      photoUploadProgressContainer.classList.remove('hidden');

      try {
        // Generate a unique filename
        const timestamp = new Date().getTime();
        const fileExtension = file.name.split('.').pop();
        const fileName = `profile_photo_${timestamp}.${fileExtension}`;

        // Create storage reference
        const storagePath = `profilePhotos/${userId}/${fileName}`;
        const storageRef = ref(storage, storagePath);

        // Upload file with progress tracking
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on(
          'state_changed',
          (snapshot) => {
            // Track upload progress
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            photoUploadProgressBar.style.width = progress + '%';
          },
          (error) => {
            // Handle upload error
            console.error('Error uploading photo:', error);
            showAlert('Error uploading photo: ' + error.message, 'danger');
            setButtonLoading('uploadPhotoBtn', false);
            photoUploadProgressContainer.classList.add('hidden');
          },
          async () => {
            // Upload complete
            try {
              // Get download URL
              const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

              // Update profile with photo URL
              const profileRef = doc(db, 'profiles', userId);
              await updateDoc(profileRef, {
                profilePhotoURL: downloadURL,
                profilePhotoStoragePath: storagePath
              });

              // Update UI
              profilePhotoURL.value = downloadURL;
              photoPreview.src = downloadURL;
              showAlert('Profile photo uploaded successfully', 'success');
            } catch (error) {
              console.error('Error updating profile with photo:', error);
              showAlert('Error updating profile: ' + error.message, 'danger');
            } finally {
              setButtonLoading('uploadPhotoBtn', false);
              photoUploadProgressContainer.classList.add('hidden');
            }
          }
        );
      } catch (error) {
        console.error('Error setting up photo upload:', error);
        showAlert('Error setting up photo upload: ' + error.message, 'danger');
        setButtonLoading('uploadPhotoBtn', false);
        photoUploadProgressContainer.classList.add('hidden');
      }
    });

    // Upload qualification document
    uploadQualDocBtn.addEventListener('click', async () => {
      const file = qualificationDocInput.files[0];
      if (!file) {
        showAlert('Please select a document to upload', 'warning');
        return;
      }

      // Validate file size (max 7.5MB)
      if (file.size > 7.5 * 1024 * 1024) {
        showAlert('Document size exceeds 7.5MB limit', 'warning');
        return;
      }

      // Validate file type
      const fileExt = file.name.split('.').pop().toLowerCase();
      const allowedExtensions = ['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png'];

      if (!allowedExtensions.includes(fileExt)) {
        showAlert('Only PDF, Word, JPG, and PNG files are allowed', 'warning');
        return;
      }

      setButtonLoading('uploadQualDocBtn', true);
      qualDocUploadProgressContainer.classList.remove('hidden');

      try {
        // Generate a unique filename
        const timestamp = new Date().getTime();
        const fileName = `qualification_doc_${timestamp}_${file.name}`;

        // Create storage reference
        const storagePath = `qualificationDocs/${userId}/${fileName}`;
        const storageRef = ref(storage, storagePath);

        // Upload file with progress tracking
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on(
          'state_changed',
          (snapshot) => {
            // Track upload progress
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            qualDocUploadProgressBar.style.width = progress + '%';
          },
          (error) => {
            // Handle upload error
            console.error('Error uploading document:', error);
            showAlert('Error uploading document: ' + error.message, 'danger');
            setButtonLoading('uploadQualDocBtn', false);
            qualDocUploadProgressContainer.classList.add('hidden');
          },
          async () => {
            // Upload complete
            try {
              // Get download URL
              const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

              // Update profile with document URL
              const profileRef = doc(db, 'profiles', userId);
              await updateDoc(profileRef, {
                qualificationDocURL: downloadURL,
                qualificationDocName: file.name,
                qualificationDocType: file.type,
                qualificationDocSize: file.size,
                qualificationDocStoragePath: storagePath,
                qualificationDocUploadedAt: serverTimestamp()
              });

              // Update UI
              qualificationDocURL.value = downloadURL;
              showAlert('Qualification document uploaded successfully', 'success');
              updateQualDocPreview(file.name, downloadURL, storagePath, file.type, file.size);
            } catch (error) {
              console.error('Error updating profile with document:', error);
              showAlert('Error updating profile: ' + error.message, 'danger');
            } finally {
              setButtonLoading('uploadQualDocBtn', false);
              qualDocUploadProgressContainer.classList.add('hidden');
            }
          }
        );
      } catch (error) {
        console.error('Error setting up document upload:', error);
        showAlert('Error setting up document upload: ' + error.message, 'danger');
        setButtonLoading('uploadQualDocBtn', false);
        qualDocUploadProgressContainer.classList.add('hidden');
      }
    });

    // Save profile changes
    profileForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate form
      if (!profileForm.checkValidity()) {
        profileForm.reportValidity();
        return;
      }

      // Check if agreed to terms
      const agreedToTerms = document.getElementById('agreedToTerms').checked;
      if (!agreedToTerms) {
        showAlert('User must agree to the terms before saving', 'warning');
        return;
      }
      
      const newNote = adminNotes.value.trim();
      if (!newNote) {
        showAlert('Please add a note about the changes you are making', 'warning');
        return;
      }

      setButtonLoading('saveProfileBtn', true);

      try {
        console.log('Saving profile changes');
        
        // Get current user info for the note
        const user = auth.currentUser;
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const userData = userDoc.exists() ? userDoc.data() : {};
        const adminName = `${userData.firstName || ''} ${userData.surname || ''}`.trim() || user.email || 'Unknown';

        // Get values from form
        const updatedProfile = {
          personalDetails: {
            DOB: parseDateString(document.getElementById('dob').value),
            emergencyContact: document.getElementById('emergencyContact').value
          },
          driving: {
            c1Classification: document.getElementById('c1Classification').checked,
            dlNumber: document.getElementById('dlNumber').value,
            niNumber: document.getElementById('niNumber').value,
            points: document.getElementById('points').value
          },
          medicalQualifications: {
            qualification: document.getElementById('qualification').value,
            hcpc: document.getElementById('hcpc').value,
            gmc: document.getElementById('gmc').value,
            nmc: document.getElementById('nmc').value,
            details: document.getElementById('details').value,
            certExpiry: parseDateString(document.getElementById('certExpiry').value)
          },
          submission: {
            agreedToTerms: agreedToTerms,
            submittedAt: serverTimestamp()
          }
        };

        // If profilePhotoURL is set, include it
        if (profilePhotoURL.value) {
          updatedProfile.profilePhotoURL = profilePhotoURL.value;
        }

        // If qualificationDocURL is set, include it
        if (qualificationDocURL.value) {
          updatedProfile.qualificationDocURL = qualificationDocURL.value;
        }

        console.log('Updated profile data:', updatedProfile);

        // Update profile document
        const profileRef = doc(db, 'profiles', userId);
        await updateDoc(profileRef, updatedProfile);

        // Add admin note
        await updateDoc(profileRef, {
          'adminUse.notes': arrayUnion({
            text: newNote,
            author: adminName,
            timestamp: serverTimestamp()
          })
        });

        // Update admin status
        const status = document.getElementById('profileAdminStatus').value;
        await reviewProfile(userId, status, '');

        showAlert('Profile updated successfully!', 'success');

        // Redirect back to admin profiles after short delay
        setTimeout(() => {
          window.location.href = 'admin-profiles.html';
        }, 2000);
      } catch (error) {
        console.error('Error saving profile:', error);
        showAlert('Error saving profile: ' + error.message, 'danger');
        setButtonLoading('saveProfileBtn', false);
      }
    });

    // Logout handler
    logoutLink.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        showAlert('Logout failed: ' + error.message, 'danger');
      }
    });

    // Check authentication and load profile data
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      try {
        // Check if user is admin
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists() || userDoc.data().isAdmin !== true) {
          showAlert('Unauthorized access. You must be an administrator to access this page.', 'danger');
          setTimeout(() => {
            window.location.href = 'dashboard.html';
          }, 2000);
          return;
        }

        // Load profile data
        await loadUserProfile();
      } catch (error) {
        console.error('Error checking admin status:', error);
        showAlert('Error loading user data: ' + error.message, 'danger');
      }
    });
  </script>
</body>
</html>