<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Profile - FMS Prehospital Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body { background:#f8f9fa; min-height:100vh; }
    .navbar { 
      background: linear-gradient(135deg, #00a896 0%, #028090 100%); 
      box-shadow:0 2px 10px rgba(0,0,0,0.1); 
    }
    .nav-link { color: rgba(255,255,255,.85) !important; font-weight: 500; }
    .nav-link:hover { color: #fff !important; }
    .admin-card { 
      background:#fff; 
      border-radius:15px; 
      box-shadow:0 5px 20px rgba(0,0,0,.08); 
      padding:30px; 
      margin:20px 0; 
    }
    .page-header { 
      background:linear-gradient(135deg,#00a896 0%,#028090 100%); 
      color:#fff; 
      border-radius:15px; 
      padding:30px; 
      margin:30px 0 20px 0; 
    }
    .btn-primary { 
      background: linear-gradient(135deg, #00a896 0%, #028090 100%); 
      border: none; 
      font-weight: 600; 
    }
    .btn-primary:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 5px 15px rgba(0,168,150,.4); 
    }
    .form-control:focus { 
      border-color: #00a896; 
      box-shadow: 0 0 0 0.2rem rgba(0,168,150,.25); 
    }
    .btn-loading { position: relative; pointer-events: none; opacity: .7; }
    .btn-loading::after { 
      content:""; position:absolute; width:16px; height:16px; top:50%; left:50%; 
      margin:-8px 0 0 -8px; border:2px solid #fff; border-radius:50%; 
      border-top-color:transparent; animation:spinner .6s linear infinite; 
    }
    @keyframes spinner { to { transform: rotate(360deg); } }
    .hidden { display: none; }
    .section-title {
      border-bottom: 2px solid #00a896;
      padding-bottom: 10px;
      margin-bottom: 20px;
      color: #028090;
    }
    .form-section {
      margin-bottom: 30px;
    }
    .profile-status {
      padding: 15px;
      border-radius: 10px;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-approved { background: #d1e7dd; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .form-check-input:checked {
      background-color: #00a896;
      border-color: #00a896;
    }
    .profile-notes {
      background: #f8f9fa;
      border-radius: 5px;
      padding: 15px;
      margin-top: 15px;
      font-style: italic;
      white-space: pre-line;
    }
    .user-info {
      margin-bottom: 20px;
    }
    .profile-photo {
      width: 150px;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
      border: 3px solid #00a896;
      margin: 0 auto 15px;
      display: block;
    }
    .profile-photo-placeholder {
      width: 150px;
      height: 150px;
      border-radius: 10px;
      border: 3px solid #e9ecef;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      color: #adb5bd;
      font-size: 2.5rem;
    }
    .doc-preview {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 10px;
    }
    .doc-preview-icon {
      font-size: 2rem;
      color: #00a896;
    }
    .doc-preview-info {
      flex-grow: 1;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html"><i class="bi bi-shield-lock"></i> FMS Prehospital Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="admin-profiles.html">
              <i class="bi bi-arrow-left"></i> Back to Profiles
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="admin.html">
              <i class="bi bi-gear-fill"></i> Admin Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutLink">
              <i class="bi bi-box-arrow-right"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1 class="mb-2"><i class="bi bi-pencil-square"></i> Edit Profile</h1>
      <p class="mb-0">Admin Profile Management</p>
    </div>

    <div id="alertContainer"></div>
    
    <div class="admin-card">
      <!-- User Info Section -->
      <div class="user-info" id="userInfoSection">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-3 text-muted">Loading user information...</p>
        </div>
      </div>

      <!-- Profile Form -->
      <form id="profileForm">
        <!-- Personal Details Section -->
        <div class="form-section">
          <h3 class="section-title"><i class="bi bi-person-fill"></i> Personal Details</h3>
          
          <div class="mb-3">
            <label class="form-label">Date of birth <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
              <input type="text" class="form-control" id="dob" name="dob" placeholder="DD/MM/YYYY" required>
            </div>
            <small class="form-text text-muted">Select date of birth</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Emergency contact <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-telephone"></i></span>
              <input type="text" class="form-control" id="emergencyContact" name="emergencyContact" placeholder="Name & phone number" required>
            </div>
            <small class="form-text text-muted">Provide a name and contact number</small>
          </div>
        </div>
        
        <!-- Driving Details Section -->
        <div class="form-section">
          <h3 class="section-title"><i class="bi bi-car-front-fill"></i> Driving Details</h3>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Optional, but required to drive FMS vehicles. By completing, user agrees that FMS can carry out driving licence checks.
          </div>
          
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="c1Classification" name="c1Classification">
              <label class="form-check-label" for="c1Classification">Has a C1 classification on driving licence</label>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Driving licence number</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-credit-card-2-front"></i></span>
              <input type="text" class="form-control" id="dlNumber" name="dlNumber" placeholder="e.g. SMITH601014ABCDE">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">National Insurance number</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-shield"></i></span>
              <input type="text" class="form-control" id="niNumber" name="niNumber" placeholder="e.g. AB123456C">
            </div>
            <small class="form-text text-muted">Used for driving licence checks online</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Licence points</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-exclamation-triangle"></i></span>
              <input type="text" class="form-control" id="points" name="points" placeholder="e.g. 0, 3, etc.">
            </div>
          </div>
        </div>
        
        <!-- Medical Qualifications Section -->
        <div class="form-section">
          <h3 class="section-title"><i class="bi bi-award"></i> Qualifications</h3>
          
          <div class="mb-4">
            <label class="form-label">Main qualification <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-mortarboard"></i></span>
              <select class="form-select" id="qualification" name="qualification" required>
                <option value="">Select main qualification</option>
                <option value="AAP">AAP</option>
                <option value="Doctor">Doctor</option>
                <option value="Doctor (Critical Care/BASICS/Merit)">Doctor (Critical Care/BASICS/Merit)</option>
                <option value="Doctor (with FREC/PHTLS or similar)">Doctor (with FREC/PHTLS or similar)</option>
                <option value="EAA">EAA</option>
                <option value="ECA">ECA</option>
                <option value="FREC 3 (or similar level 3 certification)">FREC 3 (or similar level 3 certification)</option>
                <option value="FREC 4">FREC 4</option>
                <option value="Nurse">Nurse</option>
                <option value="Nurse (Ambulance Nurse)">Nurse (Ambulance Nurse)</option>
                <option value="Nurse (with FREC/PHTLS or similar)">Nurse (with FREC/PHTLS or similar)</option>
                <option value="Paramedic">Paramedic</option>
                <option value="Paramedic (Critical care)">Paramedic (Critical care)</option>
                <option value="Paramedic (CTM/OO)">Paramedic (CTM/OO)</option>
                <option value="Paramedic (HART)">Paramedic (HART)</option>
                <option value="Paramedic (in Primary Care)">Paramedic (in Primary Care)</option>
                <option value="Paramedic (Specialist)">Paramedic (Specialist)</option>
                <option value="PHTLS">PHTLS</option>
                <option value="Student Paramedic (Year 2)">Student Paramedic (Year 2)</option>
                <option value="Student Paramedic (Year 3)">Student Paramedic (Year 3)</option>
                <option value="Technician">Technician</option>
              </select>
            </div>
          </div>
          
          <!-- HCPC Registration (conditional) -->
          <div class="mb-3 hidden" id="hcpcSection">
            <label class="form-label">HCPC Registration <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-card-text"></i></span>
              <input type="text" class="form-control" id="hcpc" name="hcpc" placeholder="HCPC registration number">
            </div>
          </div>
          
          <!-- GMC Registration (conditional) -->
          <div class="mb-3 hidden" id="gmcSection">
            <label class="form-label">GMC Registration <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-card-text"></i></span>
              <input type="text" class="form-control" id="gmc" name="gmc" placeholder="GMC registration number">
            </div>
          </div>
          
          <!-- NMC Registration (conditional) -->
          <div class="mb-3 hidden" id="nmcSection">
            <label class="form-label">NMC Registration <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-card-text"></i></span>
              <input type="text" class="form-control" id="nmc" name="nmc" placeholder="NMC registration number">
            </div>
          </div>
          
          <!-- Certificate Expiry (conditional) -->
          <div class="mb-3 hidden" id="certExpirySection">
            <label class="form-label">Certificate expiry date <span class="text-danger">*</span></label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
              <input type="text" class="form-control" id="certExpiry" name="certExpiry" placeholder="DD/MM/YYYY">
            </div>
          </div>
          
          <!-- Details -->
          <div class="mb-3">
            <label class="form-label">Details <span class="text-danger">*</span></label>
            <textarea class="form-control" id="details" name="details" rows="4" placeholder="Short description of day job and relevance to FMS" required></textarea>
            <small class="form-text text-muted">Brief description of current role and relevance to FMS</small>
          </div>
        </div>
      </form>
      
      <!-- Admin Notes Section -->
      <div class="form-section">
        <h3 class="section-title"><i class="bi bi-journal-text"></i> Admin Notes</h3>
        <div id="existingNotesSection">
          <!-- Existing notes will be displayed here -->
        </div>
        <div class="mt-3">
          <label class="form-label">Add New Note</label>
          <textarea class="form-control" id="adminNotes" rows="3" placeholder="Add notes about this profile"></textarea>
          <small class="form-text text-muted">New notes will be appended to the top of existing notes with timestamp.</small>
        </div>
      </div>
      
      <!-- Form Actions -->
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-secondary" id="cancelBtn">
          <i class="bi bi-arrow-left"></i> Cancel
        </button>
        <div>
          <button type="button" class="btn btn-info me-2" id="saveNoteBtn">
            <i class="bi bi-journal-plus"></i> Save Note Only
          </button>
          <button type="button" class="btn btn-primary me-2" id="saveChangesBtn">
            <i class="bi bi-save"></i> Save Changes
          </button>
          <button type="button" class="btn btn-success me-2" id="approveProfileBtn">
            <i class="bi bi-check-circle"></i> Save & Approve
          </button>
          <button type="button" class="btn btn-danger" id="rejectProfileBtn">
            <i class="bi bi-x-circle"></i> Save & Reject
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { 
      getFirestore, 
      doc, 
      getDoc, 
      updateDoc, 
      serverTimestamp 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { firebaseConfig } from './firebase-config.js';
    import { 
      getUserProfile, 
      updatePersonalDetails, 
      updateDriving, 
      updateMedicalQualifications, 
      reviewProfile 
    } from './profile-service.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    
    // DOM elements
    const profileForm = document.getElementById('profileForm');
    const userInfoSection = document.getElementById('userInfoSection');
    const existingNotesSection = document.getElementById('existingNotesSection');
    const adminNotesTextarea = document.getElementById('adminNotes');
    const qualification = document.getElementById('qualification');
    const hcpcSection = document.getElementById('hcpcSection');
    const gmcSection = document.getElementById('gmcSection');
    const nmcSection = document.getElementById('nmcSection');
    const certExpirySection = document.getElementById('certExpirySection');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveNoteBtn = document.getElementById('saveNoteBtn');
    const saveChangesBtn = document.getElementById('saveChangesBtn');
    const approveProfileBtn = document.getElementById('approveProfileBtn');
    const rejectProfileBtn = document.getElementById('rejectProfileBtn');
    const logoutLink = document.getElementById('logoutLink');
    
    // Get user ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const userId = urlParams.get('id');
    
    // Store current admin info
    let currentAdmin = null;
    
    // Store current profile data
    let currentProfile = null;
    let currentUser = null;

    // Initialize Flatpickr date pickers
    flatpickr("#dob", {
      dateFormat: "d/m/Y",
      maxDate: new Date() // Can't select future dates
    });
    
    flatpickr("#certExpiry", {
      dateFormat: "d/m/Y",
      minDate: new Date() // Can't select past dates
    });
    
// Check if this is a mobile device
const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

// Initialize date fields based on device type
if (isMobile) {
  // For mobile devices, use native date inputs
  const dobInput = document.getElementById('dob');
  const certExpiryInput = document.getElementById('certExpiry');
  
  dobInput.type = "date";
  certExpiryInput.type = "date";
  
  // Disable flatpickr for mobile
  dobInput.classList.add('native-date-input');
  certExpiryInput.classList.add('native-date-input');
} else {
  // For desktop, use flatpickr
  flatpickr("#dob", {
    dateFormat: "d/m/Y",
    maxDate: new Date() // Can't select future dates
  });
  
  flatpickr("#certExpiry", {
    dateFormat: "d/m/Y",
    minDate: new Date() // Can't select past dates
  });
}

    // Helper Functions
    function setButtonLoading(id, loading) {
      const btn = document.getElementById(id);
      if (!btn) return;
      if (loading) {
        btn.classList.add('btn-loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('btn-loading');
        btn.disabled = false;
      }
    }

    function showAlert(message, type) {
      const html = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      document.getElementById('alertContainer').innerHTML = html;
      
      if (type === 'success') {
        setTimeout(() => {
          const alert = document.querySelector('.alert');
          if (alert) {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
          }
        }, 5000);
      }
    }

    // Format date from Firestore timestamp
    function formatDate(timestamp) {
      if (!timestamp) return '';
      
      let date;
      if (timestamp.seconds) {
        // Firestore timestamp
        date = new Date(timestamp.seconds * 1000);
      } else if (timestamp.toDate) {
        // Firestore timestamp object with toDate method
        date = timestamp.toDate();
      } else if (timestamp instanceof Date) {
        // JavaScript Date object
        date = timestamp;
      } else {
        // Try to parse as string or number
        try {
          date = new Date(timestamp);
        } catch (e) {
          return '';
        }
      }
      
      if (isNaN(date.getTime())) {
        return '';
      }
      
      return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
    }
    
    // Format date for display
    function formatDisplayDate(timestamp) {
      if (!timestamp) return 'N/A';
      
      let date;
      if (timestamp.seconds) {
        // Firestore timestamp
        date = new Date(timestamp.seconds * 1000);
      } else if (timestamp.toDate) {
        // Firestore timestamp object with toDate method
        date = timestamp.toDate();
      } else if (timestamp instanceof Date) {
        // JavaScript Date object
        date = timestamp;
      } else {
        // Try to parse as string or number
        try {
          date = new Date(timestamp);
        } catch (e) {
          return 'N/A';
        }
      }
      
      if (isNaN(date.getTime())) {
        return 'N/A';
      }
      
      return date.toLocaleDateString('en-GB', {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      }) + ' ' + date.toLocaleTimeString('en-GB', { 
        hour: '2-digit', 
        minute: '2-digit'
      });
    }

    // Parse date string to Date object
    function parseDateString(dateStr) {
      if (!dateStr) return null;
      
      // Parse UK format date (DD/MM/YYYY)
      const parts = dateStr.split('/');
      if (parts.length !== 3) return null;
      
      const day = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1; // Months are 0-based
      const year = parseInt(parts[2], 10);
      
      return new Date(year, month, day);
    }
    
    // Check if file is an image
    function isImageFile(fileName) {
      if (!fileName) return false;
      const extension = fileName.split('.').pop().toLowerCase();
      return ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension);
    }

    // Get file icon based on extension
    function getFileIcon(fileName) {
      if (!fileName) return 'bi-file-earmark';
      const extension = fileName.split('.').pop().toLowerCase();
      if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension)) {
        return 'bi-file-earmark-image';
      } else if (extension === 'pdf') {
        return 'bi-file-earmark-pdf';
      } else if (['doc', 'docx'].includes(extension)) {
        return 'bi-file-earmark-word';
      } else {
        return 'bi-file-earmark';
      }
    }

    // Show/hide registration fields based on qualification
    qualification.addEventListener('change', function() {
      const value = this.value;
      
      // Reset all sections to hidden
      hcpcSection.classList.add('hidden');
      gmcSection.classList.add('hidden');
      nmcSection.classList.add('hidden');
      certExpirySection.classList.add('hidden');
      
      // Remove required attribute from all registration inputs
      document.getElementById('hcpc').removeAttribute('required');
      document.getElementById('gmc').removeAttribute('required');
      document.getElementById('nmc').removeAttribute('required');
      document.getElementById('certExpiry').removeAttribute('required');
      
      // Show appropriate sections based on qualification
      if (['Paramedic', 'Paramedic (Specialist)', 'Paramedic (HART)', 
           'Paramedic (Critical care)', 'Paramedic (in Primary Care)', 
           'Paramedic (CTM/OO)'].includes(value)) {
        hcpcSection.classList.remove('hidden');
        document.getElementById('hcpc').setAttribute('required', 'required');
      } else if (['Doctor', 'Doctor (Critical Care/BASICS/Merit)', 
                  'Doctor (with FREC/PHTLS or similar)'].includes(value)) {
        gmcSection.classList.remove('hidden');
        document.getElementById('gmc').setAttribute('required', 'required');
      } else if (['Nurse', 'Nurse (Ambulance Nurse)', 
                  'Nurse (with FREC/PHTLS or similar)'].includes(value)) {
        nmcSection.classList.remove('hidden');
        document.getElementById('nmc').setAttribute('required', 'required');
        
        if (value === 'Nurse (with FREC/PHTLS or similar)') {
          certExpirySection.classList.remove('hidden');
          document.getElementById('certExpiry').setAttribute('required', 'required');
        }
      } else if (['FREC 3 (or similar level 3 certification)', 'FREC 4', 'PHTLS'].includes(value)) {
        certExpirySection.classList.remove('hidden');
        document.getElementById('certExpiry').setAttribute('required', 'required');
      }
    });

    // Load user profile data
    async function loadUserProfile() {
      if (!userId) {
        showAlert('No user ID provided. Please go back to the profiles page.', 'danger');
        return;
      }
      
      try {
        // Get profile data
        const profile = await getUserProfile(userId);
        if (!profile) {
          showAlert('Profile not found or is empty', 'danger');
          return;
        }
        
        // Store current profile
        currentProfile = profile;
        
        // Get user data
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (userDoc.exists()) {
          currentUser = userDoc.data();
          currentUser.uid = userId;
        } else {
          showAlert('User not found', 'danger');
          return;
        }
        
        // Display user info
        displayUserInfo();
        
        // Fill form with existing data
        populateForm();
        
        // Display existing notes
        displayExistingNotes();
      } catch (error) {
        console.error('Error loading profile:', error);
        showAlert('Error loading profile: ' + error.message, 'danger');
      }
    }
    
    // Display user info section
    function displayUserInfo() {
      if (!currentUser || !currentProfile) return;
      
      const status = currentProfile.adminUse?.status || 'pending';
      
      let html = `
        <div class="row">
          <div class="col-md-3 text-center">
            ${currentProfile.profilePhotoURL ? 
              `<img src="${currentProfile.profilePhotoURL}" alt="Profile Photo" class="profile-photo">` :
              `<div class="profile-photo-placeholder"><i class="bi bi-person"></i></div>`
            }
          </div>
          <div class="col-md-9">
            <h4>${currentUser.firstName || ''} ${currentUser.surname || ''}</h4>
            <p class="text-muted mb-1"><i class="bi bi-envelope"></i> ${currentUser.email || 'No email available'}</p>
            <p class="text-muted mb-2"><i class="bi bi-telephone"></i> ${currentUser.mobile || 'No mobile provided'}</p>
            <div class="profile-status status-${status} d-inline-block px-3 py-1">
              <i class="bi bi-${status === 'pending' ? 'hourglass-split' : (status === 'approved' ? 'check-circle' : 'x-circle')}"></i> 
              ${status.charAt(0).toUpperCase() + status.slice(1)}
            </div>
          </div>
        </div>
      `;
      
      userInfoSection.innerHTML = html;
    }
    
    // Populate form with existing data
    function populateForm() {
      if (!currentProfile) return;
      
      // Personal Details
if (currentProfile.personalDetails) {
  if (currentProfile.personalDetails.DOB) {
    const dobInput = document.getElementById('dob');
    
    // Convert timestamp to date string
    let date;
    if (currentProfile.personalDetails.DOB.seconds) {
      date = new Date(currentProfile.personalDetails.DOB.seconds * 1000);
    } else {
      date = new Date(currentProfile.personalDetails.DOB);
    }
    
    // Format differently based on input type (date for mobile, text for desktop)
    if (dobInput.type === 'date') {
      // YYYY-MM-DD format for native date inputs on mobile
      const year = date.getFullYear();
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      dobInput.value = `${year}-${month}-${day}`;
    } else {
      // DD/MM/YYYY format for flatpickr on desktop
      dobInput.value = formatDate(currentProfile.personalDetails.DOB);
    }
  }
  document.getElementById('emergencyContact').value = currentProfile.personalDetails.emergencyContact || '';
}
      
      // Driving Details
      if (currentProfile.driving) {
        document.getElementById('c1Classification').checked = currentProfile.driving.c1Classification || false;
        document.getElementById('dlNumber').value = currentProfile.driving.dlNumber || '';
        document.getElementById('niNumber').value = currentProfile.driving.niNumber || '';
        document.getElementById('points').value = currentProfile.driving.points || '';
      }
      
      // Medical Qualifications
      if (currentProfile.medicalQualifications) {
        document.getElementById('qualification').value = currentProfile.medicalQualifications.qualification || '';
        document.getElementById('hcpc').value = currentProfile.medicalQualifications.hcpc || '';
        document.getElementById('gmc').value = currentProfile.medicalQualifications.gmc || '';
        document.getElementById('nmc').value = currentProfile.medicalQualifications.nmc || '';
        document.getElementById('details').value = currentProfile.medicalQualifications.details || '';
        
       if (currentProfile.medicalQualifications.certExpiry) {
  const certExpiryInput = document.getElementById('certExpiry');
  
  // Convert timestamp to date string
  let date;
  if (currentProfile.medicalQualifications.certExpiry.seconds) {
    date = new Date(currentProfile.medicalQualifications.certExpiry.seconds * 1000);
  } else {
    date = new Date(currentProfile.medicalQualifications.certExpiry);
  }
  
  // Format differently based on input type (date for mobile, text for desktop)
  if (certExpiryInput.type === 'date') {
    // YYYY-MM-DD format for native date inputs on mobile
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    certExpiryInput.value = `${year}-${month}-${day}`;
  } else {
    // DD/MM/YYYY format for flatpickr on desktop
    certExpiryInput.value = formatDate(currentProfile.medicalQualifications.certExpiry);
  }
}
        
        // Trigger change event to show/hide appropriate fields
        qualification.dispatchEvent(new Event('change'));
      }
    }
    
    // Display existing notes
    function displayExistingNotes() {
      if (!currentProfile) return;
      
      if (currentProfile.adminUse && currentProfile.adminUse.notes) {
        existingNotesSection.innerHTML = `
          <div class="profile-notes">${currentProfile.adminUse.notes}</div>
        `;
      } else {
        existingNotesSection.innerHTML = `
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No admin notes available
          </div>
        `;
      }
    }
    
    // Save profile changes
    async function saveProfileChanges() {
      try {
        // Get values from form
        const personalDetails = {
          DOB: parseDateString(document.getElementById('dob').value),
          emergencyContact: document.getElementById('emergencyContact').value
        };
        
        const driving = {
          c1Classification: document.getElementById('c1Classification').checked,
          dlNumber: document.getElementById('dlNumber').value,
          niNumber: document.getElementById('niNumber').value,
          points: document.getElementById('points').value
        };
        
        const medicalQualifications = {
          qualification: document.getElementById('qualification').value,
          hcpc: document.getElementById('hcpc').value,
          gmc: document.getElementById('gmc').value,
          nmc: document.getElementById('nmc').value,
          details: document.getElementById('details').value,
          certExpiry: parseDateString(document.getElementById('certExpiry').value)
        };
        
        // Update each section separately
        await updatePersonalDetails(personalDetails, userId);
        await updateDriving(driving, userId);
        await updateMedicalQualifications(medicalQualifications, userId);
        
        // Get updated profile
        currentProfile = await getUserProfile(userId);
        
        return true;
      } catch (error) {
        console.error('Error saving profile changes:', error);
        showAlert('Error saving profile: ' + error.message, 'danger');
        return false;
      }
    }
    
    // Save note only
    async function saveNoteOnly() {
      setButtonLoading('saveNoteBtn', true);
      
      const newNote = adminNotesTextarea.value.trim();
      if (!newNote) {
        showAlert('Please enter a note before saving', 'warning');
        setButtonLoading('saveNoteBtn', false);
        return;
      }
      
      try {
        // Get current profile
        const profileRef = doc(db, 'profiles', userId);
        const profileSnap = await getDoc(profileRef);
        
        if (!profileSnap.exists()) {
          throw new Error('Profile not found');
        }
        
        const profileData = profileSnap.data();
        const currentNotes = profileData.adminUse?.notes || '';
        
        // Format new note with timestamp and admin name
        const timestamp = new Date().toLocaleString();
        const adminName = `${currentAdmin.firstName} ${currentAdmin.surname}`;
        const formattedNote = `[${timestamp}] ${adminName}: ${newNote}\n\n${currentNotes}`;
        
        // Make sure adminUse object exists
        const adminUse = profileData.adminUse || {};
        
        // Update only the notes field
        await updateDoc(profileRef, {
          "adminUse": {
            ...adminUse,
            notes: formattedNote
          }
        });
        
        showAlert('Note saved successfully', 'success');
        adminNotesTextarea.value = '';
        
        // Update current profile and refresh notes section
        currentProfile = await getUserProfile(userId);
        displayExistingNotes();
      } catch (error) {
        console.error('Error saving note:', error);
        showAlert('Error saving note: ' + error.message, 'danger');
      } finally {
        setButtonLoading('saveNoteBtn', false);
      }
    }
    
    // Handle profile approval or rejection
    async function handleProfileAction(status) {
      const buttonId = status === 'approved' ? 'approveProfileBtn' : 'rejectProfileBtn';
      setButtonLoading(buttonId, true);
      
      try {
        // Save profile changes first
        const saved = await saveProfileChanges();
        
        if (!saved) {
          setButtonLoading(buttonId, false);
          return;
        }
        
        // Get note
        const note = adminNotesTextarea.value.trim();
        
        // Get existing notes
        let updatedNotes = currentProfile.adminUse?.notes || '';
        
        // Append new note if provided
        if (note) {
          const timestamp = new Date().toLocaleString();
          const adminName = `${currentAdmin.firstName} ${currentAdmin.surname}`;
          updatedNotes = `[${timestamp}] ${adminName}: ${note}\n\n${updatedNotes}`;
        }
        
        // Update profile status
        await reviewProfile(userId, status, updatedNotes);
        
        showAlert(`Profile ${status} successfully!`, 'success');
        
        // Redirect back to profiles page after a delay
        setTimeout(() => {
          window.location.href = 'admin-profiles.html';
        }, 1000);
      } catch (error) {
        console.error(`Error ${status} profile:`, error);
        showAlert(`Error updating profile: ${error.message}`, 'danger');
        setButtonLoading(buttonId, false);
      }
    }
    
    // Event Listeners
    cancelBtn.addEventListener('click', () => {
      window.location.href = 'admin-profiles.html';
    });
    
    saveNoteBtn.addEventListener('click', saveNoteOnly);
    
    saveChangesBtn.addEventListener('click', async () => {
      setButtonLoading('saveChangesBtn', true);
      
      try {
        // Validate form
        if (!profileForm.checkValidity()) {
          profileForm.reportValidity();
          setButtonLoading('saveChangesBtn', false);
          return;
        }
        
        // Save profile changes
        const saved = await saveProfileChanges();
        
        if (saved) {
          // Save note if provided
          const note = adminNotesTextarea.value.trim();
          
          if (note) {
            // Get existing notes
            let updatedNotes = currentProfile.adminUse?.notes || '';
            
            // Append new note
            const timestamp = new Date().toLocaleString();
            const adminName = `${currentAdmin.firstName} ${currentAdmin.surname}`;
            updatedNotes = `[${timestamp}] ${adminName}: ${note}\n\n${updatedNotes}`;
            
            // Update only the notes field
            const profileRef = doc(db, 'profiles', userId);
            const profileSnap = await getDoc(profileRef);
            
            if (profileSnap.exists()) {
              const profileData = profileSnap.data();
              const adminUse = profileData.adminUse || {};
              
              await updateDoc(profileRef, {
                "adminUse": {
                  ...adminUse,
                  notes: updatedNotes
                }
              });
              
              adminNotesTextarea.value = '';
            }
          }
          
          showAlert('Profile updated successfully!', 'success');
          
          // Update current profile and refresh notes section
          currentProfile = await getUserProfile(userId);
          displayExistingNotes();
        }
      } catch (error) {
        console.error('Error saving changes:', error);
        showAlert('Error saving changes: ' + error.message, 'danger');
      } finally {
        setButtonLoading('saveChangesBtn', false);
      }
    });
    
    approveProfileBtn.addEventListener('click', () => handleProfileAction('approved'));
    rejectProfileBtn.addEventListener('click', () => handleProfileAction('rejected'));
    
    // Logout handler
    logoutLink.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await signOut(auth);
        window.location.href = 'index.html';
      } catch (error) {
        showAlert('Logout failed: ' + error.message, 'danger');
      }
    });

    // Check authentication and load profile
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }

      try {
        // Check if user is admin
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (!userDoc.exists() || userDoc.data().isAdmin !== true) {
          window.location.href = 'dashboard.html';
          return;
        }
        
        // Store current admin info
        currentAdmin = userDoc.data();
        currentAdmin.uid = user.uid;
        
        // Load profile data
        await loadUserProfile();
      } catch (error) {
        console.error('Error checking admin status:', error);
        window.location.href = 'dashboard.html';
      }
    });
  </script>
</body>
</html>