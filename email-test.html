<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FMS Email Test Page</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      padding-top: 2rem;
      background-color: #f8f9fa;
    }
    .test-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 2rem;
      margin-bottom: 2rem;
    }
    .success-message {
      display: none;
      padding: 1rem;
      background: #d4edda;
      border-radius: 5px;
      margin-top: 1rem;
    }
    .error-message {
      display: none;
      padding: 1rem;
      background: #f8d7da;
      border-radius: 5px;
      margin-top: 1rem;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="test-card">
        <h2 class="mb-4"><i class="bi bi-envelope-check"></i> Firebase Email Test</h2>
        
        <div id="alertContainer"></div>
        
        <form id="emailTestForm">
          <div class="mb-3">
            <label for="testEmailRecipient" class="form-label">Test Email Recipient</label>
            <input type="email" class="form-control" id="testEmailRecipient" required>
            <div class="form-text">Enter your email address to receive the test message</div>
          </div>
          
          <div class="mb-3">
            <label for="testEmailSubject" class="form-label">Email Subject</label>
            <input type="text" class="form-control" id="testEmailSubject" value="FMS Portal - Test Email" required>
          </div>
          
          <div class="mb-3">
            <label for="testEmailContent" class="form-label">Email Content</label>
            <textarea class="form-control" id="testEmailContent" rows="5" required>IMPORTANT: DO NOT REPLY TO THIS MESSAGE AS IT IS NOT A MONITORED EMAIL ADDRESS

Dear Member,

This is a test email from the FMS Portal system using the Firebase Trigger Email extension.

Prehospital Team Leaders
prehospital@festival-medical.org</textarea>
          </div>
          
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary" id="sendTestEmailBtn">
              <i class="bi bi-send"></i> Send Test Email
            </button>
            <a href="admin.html" class="btn btn-secondary">
              <i class="bi bi-arrow-left"></i> Return to Admin Dashboard
            </a>
          </div>
        </form>
        
        <div class="success-message mt-4" id="successMessage">
          <h5><i class="bi bi-check-circle"></i> Test Email Sent Successfully!</h5>
          <p>The email has been sent using the Firebase Trigger Email extension. Please check the recipient's inbox (and spam folder) to verify delivery.</p>
          <p class="mb-0"><strong>Next steps:</strong> If the email was delivered successfully, you can integrate this functionality into the main application.</p>
        </div>
        
        <div class="error-message mt-4" id="errorMessage">
          <h5><i class="bi bi-exclamation-triangle"></i> Error Sending Test Email</h5>
          <p>There was a problem sending the test email. Please check the error details below:</p>
          <pre id="errorDetails" class="bg-light p-3 rounded">No error details available</pre>
          <p class="mb-0"><strong>Troubleshooting:</strong> Verify your SMTP settings in the Firebase Trigger Email extension configuration.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { 
    getFirestore, 
    collection, 
    doc,
    getDoc,
    addDoc,
    serverTimestamp 
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
  import { firebaseConfig } from './firebase-config.js';

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Helper functions
  function showAlert(message, type) {
    const html = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
    document.getElementById('alertContainer').innerHTML = html;
  }

  function setButtonLoading(loading) {
    const btn = document.getElementById('sendTestEmailBtn');
    if (loading) {
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
    } else {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-send"></i> Send Test Email';
    }
  }

  // Check if user is authenticated and admin
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      // Redirect to login page if not logged in
      window.location.href = 'index.html';
      return;
    }
    
    try {
      // Check if the user is an admin (you can remove this check for testing if needed)
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      
      if (!userDoc.exists || userDoc.data().isAdmin !== true) {
        // Redirect non-admin users
        showAlert('You must be an admin to access this page', 'danger');
        setTimeout(() => {
          window.location.href = 'dashboard.html';
        }, 3000);
      }
    } catch (error) {
      console.error('Error checking admin status:', error);
      showAlert('Error verifying permissions: ' + error.message, 'danger');
    }
  });

  // Form submission handler
  document.getElementById('emailTestForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Get form values
    const recipient = document.getElementById('testEmailRecipient').value.trim();
    const subject = document.getElementById('testEmailSubject').value.trim();
    const content = document.getElementById('testEmailContent').value.trim();
    
    // Validate
    if (!recipient || !subject || !content) {
      showAlert('Please fill in all fields', 'warning');
      return;
    }
    
    // Set loading state
    setButtonLoading(true);
    
    try {
      // Create a document in the "mail" collection to trigger the extension
      await addDoc(collection(db, 'mail'), {
        to: recipient,  // Can be a single email or array of emails
        message: {
          subject: subject,
          text: content,  // Plain text version
          html: content.replace(/\n/g, '<br>')  // HTML version
        },
        timestamp: serverTimestamp()
      });
      
      // Show success message
      document.getElementById('successMessage').style.display = 'block';
      document.getElementById('errorMessage').style.display = 'none';
      
      showAlert('Email sent successfully!', 'success');
      
    } catch (error) {
      console.error('Error sending email:', error);
      
      // Show error message
      document.getElementById('successMessage').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('errorDetails').textContent = error.message || 'Unknown error';
      
      showAlert('Error sending email: ' + error.message, 'danger');
    } finally {
      setButtonLoading(false);
    }
  });
</script>

</body>
</html>
