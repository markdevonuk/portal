<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join FMS Prehospital Team</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
  <style>
    body { 
      background: linear-gradient(135deg,#00a896 0%,#028090 100%); 
      min-height: 100vh; 
      padding: 20px; 
    }
    .application-card { 
      background:#fff; 
      border-radius:20px; 
      box-shadow:0 20px 60px rgba(0,0,0,.3); 
      overflow:hidden; 
      max-width:700px; 
      margin:0 auto; 
    }
    .application-header { 
      background: linear-gradient(135deg,#00a896 0%,#028090 100%); 
      color:#fff; 
      padding:30px; 
      text-align:center; 
    }
    .application-body { 
      padding:30px; 
    }
    .form-control:focus, .form-select:focus { 
      border-color:#00a896; 
      box-shadow:0 0 0 .2rem rgba(0,168,150,.25); 
    }
    .btn-primary { 
      background: linear-gradient(135deg,#00a896 0%,#028090 100%); 
      border:none; 
      padding:12px; 
      font-weight:600; 
    }
    .btn-primary:hover { 
      transform:translateY(-2px); 
      box-shadow:0 5px 15px rgba(0,168,150,.4); 
    }
    .btn-primary:disabled {
      transform: none;
      box-shadow: none;
      opacity: 0.7;
    }
    .alert { border-radius:10px; }
    .info-box {
      background: #e8f5f3;
      border-left: 4px solid #00a896;
      padding: 20px;
      border-radius: 0 10px 10px 0;
      margin-bottom: 25px;
    }
    .info-box.warning {
      background: #fff3e0;
      border-left-color: #ff9800;
    }
    .info-box h5 {
      color: #028090;
      margin-bottom: 15px;
    }
    .info-box.warning h5 {
      color: #e65100;
    }
    .info-box ul {
      margin-bottom: 0;
      padding-left: 20px;
    }
    .info-box li {
      margin-bottom: 8px;
    }
    .required-label::after {
      content: " *";
      color: #dc3545;
    }
    .section-divider {
      border-top: 2px solid #e9ecef;
      margin: 30px 0;
      padding-top: 20px;
    }
    .form-text {
      font-size: 0.85rem;
      color: #6c757d;
    }
    .hidden { display: none; }
    .btn-loading { 
      position:relative; 
      pointer-events:none; 
      opacity:.7; 
    }
    .btn-loading::after { 
      content:""; 
      position:absolute; 
      width:16px; 
      height:16px; 
      top:50%; 
      left:50%; 
      margin-left:-8px; 
      margin-top:-8px; 
      border:2px solid #fff; 
      border-radius:50%; 
      border-top-color:transparent; 
      animation:spinner .6s linear infinite; 
    }
    @keyframes spinner { to { transform: rotate(360deg); } }
    .progress-container {
      margin-top: 10px;
    }
    .file-info {
      font-size: 0.85rem;
      color: #6c757d;
      margin-top: 5px;
    }
    .success-card {
      text-align: center;
      padding: 40px 20px;
    }
    .success-icon {
      font-size: 5rem;
      color: #00a896;
      margin-bottom: 20px;
    }
    .back-link {
      display: inline-block;
      margin-top: 20px;
      color: #00a896;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="application-card">
      <div class="application-header">
        <h2 class="mb-0"><i class="bi bi-heart-pulse"></i> FMS Prehospital Application</h2>
        <p class="mb-0 mt-2">Join Our Medical Team</p>
      </div>

      <div class="application-body">
        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Application Form -->
        <div id="applicationFormContainer">
          <!-- Initial Information Box -->
          <div class="info-box">
            <h5><i class="bi bi-info-circle"></i> Before You Begin</h5>
            <p>Thank you for your interest in joining FMS in the pre-hospital team. In order to complete this application you will need:</p>
            <ul>
              <li><strong>(a)</strong> Proof of your qualification (ID card, certificate, etc)</li>
              <li><strong>(b)</strong> Be a UK resident and happy to complete a DBS check</li>
            </ul>
            <p class="mb-0 mt-3"><strong>Please DO NOT continue without the above.</strong></p>
          </div>

          <div class="info-box warning">
            <h5><i class="bi bi-exclamation-triangle"></i> Important Information</h5>
            <p class="mb-0">On acceptance of your application (which may take weeks as we only approve when a place becomes available), you will be required to pay a <strong>£30 fee</strong> which covers 3 years membership of the charity, your ID and DBS checks and admin required to onboard you.</p>
          </div>

          <form id="applicationForm">
            <!-- Personal Details Section -->
            <h5 class="mb-3"><i class="bi bi-person"></i> Personal Details</h5>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="firstName" class="form-label required-label">First Name</label>
                <input type="text" class="form-control" id="firstName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="surname" class="form-label required-label">Surname</label>
                <input type="text" class="form-control" id="surname" required>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label required-label">Email Address</label>
                <input type="email" class="form-control" id="email" required>
              </div>
              <div class="col-md-6 mb-3">
                <label for="mobile" class="form-label required-label">Mobile Number</label>
                <input type="tel" class="form-control" id="mobile" required>
              </div>
            </div>

            <div class="mb-3">
              <label for="address" class="form-label required-label">Full Address (including postcode)</label>
              <textarea class="form-control" id="address" rows="3" required placeholder="Enter your full address including postcode"></textarea>
            </div>

            <div class="mb-3">
              <label for="dateOfBirth" class="form-label required-label">Date of Birth</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                <input type="text" class="form-control" id="dateOfBirth" required placeholder="DD/MM/YYYY">
              </div>
              <small class="form-text text-muted">Enter your date of birth</small>
            </div>

            <!-- Volunteering Disclaimer -->
            <div class="section-divider">
              <div class="info-box">
                <h5><i class="bi bi-megaphone"></i> Please Note</h5>
                <p class="mb-0">Being a member of Festival Medical Services does not guarantee a place to volunteer at any specific event. All applications and requests to volunteer are considered on the grounds of qualifications and availability to volunteer at events throughout the season.</p>
              </div>

              <p class="form-text mb-4">
                By submitting your personal information, you give FMS permission to process, screen and store your data for the purposes of recruitment, ID and DBS checks. Your personal information cannot be submitted without your approval. Your data will not be shared with any other parties except as set out herein. By submitting this application, you hereby agree to these terms and conditions and give FMS permission to retain your data and contact details and to notify you of further internal opportunities and events. Applications that are unsuccessful will be deleted. For further information, please review our <a href="https://www.festival-medical.org" target="_blank">data protection policy</a>.
              </p>
            </div>

            <!-- Qualification Section -->
            <h5 class="mb-3"><i class="bi bi-award"></i> Qualifications</h5>

            <div class="mb-3">
              <label for="qualificationLevel" class="form-label required-label">Qualification Level</label>
              <select class="form-select" id="qualificationLevel" required>
                <option value="">-- Select your qualification --</option>
                <option value="Make Ready">Make Ready (with no clinical certification)</option>
                <option value="Medcomms">Medcomms (with no clinical certification)</option>
                <option value="Non Clinical">Non Clinical (other)</option>
                <option value="AAP">AAP</option>
                <option value="CFR">CFR</option>
                <option value="Doctor">Doctor</option>
                <option value="Doctor (Critical Care/BASICS/Merit)">Doctor (Critical Care/BASICS/Merit)</option>
                <option value="Doctor (with FREC/PHTLS or similar)">Doctor (with FREC/PHTLS or similar)</option>
                <option value="EAA">EAA</option>
                <option value="ECA">ECA</option>
                <option value="FREC 3 (or similar level 3 certification)">FREC 3 (or similar level 3 certification)</option>
                <option value="FREC 4">FREC 4</option>
                <option value="Nurse">Nurse</option>
                <option value="Nurse (Ambulance Nurse)">Nurse (Ambulance Nurse)</option>
                <option value="Nurse (with FREC/PHTLS or similar)">Nurse (with FREC/PHTLS or similar)</option>
                <option value="Paramedic">Paramedic</option>
                <option value="Paramedic (Critical care)">Paramedic (Critical care)</option>
                <option value="Paramedic (CTM/OO)">Paramedic (CTM/OO)</option>
                <option value="Paramedic (HART)">Paramedic (HART)</option>
                <option value="Paramedic (in Primary Care)">Paramedic (in Primary Care)</option>
                <option value="Paramedic (Specialist)">Paramedic (Specialist)</option>
                <option value="PHTLS">PHTLS</option>
                <option value="Student Paramedic (Year 2)">Student Paramedic (Year 2)</option>
                <option value="Student Paramedic (Year 3)">Student Paramedic (Year 3)</option>
                <option value="Technician">Technician</option>
              </select>
            </div>

            <!-- File Upload Section (hidden for Make Ready) -->
            <div class="mb-3" id="qualificationUploadSection">
              <label for="qualificationProof" class="form-label required-label">Upload Proof of Qualification</label>
              <input type="file" class="form-control" id="qualificationProof" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <div class="file-info">Please upload a screenshot of HCPC/GMC/NMC registration, your certificate or ID card.  Accepted formats: PDF, Word, JPG, PNG (Max 7.5MB)</div>
              <div class="progress-container hidden" id="uploadProgressContainer">
                <div class="progress">
                  <div class="progress-bar bg-success" id="uploadProgressBar" role="progressbar" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="uploadProgressText">Uploading...</small>
              </div>
            </div>

            <!-- DBS/Qualifications Note -->
            <div class="info-box warning mt-4">
              <h5><i class="bi bi-shield-check"></i> DBS & Qualifications</h5>
              <p class="mb-0">Please note that on successful completion of your DBS check we will ask you for full proof of qualifications including copies of certificates, ID etc. If you are unable to supply this you will not be able to volunteer for any events and your membership fee will not be refunded. <strong>Please only continue if you agree to this.</strong></p>
            </div>

            <!-- Agreement Checkbox -->
            <div class="form-check mb-4 mt-4">
              <input class="form-check-input" type="checkbox" id="agreeTerms" required>
              <label class="form-check-label" for="agreeTerms">
                I confirm that I have read and understood all the information above. I agree to the terms and conditions and give FMS permission to process my application.
              </label>
            </div>

            <!-- Submit Button -->
            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                <i class="bi bi-send"></i> Submit Application
              </button>
            </div>

            <div class="text-center mt-3">
              <a href="index.html" class="back-link"><i class="bi bi-arrow-left"></i> Back to Home</a>
            </div>
          </form>
        </div>

        <!-- Success Message (hidden by default) -->
        <div id="successContainer" class="hidden">
          <div class="success-card">
            <i class="bi bi-check-circle success-icon"></i>
            <h3>Application Submitted!</h3>
            <p class="text-muted">Thank you for your application to join the FMS Prehospital Team.</p>
            <p>We will review your application and contact you at the email address provided. Please note that this process may take several weeks as we only approve applications when places become available.</p>
            <p><strong>What happens next?</strong></p>
            <p class="text-muted">If your application is successful, you will receive an email with instructions to pay the £30 membership fee and complete the onboarding process.</p>
            <a href="index.html" class="btn btn-primary mt-3">
              <i class="bi bi-house"></i> Return to Home
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { firebaseConfig } from './firebase-config.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM Elements
    const applicationForm = document.getElementById('applicationForm');
    const qualificationLevel = document.getElementById('qualificationLevel');
    const qualificationUploadSection = document.getElementById('qualificationUploadSection');
    const qualificationProof = document.getElementById('qualificationProof');
    const uploadProgressContainer = document.getElementById('uploadProgressContainer');
    const uploadProgressBar = document.getElementById('uploadProgressBar');
    const uploadProgressText = document.getElementById('uploadProgressText');
    const submitBtn = document.getElementById('submitBtn');
    const applicationFormContainer = document.getElementById('applicationFormContainer');
    const successContainer = document.getElementById('successContainer');

    // Check if this is a mobile device
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    // Initialize date field based on device type
    if (isMobile) {
      // For mobile devices, use native date input
      document.getElementById('dateOfBirth').type = "date";
    } else {
      // For desktop, use flatpickr with manual entry allowed
      flatpickr("#dateOfBirth", {
        dateFormat: "d/m/Y",
        maxDate: new Date(),
        allowInput: true
      });
    }

    // Helper Functions
    function showAlert(message, type) {
      const html = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      document.getElementById('alertContainer').innerHTML = html;
      // Scroll to top to show alert
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function setButtonLoading(loading) {
      if (loading) {
        submitBtn.classList.add('btn-loading');
        submitBtn.disabled = true;
      } else {
        submitBtn.classList.remove('btn-loading');
        submitBtn.disabled = false;
      }
    }

// Handle qualification level change - show/hide file upload
// Non-clinical roles don't require qualification documents
const nonClinicalRoles = ['Make Ready', 'Medcomms', 'Non Clinical'];

qualificationLevel.addEventListener('change', () => {
  const selectedValue = qualificationLevel.value;
  
  if (nonClinicalRoles.includes(selectedValue)) {
    qualificationUploadSection.classList.add('hidden');
    qualificationProof.removeAttribute('required');
  } else {
    qualificationUploadSection.classList.remove('hidden');
    qualificationProof.setAttribute('required', '');
  }
});

    // Upload file to Firebase Storage
    async function uploadFile(file) {
      return new Promise((resolve, reject) => {
        // Validate file size (max 7.5MB)
        if (file.size > 7.5 * 1024 * 1024) {
          reject(new Error('File size exceeds 7.5MB limit'));
          return;
        }

        // Validate file type
        const fileExt = file.name.split('.').pop().toLowerCase();
        const allowedExtensions = ['pdf', 'doc', 'docx', 'jpg', 'jpeg', 'png'];
        if (!allowedExtensions.includes(fileExt)) {
          reject(new Error('Only PDF, Word, JPG, and PNG files are allowed'));
          return;
        }

        // Generate unique filename
        const timestamp = new Date().getTime();
        const randomString = Math.random().toString(36).substring(2, 8);
        const fileName = `qualification_${timestamp}_${randomString}_${file.name}`;
        
        // Create storage reference (in applicants folder)
        const storagePath = `applicants/qualifications/${fileName}`;
        const storageRef = ref(storage, storagePath);

        // Show progress
        uploadProgressContainer.classList.remove('hidden');

        // Upload file
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on(
          'state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            uploadProgressBar.style.width = progress + '%';
            uploadProgressText.textContent = `Uploading... ${Math.round(progress)}%`;
          },
          (error) => {
            uploadProgressContainer.classList.add('hidden');
            reject(error);
          },
          () => {
            // Upload complete - don't try to get download URL (requires auth)
            // Just save the storage path - admins can access the file later
            uploadProgressText.textContent = 'Upload complete!';
            resolve({
              path: storagePath,
              fileName: file.name
            });
          }
        );
      });
    }

    // Form submission
    applicationForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      setButtonLoading(true);

      try {
        // Get form values
        const firstName = document.getElementById('firstName').value.trim();
        const surname = document.getElementById('surname').value.trim();
        const email = document.getElementById('email').value.trim().toLowerCase();
        const mobile = document.getElementById('mobile').value.trim();
        const address = document.getElementById('address').value.trim();
        const dateOfBirth = document.getElementById('dateOfBirth').value.trim();
        const qualification = qualificationLevel.value;
        const agreeTerms = document.getElementById('agreeTerms').checked;

        // Validation
        if (!firstName || !surname || !email || !mobile || !address || !dateOfBirth || !qualification) {
          showAlert('Please fill in all required fields', 'warning');
          setButtonLoading(false);
          return;
        }

        if (!agreeTerms) {
          showAlert('Please agree to the terms and conditions', 'warning');
          setButtonLoading(false);
          return;
        }

       // Handle file upload (skip for non-clinical roles)
const nonClinicalRoles = ['Make Ready', 'Medcomms', 'Non Clinical'];
let qualificationDocument = null;
if (!nonClinicalRoles.includes(qualification)) {
          const file = qualificationProof.files[0];
          if (!file) {
            showAlert('Please upload proof of your qualification', 'warning');
            setButtonLoading(false);
            return;
          }

          try {
            qualificationDocument = await uploadFile(file);
          } catch (uploadError) {
            showAlert('Error uploading file: ' + uploadError.message, 'danger');
            setButtonLoading(false);
            return;
          }
        }

        // Create applicant record
        const applicantData = {
          firstName,
          surname,
          email,
          mobile,
          address,
          dateOfBirth,
          qualificationLevel: qualification,
          qualificationDocument,
          status: 'pending',
          submittedAt: serverTimestamp(),
          adminNotes: [],
          stripePaymentId: null,
          paidAt: null,
          externalApprovedAt: null,
          addedToApprovedListAt: null
        };

        // Save to Firestore
        await addDoc(collection(db, 'applicants'), applicantData);

        // Show success message
        applicationFormContainer.classList.add('hidden');
        successContainer.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });

      } catch (error) {
        console.error('Error submitting application:', error);
        showAlert('Error submitting application: ' + error.message, 'danger');
        setButtonLoading(false);
      }
    });
  </script>
</body>
</html>
