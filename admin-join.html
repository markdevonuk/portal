<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Applications - FMS Prehospital Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="css/styles.css" rel="stylesheet">
  <!-- Include the loader script -->
  <script src="loader.js"></script>
  <style>
    /* Additional styles for the applications management page */
    .application-card {
      border-radius: var(--border-radius-lg);
      padding: 20px;
      margin-bottom: 20px;
      background-color: var(--white);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }
    
    .application-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }
    
    .application-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .application-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--gray-800);
    }
    
    .application-date {
      font-size: 0.9rem;
      color: var(--gray-600);
    }
    
    .application-info {
      margin-bottom: 15px;
    }
    
    .info-label {
      font-weight: 500;
      color: var(--gray-700);
    }
    
    .application-actions {
      display: flex;
      gap: 10px;
    }
    
    /* Status badges */
    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-pending {
      background-color: var(--warning-bg);
      color: var(--warning);
    }
    
    .status-approved {
      background-color: var(--success-bg);
      color: var(--success);
    }
    
    .status-rejected {
      background-color: var(--danger-bg);
      color: var(--danger);
    }
    
    .payment-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .payment-paid {
      background-color: var(--success-bg);
      color: var(--success);
    }
    
    .payment-unpaid {
      background-color: var(--danger-bg);
      color: var(--danger);
    }
    
    /* Filters */
    .filter-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div id="fmsLoader"></div>
  
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="dashboard.html"><i class="bi bi-shield-lock"></i> FMS Prehospital Portal</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="admin.html">
              <i class="bi bi-speedometer2"></i> Admin Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="admin-profiles.html">
              <i class="bi bi-people-fill"></i> Member Profiles
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="dashboard.html">
              <i class="bi bi-house-fill"></i> My Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" id="logoutLink">
              <i class="bi bi-box-arrow-right"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <div class="container">
    <div class="page-header">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h1><i class="bi bi-clipboard-check"></i> Membership Applications</h1>
          <p class="lead mb-0">Review and manage team membership applications</p>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
          <div class="d-flex justify-content-md-end">
            <a href="download-applications.html" class="btn btn-light">
              <i class="bi bi-download"></i> Export CSV
            </a>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Unauthorized message (shown to non-admin users) -->
    <div id="unauthorizedMessage" class="admin-card text-center p-5 hidden">
      <i class="bi bi-shield-exclamation text-danger" style="font-size: 3rem;"></i>
      <h3 class="mt-3">Unauthorized Access</h3>
      <p>You don't have permission to access this page.</p>
      <a href="dashboard.html" class="btn btn-primary mt-3">
        <i class="bi bi-house"></i> Return to Dashboard
      </a>
    </div>
    
    <!-- Main content (visible only to admin users) -->
    <div id="adminContent">
      <!-- Filter Controls -->
      <div class="admin-card">
        <h4 class="mb-3"><i class="bi bi-funnel"></i> Filter Applications</h4>
        
        <div class="filter-controls">
          <div class="filter-control">
            <label for="statusFilter" class="form-label mb-0">Status:</label>
            <select class="form-select form-select-sm" id="statusFilter">
              <option value="all">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
          
          <div class="filter-control">
            <label for="paymentFilter" class="form-label mb-0">Payment:</label>
            <select class="form-select form-select-sm" id="paymentFilter">
              <option value="all">All Payment Statuses</option>
              <option value="paid">Paid</option>
              <option value="unpaid">Unpaid</option>
            </select>
          </div>
          
          <div class="filter-control">
            <label for="qualificationFilter" class="form-label mb-0">Qualification:</label>
            <select class="form-select form-select-sm" id="qualificationFilter">
              <option value="all">All Qualifications</option>
              <option value="Paramedic">Paramedic (All)</option>
              <option value="Doctor">Doctor (All)</option>
              <option value="Nurse">Nurse (All)</option>
              <option value="FREC">FREC (All)</option>
              <option value="Non Clinical">Non-Clinical</option>
            </select>
          </div>
          
          <div class="filter-control ms-auto">
            <div class="input-group">
              <input type="text" class="form-control form-control-sm" placeholder="Search by name or email" id="searchInput">
              <button class="btn btn-sm btn-primary" type="button" id="searchButton">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Applications List -->
      <div id="applicationsContainer">
        <!-- Loading indicator -->
        <div id="applicationsLoading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading applications...</p>
        </div>
        
        <!-- No applications message -->
        <div id="noApplicationsMessage" class="admin-card text-center p-5 hidden">
          <i class="bi bi-inbox text-secondary" style="font-size: 3rem;"></i>
          <h4 class="mt-3">No Applications Found</h4>
          <p>There are no applications matching your current filters.</p>
        </div>
        
        <!-- Applications will be inserted here dynamically -->
        <div id="applicationsList"></div>
      </div>
    </div>
  </div>
  
  <!-- Application Details Modal -->
  <div class="modal fade" id="applicationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-person-lines-fill"></i> Application Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="applicationModalBody">
          <!-- Application details will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-success" id="approveApplicationBtn">
            <i class="bi bi-check-circle"></i> Approve
          </button>
          <button type="button" class="btn btn-danger" id="rejectApplicationBtn">
            <i class="bi bi-x-circle"></i> Reject
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Initialize Firebase with your configuration
    const firebaseConfig = {
      // Your Firebase configuration will be added here
      // This is typically loaded from a config file or environment variables
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    
    // Firebase references
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // Show loader when page loads
    document.addEventListener('DOMContentLoaded', function() {
      showLoader();
      
      // Check authentication state
      auth.onAuthStateChanged(function(user) {
        if (user) {
          // User is signed in, check if they are an admin
          checkAdminAccess(user.uid);
        } else {
          // User is not signed in, redirect to login
          hideLoader();
          window.location.href = 'login.html';
        }
      });
      
      // Set up event listeners
      document.getElementById('logoutLink').addEventListener('click', function(e) {
        e.preventDefault();
        auth.signOut().then(() => {
          window.location.href = 'login.html';
        });
      });
      
      // Set up filter event listeners
      document.getElementById('statusFilter').addEventListener('change', filterApplications);
      document.getElementById('paymentFilter').addEventListener('change', filterApplications);
      document.getElementById('qualificationFilter').addEventListener('change', filterApplications);
      document.getElementById('searchButton').addEventListener('click', filterApplications);
      document.getElementById('searchInput').addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          filterApplications();
        }
      });
      
      // Modal action buttons
      document.getElementById('approveApplicationBtn').addEventListener('click', function() {
        updateApplicationStatus('approved');
      });
      
      document.getElementById('rejectApplicationBtn').addEventListener('click', function() {
        updateApplicationStatus('rejected');
      });
    });
    
    // Check if user has admin access
    function checkAdminAccess(userId) {
      db.collection('users').doc(userId).get()
        .then((doc) => {
          if (doc.exists && doc.data().isAdmin) {
            // User is an admin, load applications
            document.getElementById('adminContent').classList.remove('hidden');
            loadApplications();
          } else {
            // User is not an admin, show unauthorized message
            document.getElementById('unauthorizedMessage').classList.remove('hidden');
            document.getElementById('adminContent').classList.add('hidden');
          }
          hideLoader();
        })
        .catch((error) => {
          console.error('Error checking admin access:', error);
          hideLoader();
          // Show error message
          alert('Error checking permissions. Please try again later.');
        });
    }
    
    // Load applications from Firestore
    function loadApplications() {
      document.getElementById('applicationsLoading').classList.remove('hidden');
      document.getElementById('applicationsList').innerHTML = '';
      document.getElementById('noApplicationsMessage').classList.add('hidden');
      
      // Get applications from Firestore
      db.collection('applications')
        .orderBy('applicationDate', 'desc')
        .get()
        .then((querySnapshot) => {
          document.getElementById('applicationsLoading').classList.add('hidden');
          
          if (querySnapshot.empty) {
            document.getElementById('noApplicationsMessage').classList.remove('hidden');
          } else {
            // Store applications in a global variable for filtering
            window.allApplications = [];
            
            querySnapshot.forEach((doc) => {
              const application = doc.data();
              application.id = doc.id;
              window.allApplications.push(application);
            });
            
            // Display applications
            displayApplications(window.allApplications);
          }
        })
        .catch((error) => {
          console.error('Error loading applications:', error);
          document.getElementById('applicationsLoading').classList.add('hidden');
          alert('Error loading applications. Please try again later.');
        });
    }
    
    // Display applications in the UI
    function displayApplications(applications) {
      const container = document.getElementById('applicationsList');
      container.innerHTML = '';
      
      if (applications.length === 0) {
        document.getElementById('noApplicationsMessage').classList.remove('hidden');
        return;
      }
      
      document.getElementById('noApplicationsMessage').classList.add('hidden');
      
      applications.forEach((application) => {
        const card = createApplicationCard(application);
        container.appendChild(card);
      });
    }
    
    // Create an application card element
    function createApplicationCard(application) {
      const card = document.createElement('div');
      card.className = 'application-card';
      card.setAttribute('data-id', application.id);
      
      // Format date
      const applicationDate = application.applicationDate.toDate 
        ? application.applicationDate.toDate() 
        : new Date(application.applicationDate);
      const formattedDate = applicationDate.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
      
      // Status badge class
      let statusClass = 'status-pending';
      if (application.status === 'approved') statusClass = 'status-approved';
      if (application.status === 'rejected') statusClass = 'status-rejected';
      
      // Payment badge class
      const paymentClass = application.paymentStatus === 'paid' ? 'payment-paid' : 'payment-unpaid';
      
      card.innerHTML = `
        <div class="application-header">
          <div>
            <div class="application-name">${application.firstName} ${application.surname}</div>
            <div class="application-date">Applied: ${formattedDate}</div>
          </div>
          <div class="d-flex gap-2">
            <span class="status-badge ${statusClass}">${application.status.charAt(0).toUpperCase() + application.status.slice(1)}</span>
            <span class="payment-badge ${paymentClass}">${application.paymentStatus === 'paid' ? 'Paid' : 'Unpaid'}</span>
          </div>
        </div>
        
        <div class="application-info">
          <div class="row">
            <div class="col-md-6">
              <div><span class="info-label">Email:</span> ${application.email}</div>
              <div><span class="info-label">Phone:</span> ${application.mobile}</div>
            </div>
            <div class="col-md-6">
              <div><span class="info-label">Qualification:</span> ${application.qualification}</div>
              <div><span class="info-label">Gift Aid:</span> ${application.giftAid ? 'Yes' : 'No'}</div>
            </div>
          </div>
        </div>
        
        <div class="application-actions">
          <button class="btn btn-sm btn-primary view-application" data-id="${application.id}">
            <i class="bi bi-eye"></i> View Details
          </button>
        </div>
      `;
      
      // Add event listener to view button
      card.querySelector('.view-application').addEventListener('click', function() {
        openApplicationModal(application);
      });
      
      return card;
    }
    
    // Open application details modal
    function openApplicationModal(application) {
      // Store current application ID in the modal
      document.getElementById('applicationModal').setAttribute('data-application-id', application.id);
      
      // Format date
      const applicationDate = application.applicationDate.toDate 
        ? application.applicationDate.toDate() 
        : new Date(application.applicationDate);
      const formattedDate = applicationDate.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
      });
      
      // Format DOB if exists
      let formattedDob = 'Not provided';
      if (application.dob) {
        const dob = new Date(application.dob);
        formattedDob = dob.toLocaleDateString('en-GB', {
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
      }
      
      // Build modal content
      const modalContent = `
        <div class="mb-4">
          <h4 class="mb-3">${application.firstName} ${application.surname}</h4>
          <div class="row">
            <div class="col-md-6 mb-2">
              <span class="info-label">Application Date:</span> ${formattedDate}
            </div>
            <div class="col-md-6 mb-2">
              <span class="info-label">Status:</span> 
              <span class="status-badge status-${application.status}">${application.status.charAt(0).toUpperCase() + application.status.slice(1)}</span>
            </div>
          </div>
        </div>
        
        <h5 class="mb-3 border-bottom pb-2">Personal Information</h5>
        <div class="row mb-4">
          <div class="col-md-6 mb-2">
            <span class="info-label">Date of Birth:</span> ${formattedDob}
          </div>
          <div class="col-md-6 mb-2">
            <span class="info-label">Email:</span> ${application.email}
          </div>
          <div class="col-md-6 mb-2">
            <span class="info-label">Phone:</span> ${application.mobile}
          </div>
          <div class="col-12 mb-2">
            <span class="info-label">Address:</span> 
            <div class="mt-1">${application.address.replace(/\n/g, '<br>')}</div>
          </div>
        </div>
        
        <h5 class="mb-3 border-bottom pb-2">Professional Details</h5>
        <div class="row mb-4">
          <div class="col-md-6 mb-2">
            <span class="info-label">Qualification:</span> ${application.qualification}
          </div>
        </div>
        
        <h5 class="mb-3 border-bottom pb-2">Payment Information</h5>
        <div class="row mb-4">
          <div class="col-md-6 mb-2">
            <span class="info-label">Payment Status:</span> 
            <span class="payment-badge ${application.paymentStatus === 'paid' ? 'payment-paid' : 'payment-unpaid'}">
              ${application.paymentStatus === 'paid' ? 'Paid' : 'Unpaid'}
            </span>
          </div>
          <div class="col-md-6 mb-2">
            <span class="info-label">Gift Aid:</span> ${application.giftAid ? 'Yes' : 'No'}
          </div>
        </div>
      `;
      
      // Update modal content
      document.getElementById('applicationModalBody').innerHTML = modalContent;
      
      // Show/hide action buttons based on application status
      if (application.status === 'pending') {
        document.getElementById('approveApplicationBtn').style.display = 'block';
        document.getElementById('rejectApplicationBtn').style.display = 'block';
      } else {
        document.getElementById('approveApplicationBtn').style.display = 'none';
        document.getElementById('rejectApplicationBtn').style.display = 'none';
      }
      
      // Open the modal
      const modalElement = document.getElementById('applicationModal');
      const modal = new bootstrap.Modal(modalElement);
      modal.show();
    }
    
    // Update application status
    function updateApplicationStatus(status) {
      const modalElement = document.getElementById('applicationModal');
      const applicationId = modalElement.getAttribute('data-application-id');
      
      if (!applicationId) return;
      
      // Show a confirmation dialog
      if (!confirm(`Are you sure you want to ${status} this application?`)) {
        return;
      }
      
      // Update status in Firestore
      db.collection('applications').doc(applicationId).update({
        status: status,
        statusUpdateDate: new Date(),
        statusUpdatedBy: auth.currentUser.uid
      })
      .then(() => {
        // Close the modal
        const modal = bootstrap.Modal.getInstance(modalElement);
        modal.hide();
        
        // Refresh applications list
        loadApplications();
        
        // Show success message
        alert(`Application ${status} successfully.`);
      })
      .catch((error) => {
        console.error('Error updating application status:', error);
        alert('Error updating application status. Please try again later.');
      });
    }
    
    // Filter applications based on selected criteria
    function filterApplications() {
      const statusFilter = document.getElementById('statusFilter').value;
      const paymentFilter = document.getElementById('paymentFilter').value;
      const qualificationFilter = document.getElementById('qualificationFilter').value;
      const searchQuery = document.getElementById('searchInput').value.toLowerCase().trim();
      
      // Make sure we have loaded applications
      if (!window.allApplications) return;
      
      // Apply filters
      let filteredApplications = window.allApplications.filter(application => {
        // Status filter
        if (statusFilter !== 'all' && application.status !== statusFilter) {
          return false;
        }
        
        // Payment filter
        if (paymentFilter !== 'all' && application.paymentStatus !== paymentFilter) {
          return false;
        }
        
        // Qualification filter
        if (qualificationFilter !== 'all') {
          if (qualificationFilter === 'Paramedic' && !application.qualification.includes('Paramedic')) {
            return false;
          } else if (qualificationFilter === 'Doctor' && !application.qualification.includes('Doctor')) {
            return false;
          } else if (qualificationFilter === 'Nurse' && !application.qualification.includes('Nurse')) {
            return false;
          } else if (qualificationFilter === 'FREC' && !application.qualification.includes('FREC')) {
            return false;
          } else if (qualificationFilter === 'Non Clinical' && !application.qualification.includes('Non Clinical')) {
            return false;
          }
        }
        
        // Search query
        if (searchQuery) {
          const fullName = `${application.firstName} ${application.surname}`.toLowerCase();
          if (!fullName.includes(searchQuery) && !application.email.toLowerCase().includes(searchQuery)) {
            return false;
          }
        }
        
        return true;
      });
      
      // Display filtered applications
      displayApplications(filteredApplications);
    }
    
    // Show/hide loader functions
    function showLoader() {
      const loader = document.getElementById('fmsLoader');
      if (loader) loader.classList.remove('fms-loader-hide');
    }
    
    function hideLoader() {
      const loader = document.getElementById('fmsLoader');
      if (loader) {
        loader.classList.add('fms-loader-hide');
        // Remove loader after transition
        setTimeout(() => {
          loader.style.display = 'none';
        }, 500);
      }
    }
  </script>
</body>
</html>