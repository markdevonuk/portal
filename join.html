<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Join Prehospital Team - FMS Prehospital Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="css/styles.css" rel="stylesheet">
  <!-- Add Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body { 
      background: linear-gradient(135deg,#00a896 0%,#028090 100%); 
      min-height: 100vh; 
      padding: 20px 0; 
    }
    .application-card { 
      background: #fff; 
      border-radius: 20px; 
      box-shadow: 0 20px 60px rgba(0,0,0,.3); 
      max-width: 800px; 
      margin: 30px auto; 
      padding: 0;
      overflow: hidden;
    }
    .application-header { 
      background: linear-gradient(135deg,#00a896 0%,#028090 100%); 
      color: #fff; 
      padding: 30px; 
      text-align: center; 
    }
    .application-body { 
      padding: 30px; 
    }
    .form-section {
      margin-bottom: 30px;
    }
    .section-title {
      border-bottom: 2px solid var(--primary);
      padding-bottom: 10px;
      margin-bottom: 20px;
      color: var(--secondary);
    }
    .form-explanation {
      background-color: var(--light-bg);
      border-radius: var(--border-radius-md);
      padding: 15px;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }
    .gift-aid-section {
      background-color: var(--gray-100);
      border-radius: var(--border-radius-md);
      padding: 20px;
      margin-top: 20px;
      border-left: 3px solid var(--primary);
    }
    /* Hide the payment section initially */
    #paymentSection {
      display: none;
    }
    /* Loading button styles */
    .btn-loading { 
      position: relative; 
      pointer-events: none; 
      opacity: .7; 
    }
    .btn-loading::after { 
      content:""; 
      position:absolute; 
      width:16px; 
      height:16px; 
      top:50%; 
      left:50%; 
      margin:-8px 0 0 -8px; 
      border:2px solid #fff; 
      border-radius:50%; 
      border-top-color:transparent; 
      animation:spinner .6s linear infinite; 
    }
    @keyframes spinner { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="container">
    <!-- Alert Container for messages -->
    <div id="alertContainer" class="mt-3"></div>
    
    <div class="application-card">
      <div class="application-header">
        <h1><i class="bi bi-shield-plus"></i> Join FMS Prehospital</h1>
        <p class="lead mb-0">Apply to join our prehospital team</p>
      </div>
      
      <div class="application-body">
        <div id="applicationForm">
          <!-- Personal Information Section -->
          <div class="form-section">
            <h3 class="section-title"><i class="bi bi-person-fill"></i> Personal Information</h3>
            
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">First Name <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person"></i></span>
                  <input type="text" class="form-control" id="firstName" required>
                </div>
              </div>
              
              <div class="col-md-6 mb-3">
                <label class="form-label">Surname <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-person"></i></span>
                  <input type="text" class="form-control" id="surname" required>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-calendar3"></i></span>
                <input type="text" class="form-control" id="dob" placeholder="YYYY-MM-DD" required>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Email Address <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                <input type="email" class="form-control" id="email" required>
              </div>
              <small class="form-text text-muted">We'll use this email for all communications</small>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Mobile Number <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-phone"></i></span>
                <input type="tel" class="form-control" id="mobile" required>
              </div>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Postal Address (inc. postcode) <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-house"></i></span>
                <textarea class="form-control" id="address" rows="3" required></textarea>
              </div>
            </div>
          </div>
          
          <!-- Professional Qualification Section -->
          <div class="form-section">
            <h3 class="section-title"><i class="bi bi-award"></i> Professional Qualification</h3>
            
            <div class="form-explanation">
              <p><strong>Please select only the exact grade you are; do not pick what you believe to be the closest.</strong> If you are in any doubt please contact prehospital@festival-medical.org and we can help clarify which option to select. If you choose a grade you later cannot evidence, we reserve the right to refuse membership, and no refund will be given on your membership fee.</p>
            </div>
            
            <div class="mb-4">
              <label class="form-label">Grade/Qualification <span class="text-danger">*</span></label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-mortarboard"></i></span>
                <select class="form-select" id="qualification" required>
                  <option value="">Select your qualification</option>
                  <option value="Make Ready">Make Ready (with no clinical certification)</option>
                  <option value="Medcomms">Medcomms (with no clinical certification)</option>
                  <option value="Non Clinical">Non Clinical (other)</option>
                  <option value="AAP">AAP</option>
                  <option value="Doctor">Doctor</option>
                  <option value="Doctor (Critical Care/BASICS/Merit)">Doctor (Critical Care/BASICS/Merit)</option>
                  <option value="Doctor (with FREC/PHTLS or similar)">Doctor (with FREC/PHTLS or similar)</option>
                  <option value="EAA">EAA</option>
                  <option value="ECA">ECA</option>
                  <option value="FREC 3 (or similar level 3 certification)">FREC 3 (or similar level 3 certification)</option>
                  <option value="FREC 4">FREC 4</option>
                  <option value="Nurse">Nurse</option>
                  <option value="Nurse (Ambulance Nurse)">Nurse (Ambulance Nurse)</option>
                  <option value="Nurse (with FREC/PHTLS or similar)">Nurse (with FREC/PHTLS or similar)</option>
                  <option value="Paramedic">Paramedic</option>
                  <option value="Paramedic (Critical care)">Paramedic (Critical care)</option>
                  <option value="Paramedic (CTM/OO)">Paramedic (CTM/OO)</option>
                  <option value="Paramedic (HART)">Paramedic (HART)</option>
                  <option value="Paramedic (in Primary Care)">Paramedic (in Primary Care)</option>
                  <option value="Paramedic (Specialist)">Paramedic (Specialist)</option>
                  <option value="PHTLS">PHTLS</option>
                  <option value="Student Paramedic (Year 2)">Student Paramedic (Year 2)</option>
                  <option value="Student Paramedic (Year 3)">Student Paramedic (Year 3)</option>
                  <option value="Technician">Technician</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Gift Aid Section -->
          <div class="form-section gift-aid-section">
            <h3 class="section-title"><i class="bi bi-heart"></i> Gift Aid Declaration</h3>
            
            <p>Gift aid raises more funds for the FMS charity without costing you a penny more. If you are a UK taxpayer we can reclaim the tax on your membership subscriptions. All we need is for you to indicate Yes below.</p>
            
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="giftAidCheck">
              <label class="form-check-label" for="giftAidCheck">
                I am happy for FMS to reclaim the tax on any eligible donations or membership subscriptions that I make until further notice. I confirm that I pay at least as much UK income or capital gains tax as will be reclaimed by all charities on my donations in each tax year.
              </label>
            </div>
          </div>
          
          <!-- Payment Information -->
          <div class="form-section">
            <h3 class="section-title"><i class="bi bi-credit-card"></i> Membership Fee</h3>
            
            <div class="alert alert-info">
              <p class="mb-0"><strong>Membership Fee:</strong> Â£30.00 for 3 years</p>
            </div>
            
            <p>After submitting your application, you'll be directed to our secure payment page to complete your membership payment.</p>
          </div>
          
          <!-- Submit Button -->
          <div class="text-center">
            <button type="button" id="submitApplication" class="btn btn-primary btn-lg">
              <i class="bi bi-check-circle"></i> Submit Application & Pay
            </button>
          </div>
        </div>
        
        <!-- Confirmation Message (shown after payment) -->
        <div id="confirmationMessage" style="display: none;">
          <div class="text-center">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
            <h3 class="mt-4">Application Completed!</h3>
            <p>Thank you for your application and payment. We will review your application and be in touch shortly.</p>
            <div class="mt-4">
              <a href="index.html" class="btn btn-primary">
                <i class="bi bi-house-fill"></i> Return to Home
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      addDoc,
      doc,
      updateDoc,
      serverTimestamp 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
    import { firebaseConfig } from './firebase-config.js';
    
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Initialize Stripe
    const stripe = Stripe('pk_test_51OrkpvAKACGnEqN4A3Nn1F1uXbEq0kzoCw6uRGZ6Mz6AvY0oDdJcvmZpuEQBV8S3JfT2jSAXbOjzRFLwX1l0QEVg00kLB8PCUZ'); // Replace with your publishable key
    
    // DOM Elements
    const submitApplicationBtn = document.getElementById('submitApplication');
    const applicationForm = document.getElementById('applicationForm');
    const confirmationMessage = document.getElementById('confirmationMessage');
    const alertContainer = document.getElementById('alertContainer');
    
    // Check URL parameters for success or canceled status
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize date picker for DOB field
      flatpickr("#dob", {
        dateFormat: "Y-m-d",
        maxDate: "today",
        altInput: true,
        altFormat: "F j, Y",
        allowInput: true
      });
      
      // Check URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const isSuccess = urlParams.get('success');
      const isCanceled = urlParams.get('canceled');
      const applicationId = urlParams.get('application_id');
      
      if (isSuccess === 'true' && applicationId) {
        // Show success message
        applicationForm.style.display = 'none';
        confirmationMessage.style.display = 'block';
        
        // Update Firebase payment status
        updatePaymentStatus(applicationId);
        
        // Scroll to top
        window.scrollTo(0, 0);
      } else if (isCanceled === 'true') {
        // Show canceled message
        showAlert('Your payment was canceled. You can try again when you\'re ready.', 'warning');
      }
      
      // Form submission handler
      submitApplicationBtn.addEventListener('click', async function() {
        if (validateForm()) {
          await saveApplicationAndCheckout();
        }
      });
    });
    
    // Form validation function
    function validateForm() {
      // Get all required fields
      const requiredFields = document.querySelectorAll('[required]');
      let isValid = true;
      
      // Check each required field
      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          field.classList.add('is-invalid');
          isValid = false;
        } else {
          field.classList.remove('is-invalid');
        }
      });
      
      // Validate email format
      const emailField = document.getElementById('email');
      if (emailField.value && !isValidEmail(emailField.value)) {
        emailField.classList.add('is-invalid');
        isValid = false;
      }
      
      if (!isValid) {
        showAlert('Please fill in all required fields correctly.', 'danger');
      }
      
      return isValid;
    }
    
    // Validate email format
    function isValidEmail(email) {
      const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return regex.test(email);
    }
    
    // Save application to Firebase and redirect to checkout
    async function saveApplicationAndCheckout() {
      // Show loading state
      setButtonLoading(submitApplicationBtn, true);
      
      try {
        // Get form values
        const applicationData = {
          firstName: document.getElementById('firstName').value.trim(),
          surname: document.getElementById('surname').value.trim(),
          dob: document.getElementById('dob').value.trim(),
          email: document.getElementById('email').value.trim().toLowerCase(),
          mobile: document.getElementById('mobile').value.trim(),
          address: document.getElementById('address').value.trim(),
          qualification: document.getElementById('qualification').value,
          giftAid: document.getElementById('giftAidCheck').checked,
          applicationDate: serverTimestamp(),
          status: 'pending',
          paymentStatus: 'unpaid'
        };
        
        // Add the application to Firestore
        const docRef = await addDoc(collection(db, 'applications'), applicationData);
        console.log('Application saved with ID: ', docRef.id);
        
        // Create Stripe Checkout Session
        redirectToCheckout(docRef.id);
      } catch (error) {
        console.error('Error saving application: ', error);
        showAlert('There was an error submitting your application: ' + error.message, 'danger');
        setButtonLoading(submitApplicationBtn, false);
      }
    }
    
    // Redirect to Stripe Checkout
    async function redirectToCheckout(applicationId) {
      try {
        // Call your serverless function or backend API to create a checkout session
        const response = await fetch('https://us-central1-fmsportal-dbfb3.cloudfunctions.net/createCheckoutSession', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            applicationId: applicationId,
            successUrl: `${window.location.origin}/join-team.html?success=true&application_id=${applicationId}`,
            cancelUrl: `${window.location.origin}/join-team.html?canceled=true`
          }),
        });
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        // Redirect to Stripe Checkout
        const result = await stripe.redirectToCheckout({
          sessionId: data.sessionId
        });
        
        if (result.error) {
          throw new Error(result.error.message);
        }
      } catch (error) {
        console.error('Error creating checkout session:', error);
        showAlert('There was an error processing your payment: ' + error.message, 'danger');
        setButtonLoading(submitApplicationBtn, false);
      }
    }
    
    // Update payment status in Firebase
    async function updatePaymentStatus(applicationId) {
      try {
        await updateDoc(doc(db, 'applications', applicationId), {
          paymentStatus: 'paid',
          paymentDate: serverTimestamp()
        });
        console.log('Payment status updated successfully');
      } catch (error) {
        console.error('Error updating payment status:', error);
      }
    }
    
    // Helper function to show loading state on buttons
    function setButtonLoading(button, isLoading) {
      if (isLoading) {
        button.disabled = true;
        button.classList.add('btn-loading');
        button.innerHTML = '';
      } else {
        button.disabled = false;
        button.classList.remove('btn-loading');
        button.innerHTML = '<i class="bi bi-check-circle"></i> Submit Application & Pay';
      }
    }
    
    // Helper function to show alerts
    function showAlert(message, type) {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show`;
      alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      // Add to alert container
      alertContainer.innerHTML = '';
      alertContainer.appendChild(alert);
      
      // Auto dismiss after 5 seconds
      setTimeout(() => {
        if (alert.parentNode) {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
        }
      }, 5000);
    }
  </script>
</body>
</html>